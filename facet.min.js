/*
 * Facet: An EDSL for WebGL graphics
 * By Carlos Scheidegger, cscheid@research.att.com
 * 
 * Copyright (c) 2011 AT&T Intellectual Property
 * 
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors: See github logs.
 *
 */// Facet depends on the following software libraries:
////////////////////////////////////////////////////////////////////////////////
// BEGIN UNDERSCORE.JS NOTICE
// 
// Underscore.js 1.1.7
// (c) 2011 Jeremy Ashkenas, DocumentCloud Inc.
// Underscore is freely distributable under the MIT license.
// Portions of Underscore are inspired or borrowed from Prototype,
// Oliver Steele's Functional, and John Resig's Micro-Templating.
// For all details and documentation:
// http://documentcloud.github.com/underscore
//
// END UNDERSCORE.JS NOTICE
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// BEGIN WEBGL-DEBUG.JS NOTICE
// https://cvs.khronos.org/svn/repos/registry/trunk/public/webgl/sdk/debug/webgl-debug.js
//
// Copyright (c) 2009 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.
//
// END WEBGL-DEBUG.JS NOTICE
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// BEGIN WEBGL-UTILS.JS NOTICE
// https://cvs.khronos.org/svn/repos/registry/trunk/public/webgl/sdk/demos/common/webgl-utils.js
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */// END WEBGL-UTILS.JS NOTICE
////////////////////////////////////////////////////////////////////////////////
/*

  Facet is a library for making WebGL marginally
  less painful to program, featuring things like nicer support for
  fragment and vertex programs, webgl buffers, textures, etc.

 */function latlong_to_mercator(a,b){a=a/(180/Math.PI),b=b/(180/Math.PI);return[b,Math.log(1/Math.cos(a)+Math.tan(a))]}function spherical_mercator_patch(a){var b=[],c=[];for(var d=0;d<=a;++d)for(var e=0;e<=a;++e)b.push(d/a,e/a);for(d=0;d<a;++d)for(var e=0;e<a;++e){var f=(a+1)*d+e;c.push(f,f+1,f+a+2,f,f+a+2,f+a+1)}return Facet.model({type:"triangles",uv:[b,2],elements:c,vertex:function(a,b){var c=this.uv.mul(b.sub(a)).add(a);return Facet.Scale.Geo.mercator_to_spherical(c.at(0),c.at(1))},transformed_uv:function(a,b){return Shade.mix(a,b,this.uv).div(Math.PI*2).add(Shade.vec(0,.5))}})}function typeOf(a){var b=typeof a;b==="object"&&(a?typeof a.length=="number"&&!a.propertyIsEnumerable("length")&&typeof a.splice=="function"&&(b="array"):b="null");return b}function constant_type(a){var b=typeof a;if(b==="boolean")return"boolean";if(b==="number")return"number";if(a){b=a._type;if(!b)return"other"}return b}Facet={},Facet._globals={ctx:undefined,display_callback:undefined},function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=d.slice,g=d.unshift,h=e.toString,i=e.hasOwnProperty,j=d.forEach,k=d.map,l=d.reduce,m=d.reduceRight,n=d.filter,o=d.every,p=d.some,q=d.indexOf,r=d.lastIndexOf;e=Array.isArray;var s=Object.keys,t=Function.prototype.bind,u=function(a){return new z(a)};typeof module!="undefined"&&module.exports?(module.exports=u,u._=u):a._=u,u.VERSION="1.1.7";var v=u.each=u.forEach=function(a,b,d){if(a!=null)if(j&&a.forEach===j)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;e<f;e++)if(e in a&&b.call(d,a[e],e,a)===c)break}else for(e in a)if(i.call(a,e)&&b.call(d,a[e],e,a)===c)break};u.map=function(a,b,c){var d=[];if(a==null)return d;if(k&&a.map===k)return a.map(b,c);v(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)});return d},u.reduce=u.foldl=u.inject=function(a,b,c,d){var e=c!==void 0;a==null&&(a=[]);if(l&&a.reduce===l)return d&&(b=u.bind(b,d)),e?a.reduce(b,c):a.reduce(b);v(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c},u.reduceRight=u.foldr=function(a,b,c,d){a==null&&(a=[]);if(m&&a.reduceRight===m)return d&&(b=u.bind(b,d)),c!==void 0?a.reduceRight(b,c):a.reduceRight(b);a=(u.isArray(a)?a.slice():u.toArray(a)).reverse();return u.reduce(a,b,c,d)},u.find=u.detect=function(a,b,c){var d;w(a,function(a,e,f){if(b.call(c,a,e,f))return d=a,!0});return d},u.filter=u.select=function(a,b,c){var d=[];if(a==null)return d;if(n&&a.filter===n)return a.filter(b,c);v(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)});return d},u.reject=function(a,b,c){var d=[];if(a==null)return d;v(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)});return d},u.every=u.all=function(a,b,d){var e=!0;if(a==null)return e;if(o&&a.every===o)return a.every(b,d);v(a,function(a,f,g){if(!(e=e&&b.call(d,a,f,g)))return c});return e};var w=u.some=u.any=function(a,b,d){b=b||u.identity;var e=!1;if(a==null)return e;if(p&&a.some===p)return a.some(b,d);v(a,function(a,f,g){if(e|=b.call(d,a,f,g))return c});return!!e};u.include=u.contains=function(a,b){var c=!1;if(a==null)return c;if(q&&a.indexOf===q)return a.indexOf(b)!=-1;w(a,function(a){if(c=a===b)return!0});return c},u.invoke=function(a,b){var c=f.call(arguments,2);return u.map(a,function(a){return(b.call?b||a:a[b]).apply(a,c)})},u.pluck=function(a,b){return u.map(a,function(a){return a[b]})},u.max=function(a,b,c){if(!b&&u.isArray(a))return Math.max.apply(Math,a);var d={computed:-Infinity};v(a,function(a,e,f){e=b?b.call(c,a,e,f):a,e>=d.computed&&(d={value:a,computed:e})});return d.value},u.min=function(a,b,c){if(!b&&u.isArray(a))return Math.min.apply(Math,a);var d={computed:Infinity};v(a,function(a,e,f){e=b?b.call(c,a,e,f):a,e<d.computed&&(d={value:a,computed:e})});return d.value},u.sortBy=function(a,b,c){return u.pluck(u.map(a,function(a,d,e){return{value:a,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0}),"value")},u.groupBy=function(a,b){var c={};v(a,function(a,d){var e=b(a,d);(c[e]||(c[e]=[])).push(a)});return c},u.sortedIndex=function(a,b,c){c||(c=u.identity);for(var d=0,e=a.length;d<e;){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d},u.toArray=function(a){return a?a.toArray?a.toArray():u.isArray(a)?f.call(a):u.isArguments(a)?f.call(a):u.values(a):[]},u.size=function(a){return u.toArray(a).length},u.first=u.head=function(a,b,c){return b!=null&&!c?f.call(a,0,b):a[0]},u.rest=u.tail=function(a,b,c){return f.call(a,b==null||c?1:b)},u.last=function(a){return a[a.length-1]},u.compact=function(a){return u.filter(a,function(a){return!!a})},u.flatten=function(a){return u.reduce(a,function(a,b){if(u.isArray(b))return a.concat(u.flatten(b));a[a.length]=b;return a},[])},u.without=function(a){return u.difference(a,f.call(arguments,1))},u.uniq=u.unique=function(a,b){return u.reduce(a,function(a,c,d){if(0==d||(b===!0?u.last(a)!=c:!u.include(a,c)))a[a.length]=c;return a},[])},u.union=function(){return u.uniq(u.flatten(arguments))},u.intersection=u.intersect=function(a){var b=f.call(arguments,1);return u.filter(u.uniq(a),function(a){return u.every(b,function(b){return u.indexOf(b,a)>=0})})},u.difference=function(a,b){return u.filter(a,function(a){return!u.include(b,a)})},u.zip=function(){for(var a=f.call(arguments),b=u.max(u.pluck(a,"length")),c=Array(b),d=0;d<b;d++)c[d]=u.pluck(a,""+d);return c},u.indexOf=function(a,b,c){if(a==null)return-1;var d;if(c)return c=u.sortedIndex(a,b),a[c]===b?c:-1;if(q&&a.indexOf===q)return a.indexOf(b);c=0;for(d=a.length;c<d;c++)if(a[c]===b)return c;return-1},u.lastIndexOf=function(a,b){if(a==null)return-1;if(r&&a.lastIndexOf===r)return a.lastIndexOf(b);for(var c=a.length;c--;)if(a[c]===b)return c;return-1},u.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=Array(d);e<d;)f[e++]=a,a+=c;return f},u.bind=function(a,b){if(a.bind===t&&t)return t.apply(a,f.call(arguments,1));var c=f.call(arguments,2);return function(){return a.apply(b,c.concat(f.call(arguments)))}},u.bindAll=function(a){var b=f.call(arguments,1);b.length==0&&(b=u.functions(a)),v(b,function(b){a[b]=u.bind(a[b],a)});return a},u.memoize=function(a,b){var c={};b||(b=u.identity);return function(){var d=b.apply(this,arguments);return i.call(c,d)?c[d]:c[d]=a.apply(this,arguments)}},u.delay=function(a,b){var c=f.call(arguments,2);return setTimeout(function(){return a.apply(a,c)},b)},u.defer=function(a){return u.delay.apply(u,[a,1].concat(f.call(arguments,1)))};var x=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,a.apply(e,f)};c&&clearTimeout(d);if(c||!d)d=setTimeout(g,b)}};u.throttle=function(a,b){return x(a,b,!1)},u.debounce=function(a,b){return x(a,b,!0)},u.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}},u.wrap=function(a,b){return function(){var c=[a].concat(f.call(arguments));return b.apply(this,c)}},u.compose=function(){var a=f.call(arguments);return function(){for(var b=f.call(arguments),c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},u.after=function(a,b){return function(){if(--a<1)return b.apply(this,arguments)}},u.keys=s||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],c;for(c in a)i.call(a,c)&&(b[b.length]=c);return b},u.values=function(a){return u.map(a,u.identity)},u.functions=u.methods=function(a){var b=[],c;for(c in a)u.isFunction(a[c])&&b.push(c);return b.sort()},u.extend=function(a){v(f.call(arguments,1),function(b){for(var c in b)b[c]!==void 0&&(a[c]=b[c])});return a},u.defaults=function(a){v(f.call(arguments,1),function(b){for(var c in b)a[c]==null&&(a[c]=b[c])});return a},u.clone=function(a){return u.isArray(a)?a.slice():u.extend({},a)},u.tap=function(a,b){b(a);return a},u.isEqual=function(a,b){if(a===b)return!0;var c=typeof a;if(c!=typeof b)return!1;if(a==b)return!0;if(!a&&b||a&&!b)return!1;a._chain&&(a=a._wrapped),b._chain&&(b=b._wrapped);if(a.isEqual)return a.isEqual(b);if(b.isEqual)return b.isEqual(a);if(u.isDate(a)&&u.isDate(b))return a.getTime()===b.getTime();if(u.isNaN(a)&&u.isNaN(b))return!1;if(u.isRegExp(a)&&u.isRegExp(b))return a.source===b.source&&a.global===b.global&&a.ignoreCase===b.ignoreCase&&a.multiline===b.multiline;if(c!=="object")return!1;if(a.length&&a.length!==b.length)return!1;c=u.keys(a);var d=u.keys(b);if(c.length!=d.length)return!1;for(var e in a)if(!(e in b)||!u.isEqual(a[e],b[e]))return!1;return!0},u.isEmpty=function(a){if(u.isArray(a)||u.isString(a))return a.length===0;for(var b in a)if(i.call(a,b))return!1;return!0},u.isElement=function(a){return!!a&&a.nodeType==1},u.isArray=e||function(a){return h.call(a)==="[object Array]"},u.isObject=function(a){return a===Object(a)},u.isArguments=function(a){return!!a&&!!i.call(a,"callee")},u.isFunction=function(a){return!(!a||!a.constructor||!a.call||!a.apply)},u.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},u.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)},u.isNaN=function(a){return a!==a},u.isBoolean=function(a){return a===!0||a===!1},u.isDate=function(a){return!(!a||!a.getTimezoneOffset||!a.setUTCFullYear)},u.isRegExp=function(a){return!(!a||!a.test||!a.exec||!a.ignoreCase&&a.ignoreCase!==!1)},u.isNull=function(a){return a===null},u.isUndefined=function(a){return a===void 0},u.noConflict=function(){a._=b;return this},u.identity=function(a){return a},u.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)},u.mixin=function(a){v(u.functions(a),function(b){B(b,u[b]=a[b])})};var y=0;u.uniqueId=function(a){var b=y++;return a?a+b:b},u.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},u.template=function(a,b){var c=u.templateSettings;c="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(c.interpolate,function(a,b){return"',"+b.replace(/\\'/g,"'")+",'"}).replace(c.evaluate||null,function(a,b){return"');"+b.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",c=new Function("obj",c);return b?c(b):c};var z=function(a){this._wrapped=a};u.prototype=z.prototype;var A=function(a,b){return b?u(a).chain():a},B=function(a,b){z.prototype[a]=function(){var a=f.call(arguments);g.call(a,this._wrapped);return A(b.apply(u,a),this._chain)}};u.mixin(u),v(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];z.prototype[a]=function(){b.apply(this._wrapped,arguments);return A(this._wrapped,this._chain)}}),v(["concat","join","slice"],function(a){var b=d[a];z.prototype[a]=function(){return A(b.apply(this._wrapped,arguments),this._chain)}}),z.prototype.chain=function(){this._chain=!0;return this},z.prototype.value=function(){return this._wrapped}}(),WebGLDebugUtils=function(){function k(a){function x(a){return typeof a=="function"?a:function(b){a.handleEvent(b)}}function r(){for(var b=0;b<f.length;++b){var c=f[b];c instanceof WebGLBuffer?a.deleteBuffer(c):c instanceof WebctxFramebuffer?a.deleteFramebuffer(c):c instanceof WebctxProgram?a.deleteProgram(c):c instanceof WebctxRenderbuffer?a.deleteRenderbuffer(c):c instanceof WebctxShader?a.deleteShader(c):c instanceof WebctxTexture&&a.deleteTexture(c)}}function q(a){return{statusMessage:a}}function o(a,b){var c=a[b];return function(){if(!d){if(!m(arguments)){k[a.INVALID_OPERATION]=!0;return}var b=c.apply(a,arguments);return b}}}function n(){var a=Object.keys(k);for(var b=0;b<a.length;++b)delete glErrorShdow_[a]}function m(a){for(var b=0;b<a.length;++b){var d=a[b];if(l(d))return d.__webglDebugContextLostId__==c}return!0}function l(a){return a instanceof WebGLBuffer||a instanceof WebGLFramebuffer||a instanceof WebGLProgram||a instanceof WebGLRenderbuffer||a instanceof WebGLShader||a instanceof WebGLTexture}var b={},c=1,d=!1,e=0,f=[],g=undefined,h=undefined,i=undefined,k={};for(var p in a)typeof a[p]=="function"?b[p]=o(a,p):b[p]=a[p];b.loseContext=function(){if(!d){d=!0,++c;while(a.getError());n(),k[a.CONTEXT_LOST_WEBGL]=!0,setTimeout(function(){g&&g(q("context lost"))},0)}},b.restoreContext=function(){if(d)if(h)setTimeout(function(){r(),j(a),d=!1;if(h){var b=h;h=i,i=undefined,b(q("context restored"))}},0);else throw"You can not restore the context without a listener"},b.getError=function(){if(!d){var b;while(b=a.getError())k[b]=!0}for(var b in k)if(k[b]){delete k[b];return b}return a.NO_ERROR};var s=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"];for(var t=0;t<s.length;++t){var u=s[t];b[u]=function(b){return function(){if(d)return null;var e=b.apply(a,arguments);e.__webglDebugContextLostId__=c,f.push(e);return e}}(a[u])}var v=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(var t=0;t<v.length;++t){var u=v[t];b[u]=function(b){return function(){return d?null:b.apply(a,arguments)}}(b[u])}var w=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(var t=0;t<w.length;++t){var u=w[t];b[u]=function(b){return function(){return d?!1:b.apply(a,arguments)}}(b[u])}b.checkFramebufferStatus=function(b){return function(){return d?a.FRAMEBUFFER_UNSUPPORTED:b.apply(a,arguments)}}(b.checkFramebufferStatus),b.getAttribLocation=function(b){return function(){return d?-1:b.apply(a,arguments)}}(b.getAttribLocation),b.getVertexAttribOffset=function(b){return function(){return d?0:b.apply(a,arguments)}}(b.getVertexAttribOffset),b.isContextLost=function(){return d},b.registerOnContextLostListener=function(a){g=x(a)},b.registerOnContextRestoredListener=function(a){d?i=x(a):h=x(a)};return b}function j(a){var b=a.getParameter(a.MAX_VERTEX_ATTRIBS),c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);for(var d=0;d<b;++d)a.disableVertexAttribArray(d),a.vertexAttribPointer(d,4,a.FLOAT,!1,0,0),a.vertexAttrib1f(d,0);a.deleteBuffer(c);var e=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);for(var d=0;d<e;++d)a.activeTexture(a.TEXTURE0+d),a.bindTexture(a.TEXTURE_CUBE_MAP,null),a.bindTexture(a.TEXTURE_2D,null);a.activeTexture(a.TEXTURE0),a.useProgram(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.disable(a.BLEND),a.disable(a.CULL_FACE),a.disable(a.DEPTH_TEST),a.disable(a.DITHER),a.disable(a.SCISSOR_TEST),a.blendColor(0,0,0,0),a.blendEquation(a.FUNC_ADD),a.blendFunc(a.ONE,a.ZERO),a.clearColor(0,0,0,0),a.clearDepth(1),a.clearStencil(-1),a.colorMask(!0,!0,!0,!0),a.cullFace(a.BACK),a.depthFunc(a.LESS),a.depthMask(!0),a.depthRange(0,1),a.frontFace(a.CCW),a.hint(a.GENERATE_MIPMAP_HINT,a.DONT_CARE),a.lineWidth(1),a.pixelStorei(a.PACK_ALIGNMENT,4),a.pixelStorei(a.UNPACK_ALIGNMENT,4),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.UNPACK_COLORSPACE_CONVERSION_WEBGL&&a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.BROWSER_DEFAULT_WEBGL),a.polygonOffset(0,0),a.sampleCoverage(1,!1),a.scissor(0,0,a.canvas.width,a.canvas.height),a.stencilFunc(a.ALWAYS,0,4294967295),a.stencilMask(4294967295),a.stencilOp(a.KEEP,a.KEEP,a.KEEP),a.viewport(0,0,a.canvas.clientWidth,a.canvas.clientHeight),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT);while(a.getError());}function i(b,c){function f(a,b){return function(){var d=a[b].apply(a,arguments),f=a.getError();f!=0&&(e[f]=!0,c(f,b,arguments));return d}}d(b),c=c||function(b,c,d){var e="";for(var f=0;f<d.length;++f)e+=(f==0?"":", ")+h(c,f,d[f]);a("WebGL error "+g(b)+" in "+c+"("+e+")")};var e={},i={};for(var j in b)typeof b[j]=="function"?i[j]=f(b,j):i[j]=b[j];i.getError=function(){for(var a in e)if(e[a]){e[a]=!1;return a}return b.NO_ERROR};return i}function h(a,c,d){var e=b[a];if(e!==undefined&&e[c])return g(d);return d.toString()}function g(a){e();var b=c[a];return b!==undefined?b:"*UNKNOWN WebGL ENUM (0x"+a.toString(16)+")"}function f(a){e();return c[a]!==undefined}function e(){if(c==null)throw"WebGLDebugUtils.init(ctx) not called"}function d(a){if(c==null){c={};for(var b in a)typeof a[b]=="number"&&(c[a[b]]=b)}}var a=function(a){window.console&&window.console.log&&window.console.log(a)},b={enable:{0:!0},disable:{0:!0},getParameter:{0:!0},drawArrays:{0:!0},drawElements:{0:!0,2:!0},createShader:{0:!0},getShaderParameter:{1:!0},getProgramParameter:{1:!0},getVertexAttrib:{1:!0},vertexAttribPointer:{2:!0},bindTexture:{0:!0},activeTexture:{0:!0},getTexParameter:{0:!0,1:!0},texParameterf:{0:!0,1:!0},texParameteri:{0:!0,1:!0,2:!0},texImage2D:{0:!0,2:!0,6:!0,7:!0},texSubImage2D:{0:!0,6:!0,7:!0},copyTexImage2D:{0:!0,2:!0},copyTexSubImage2D:{0:!0},generateMipmap:{0:!0},bindBuffer:{0:!0},bufferData:{0:!0,2:!0},bufferSubData:{0:!0},getBufferParameter:{0:!0,1:!0},pixelStorei:{0:!0,1:!0},readPixels:{4:!0,5:!0},bindRenderbuffer:{0:!0},bindFramebuffer:{0:!0},checkFramebufferStatus:{0:!0},framebufferRenderbuffer:{0:!0,1:!0,2:!0},framebufferTexture2D:{0:!0,1:!0,2:!0},getFramebufferAttachmentParameter:{0:!0,1:!0,2:!0},getRenderbufferParameter:{0:!0,1:!0},renderbufferStorage:{0:!0,1:!0},clear:{0:!0},depthFunc:{0:!0},blendFunc:{0:!0,1:!0},blendFuncSeparate:{0:!0,1:!0,2:!0,3:!0},blendEquation:{0:!0},blendEquationSeparate:{0:!0,1:!0},stencilFunc:{0:!0},stencilFuncSeparate:{0:!0,1:!0},stencilMaskSeparate:{0:!0},stencilOp:{0:!0,1:!0,2:!0},stencilOpSeparate:{0:!0,1:!0,2:!0,3:!0},cullFace:{0:!0},frontFace:{0:!0}},c=null;return{init:d,mightBeEnum:f,glEnumToString:g,glFunctionArgToString:h,makeDebugContext:i,makeLostContextSimulatingContext:k,resetToInitialState:j}}(),WebGLUtils=function(){var a=function(a){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+a+"</div>"+"</div>"+"</td></tr></table>"},b='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',c='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',d=function(d,f){function g(b){var c=d.parentNode;c&&(c.innerHTML=a(b))}if(!window.WebGLRenderingContext){g(b);return null}var h=e(d,f);h||g(c);return h},e=function(a,b){var c=["webgl","experimental-webgl","webkit-3d","moz-webgl"],d=null;for(var e=0;e<c.length;++e){try{d=a.getContext(c[e],b)}catch(f){}if(d)break}return d};return{create3DContext:e,setupWebGL:d}}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}(),_.mixin({build:function(a){var b={};_.each(a,function(a){b[a[0]]=a[1]});return b}});var vec={},mat={};vec.eps=1e-6,mat.eps=1e-6;var vec2={};vec2.create=function(){var a=new Float32Array(2);a._type="vector";return a},vec2.copy=function(a){var b=new Float32Array(2);b._type="vector",b[0]=a[0],b[1]=a[1];return b},vec2.make=vec2.copy,vec2.equal=function(a,b){return Math.abs(a[0]-b[0])<vec.eps&&Math.abs(a[1]-b[1])<vec.eps},vec2.random=function(){var a=vec2.make([Math.random(),Math.random()]);return a},vec2.set=function(a,b){a[0]=b[0],a[1]=b[1];return a},vec2.plus=function(a,b){var c=new Float32Array(2);c._type="vector",c[0]=a[0]+b[0],c[1]=a[1]+b[1];return c},vec2.add=function(a,b){a[0]+=b[0],a[1]+=b[1];return a},vec2.minus=function(a,b){var c=new Float32Array(2);c._type="vector",c[0]=a[0]-b[0],c[1]=a[1]-b[1];return c},vec2.subtract=function(a,b){a[0]-=b[0],a[1]-=b[1];return a},vec2.negative=function(a){var b=new Float32Array(2);b._type="vector",b[0]=-a[0],b[1]=-a[1];return b},vec2.negate=function(a){a[0]=-a[0],a[1]=-a[1];return a},vec2.scaling=function(a,b){var c=new Float32Array(2);c._type="vector",c[0]=a[0]*b,c[1]=a[1]*b;return c},vec2.scale=function(a,b){a[0]*=b,a[1]*=b;return a},vec2.schur_product=function(a,b){var c=new Float32Array(2);c._type="vector",c[0]=a[0]*b[0],c[1]=a[1]*b[1];return c},vec2.schur_multiply=function(a,b){a[0]*=b[0],a[1]*=b[1];return a},vec2.normalized=function(a){var b=new Float32Array(2);b._type="vector";var c=a[0],d=a[1],e=Math.sqrt(c*c+d*d);if(!e)return b;if(e==1){b[0]=c,b[1]=d;return b}b[0]=c/e,b[1]=d/e;return b},vec2.normalize=function(a){var b=a[0],c=a[1],d=Math.sqrt(b*b+c*c);if(!d){a[0]=a[1]=0;return a}a[0]/=d,a[1]/=d;return a},vec2.length=function(a){var b=a[0],c=a[1];return Math.sqrt(b*b+c*c)},vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]},vec2.map=function(a,b){return vec2.make(_.map(a,b))},vec2.str=function(a){return"["+a[0]+", "+a[1]+"]"};var vec3={};vec3.create=function(){var a=new Float32Array(3);a._type="vector";return a},vec3.copy=function(a){var b=new Float32Array(3);b._type="vector",b[0]=a[0],b[1]=a[1],b[2]=a[2];return b},vec3.make=vec3.copy,vec3.equal=function(a,b){return Math.abs(a[0]-b[0])<vec.eps&&Math.abs(a[1]-b[1])<vec.eps&&Math.abs(a[2]-b[2])<vec.eps},vec3.random=function(){var a=vec3.make([Math.random(),Math.random(),Math.random()]);return a},vec3.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2];return a},vec3.plus=function(a,b){var c=new Float32Array(3);c._type="vector",c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2];return c},vec3.add=function(a,b){a[0]+=b[0],a[1]+=b[1],a[2]+=b[2];return a},vec3.minus=function(a,b){var c=new Float32Array(3);c._type="vector",c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2];return c},vec3.subtract=function(a,b){a[0]-=b[0],a[1]-=b[1],a[2]-=b[2];return a},vec3.negative=function(a){var b=new Float32Array(3);b._type="vector",b[0]=-a[0],b[1]=-a[1],b[2]=-a[2];return b},vec3.negate=function(a){a[0]=-a[0],a[1]=-a[1],a[2]=-a[2];return a},vec3.scaling=function(a,b){var c=new Float32Array(3);c._type="vector",c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b;return c},vec3.scale=function(a,b){a[0]*=b,a[1]*=b,a[2]*=b;return a},vec3.schur_product=function(a,b){var c=new Float32Array(3);c._type="vector",c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2];return c},vec3.schur_multiply=function(a,b){a[0]*=b[0],a[1]*=b[1],a[2]*=b[2];return a},vec3.normalized=function(a){var b=new Float32Array(3);b._type="vector";var c=a[0],d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);if(!f)return b;if(f==1){b[0]=c,b[1]=d,b[2]=e;return b}b[0]=c/f,b[1]=d/f,b[2]=e/f;return b},vec3.normalize=function(a){var b=a[0],c=a[1],d=a[2],e=Math.sqrt(b*b+c*c+d*d);if(!e){a[0]=a[1]=a[2]=0;return a}a[0]/=e,a[1]/=e,a[2]/=e;return a},vec3.cross=function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2],i=new Float32Array(3);i._type="vector",i[0]=d*h-e*g,i[1]=e*f-c*h,i[2]=c*g-d*f;return i},vec3.length=function(a){var b=a[0],c=a[1],d=a[2];return Math.sqrt(b*b+c*c+d*d)},vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},vec3.map=function(a,b){return vec3.make(_.map(a,b))},vec3.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};var vec4={};vec4.create=function(){var a=new Float32Array(4);a._type="vector";return a},vec4.copy=function(a){var b=new Float32Array(4);b._type="vector",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3];return b},vec4.make=vec4.copy,vec4.random=function(){var a=[Math.random(),Math.random(),Math.random(),Math.random()];return vec4.make(a)},vec4.equal=function(a,b){return Math.abs(a[0]-b[0])<vec.eps&&Math.abs(a[1]-b[1])<vec.eps&&Math.abs(a[2]-b[2])<vec.eps&&Math.abs(a[3]-b[3])<vec.eps},vec4.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3];return a},vec4.plus=function(a,b){var c=new Float32Array(4);c._type="vector",c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3];return c},vec4.add=function(a,b){a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=b[3];return a},vec4.minus=function(a,b){var c=new Float32Array(4);c._type="vector",c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3];return c},vec4.subtract=function(a,b){a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a[3]-=b[3];return a},vec4.negative=function(a){var b=new Float32Array(4);b._type="vector",b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3];return b},vec4.negate=function(a){a[0]=-a[0],a[1]=-a[1],a[2]=-a[2],a[3]=-a[3];return a},vec4.scaling=function(a,b){var c=new Float32Array(4);c._type="vector",c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b;return c},vec4.scale=function(a,b){a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b;return a},vec4.schur_product=function(a,b){var c=new Float32Array(4);c._type="vector",c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3];return c},vec4.schur_multiply=function(a,b){a[0]*=b[0],a[1]*=b[1],a[2]*=b[2],a[3]*=b[3];return a},vec4.normalized=function(a){var b=new Float32Array(4);b._type="vector";var c=a[0],d=a[1],e=a[2],f=a[3],g=Math.sqrt(c*c+d*d+e*e+f*f);if(!g)return b;if(g==1){b[0]=c,b[1]=d,b[2]=e,b[3]=f;return b}b[0]=c/g,b[1]=d/g,b[2]=e/g,b[3]=f/g;return b},vec4.normalize=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=Math.sqrt(b*b+c*c+d*d+e*e);if(!f){a[0]=a[1]=a[2]=a[3]=0;return a}a[0]/=f,a[1]/=f,a[2]/=f,a[3]/=f;return a},vec4.length=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return Math.sqrt(b*b+c*c+d*d+e*e)},vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},vec4.map=function(a,b){return vec4.make(_.map(a,b))},vec4.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var mat2={};mat2.create=function(){var a=new Float32Array(4);a._type="matrix";return a},mat2.copy=function(a){var b=new Float32Array(4);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3];return b},mat2.make=mat2.copy,mat2.equal=function(a,b){return Math.abs(a[0]-b[0])<mat.eps&&Math.abs(a[1]-b[1])<mat.eps&&Math.abs(a[2]-b[2])<mat.eps&&Math.abs(a[3]-b[3])<mat.eps},mat2.random=function(){var a=new Float32Array(4);a._type="matrix",a[0]=Math.random(),a[1]=Math.random(),a[2]=Math.random(),a[3]=Math.random();return a},mat2.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3];return a},function(){var a=new Float32Array([1,0,0,1]);mat2.identity=function(){var b=new Float32Array(a);b._type="matrix";return b},mat2.set_identity=function(b){mat2.set(b,a);return b}}(),mat2.transpose=function(a){var b=new Float32Array(4);b._type="matrix",b[0]=a[0],b[1]=a[2],b[2]=a[1],b[3]=a[3];return b},mat2.set_transpose=function(a,b){if(b==a){var c=b[1];a[1]=b[2],a[2]=c;return a}a[0]=b[0],a[1]=b[2],a[2]=b[1],a[3]=b[3];return a},mat2.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},mat2.inverse=function(a){var b=new Float32Array(4);b._type="matrix";var c=a[0],d=a[1],e=a[2],f=a[3],g=c*f-d*e;if(g===0)throw"Singular matrix";b[0]=f/g,b[1]=-d/g,b[2]=-e/g,b[3]=c/g;return b},mat2.invert=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=b*e-c*d;if(f===0)throw"Singular matrix";a[0]=e/f,a[1]=-c/f,a[2]=-d/f,a[3]=b/f;return a},mat2.as_mat4=function(a){var b=new Float32Array(16);b._type="matrix",b[0]=a[0],b[1]=a[1],b[4]=a[2],b[5]=a[3];return b},mat2.as_mat3=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[1],b[3]=a[2],b[4]=a[3];return b},mat2.product=function(a,b){var c=new Float32Array(4);c._type="matrix";var d=a[0],e=a[1],f=a[2],g=a[3],h=b[0],i=b[1],j=b[2],k=b[3];c[0]=h*d+i*f,c[1]=h*e+i*g,c[2]=j*d+k*f,c[3]=j*e+k*g;return c},mat2.multiply=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3];a[0]=g*c+h*e,a[1]=g*d+h*f,a[2]=i*c+j*e,a[3]=i*d+j*f;return a},mat2.product_vec=function(a,b){var c=new Float32Array(3);c._type="vector";var d=b[0],e=b[1];c[0]=a[0]*d+a[2]*e,c[1]=a[1]*d+a[3]*e;return c},mat2.multiply_vec=function(a,b){var c=b[0],d=b[1];b[0]=a[0]*c+a[2]*d,b[1]=a[1]*c+a[3]*d;return b},mat2.frobenius_norm=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},mat2.map=function(a,b){return mat2.make(_.map(a,b))},mat2.str=function(a){return"[ ["+a[0]+"] ["+a[2]+"] ]\n"+"[ ["+a[1]+"] ["+a[3]+"] ]"};var mat3={};mat3.create=function(){var a=new Float32Array(9);a._type="matrix";return a},mat3.copy=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8];return b},mat3.make=mat3.copy,mat3.equal=function(a,b){return Math.abs(a[0]-b[0])<mat.eps&&Math.abs(a[1]-b[1])<mat.eps&&Math.abs(a[2]-b[2])<mat.eps&&Math.abs(a[3]-b[3])<mat.eps&&Math.abs(a[4]-b[4])<mat.eps&&Math.abs(a[5]-b[5])<mat.eps&&Math.abs(a[6]-b[6])<mat.eps&&Math.abs(a[7]-b[7])<mat.eps&&Math.abs(a[8]-b[8])<mat.eps},mat3.random=function(){var a=new Float32Array(9);a._type="matrix",a[0]=Math.random(),a[1]=Math.random(),a[2]=Math.random(),a[3]=Math.random(),a[4]=Math.random(),a[5]=Math.random(),a[6]=Math.random(),a[7]=Math.random(),a[8]=Math.random();return a},mat3.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8];return a},function(){var a=new Float32Array([1,0,0,0,1,0,0,0,1]);mat3.identity=function(){var b=new Float32Array(a);b._type="matrix";return b},mat3.set_identity=function(b){mat3.set(b,a);return b}}(),mat3.transpose=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[3],b[2]=a[6],b[3]=a[1],b[4]=a[4],b[5]=a[7],b[6]=a[2],b[7]=a[5],b[8
]=a[8];return b},mat3.set_transpose=function(a,b){if(b==a){var c=b[1],d=b[2],e=b[5];a[1]=b[3],a[2]=b[6],a[3]=c,a[5]=b[7],a[6]=d,a[7]=e;return a}a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8];return a},mat3.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8];return b*f*j+c*g*h+d*e*i-d*f*h-c*e*j-b*g*i},mat3.inverse=function(a){var b=new Float32Array(9);b._type="matrix";var c=a[0],d=a[3],e=a[6],f=a[1],g=a[4],h=a[7],i=a[2],j=a[5],k=a[8],l=c*g*k+d*h*i+e*f*j-e*g*i-d*f*k-c*h*j;if(l===0)throw"Singular matrix";b[0]=(g*k-h*j)/l,b[1]=(-f*k+h*i)/l,b[2]=(f*j-g*i)/l,b[3]=(-d*k+e*j)/l,b[4]=(c*k-e*i)/l,b[5]=(-c*j+d*i)/l,b[6]=(d*h-e*g)/l,b[7]=(-c*h+e*f)/l,b[8]=(c*g-d*f)/l;return b},mat3.invert=function(a){var b=a[0],c=a[3],d=a[6],e=a[1],f=a[4],g=a[7],h=a[2],i=a[5],j=a[8],k=b*f*j+c*g*h+d*e*i-d*f*h-c*e*j-b*g*i;if(k===0)throw"Singular matrix";a[0]=(f*j-g*i)/k,a[1]=(-e*j+g*h)/k,a[2]=(e*i-f*h)/k,a[3]=(-c*j+d*i)/k,a[4]=(b*j-d*h)/k,a[5]=(-b*i+c*h)/k,a[6]=(c*g-d*f)/k,a[7]=(-b*g+d*e)/k,a[8]=(b*f-c*e)/k;return a},mat3.as_mat4=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[4]=a[3],b[5]=a[4],b[6]=a[5],b[8]=a[6],b[9]=a[7],b[10]=a[8];return b},mat3.as_mat2=function(a){var b=new Float32Array(4);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[3],b[3]=a[4];return b},mat3.product=function(a,b){var c=new Float32Array(9);c._type="matrix";var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=b[0],n=b[1],o=b[2],p=b[3],q=b[4],r=b[5],s=b[6],t=b[7],u=b[8];c[0]=m*d+n*g+o*j,c[1]=m*e+n*h+o*k,c[2]=m*f+n*i+o*l,c[3]=p*d+q*g+r*j,c[4]=p*e+q*h+r*k,c[5]=p*f+q*i+r*l,c[6]=s*d+t*g+u*j,c[7]=s*e+t*h+u*k,c[8]=s*f+t*i+u*l;return c},mat3.multiply=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=b[0],m=b[1],n=b[2],o=b[3],p=b[4],q=b[5],r=b[6],s=b[7],t=b[8];a[0]=l*c+m*f+n*i,a[1]=l*d+m*g+n*j,a[2]=l*e+m*h+n*k,a[3]=o*c+p*f+q*i,a[4]=o*d+p*g+q*j,a[5]=o*e+p*h+q*k,a[6]=r*c+s*f+t*i,a[7]=r*d+s*g+t*j,a[8]=r*e+s*h+t*k;return a},mat3.product_vec=function(a,b){var c=new Float32Array(3);c._type="vector";var d=b[0],e=b[1],f=b[2];c[0]=a[0]*d+a[3]*e+a[6]*f,c[1]=a[1]*d+a[4]*e+a[7]*f,c[2]=a[2]*d+a[5]*e+a[8]*f;return c},mat3.multiply_vec=function(a,b){var c=b[0],d=b[1],e=b[2];b[0]=a[0]*c+a[3]*d+a[6]*e,b[1]=a[1]*c+a[4]*d+a[7]*e,b[2]=a[2]*c+a[5]*d+a[8]*e;return b},mat3.frobenius_norm=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]+a[4]*a[4]+a[5]*a[5]+a[6]*a[6]+a[7]*a[7]+a[8]*a[8])},mat3.map=function(a,b){return mat3.make(_.map(a,b))},mat3.str=function(a){return"[ ["+a[0]+"] ["+a[3]+"] ["+a[6]+"] ]\n"+"[ ["+a[1]+"] ["+a[4]+"] ["+a[7]+"] ]\n"+"[ ["+a[2]+"] ["+a[5]+"] ["+a[8]+"] ]"};var mat4={};mat4.create=function(a){var b=new Float32Array(16);b._type="matrix";return b},mat4.copy=function(a){var b=new Float32Array(16);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15];return b},mat4.make=mat4.copy,mat4.equal=function(a,b){return Math.abs(a[0]-b[0])<mat.eps&&Math.abs(a[1]-b[1])<mat.eps&&Math.abs(a[2]-b[2])<mat.eps&&Math.abs(a[3]-b[3])<mat.eps&&Math.abs(a[4]-b[4])<mat.eps&&Math.abs(a[5]-b[5])<mat.eps&&Math.abs(a[6]-b[6])<mat.eps&&Math.abs(a[7]-b[7])<mat.eps&&Math.abs(a[8]-b[8])<mat.eps&&Math.abs(a[9]-b[9])<mat.eps&&Math.abs(a[10]-b[10])<mat.eps&&Math.abs(a[11]-b[11])<mat.eps&&Math.abs(a[12]-b[12])<mat.eps&&Math.abs(a[13]-b[13])<mat.eps&&Math.abs(a[14]-b[14])<mat.eps&&Math.abs(a[15]-b[15])<mat.eps},mat4.random=function(){var a=mat4.create();for(var b=0;b<16;++b)a[b]=Math.random();return a},mat4.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15];return a},function(){var a=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);mat4.identity=function(){var b=new Float32Array(a);b._type="matrix";return b},mat4.set_identity=function(b){mat4.set(b,a);return b}}(),mat4.transpose=function(a){var b=new Float32Array(16);b._type="matrix",b[0]=a[0],b[1]=a[4],b[2]=a[8],b[3]=a[12],b[4]=a[1],b[5]=a[5],b[6]=a[9],b[7]=a[13],b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=a[14],b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15];return b},mat4.set_transpose=function(a,b){if(b==a){var c=b[1],d=b[2],e=b[3],f=b[6],g=b[7],h=b[11];a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=c,a[6]=b[9],a[7]=b[13],a[8]=d,a[9]=e,a[11]=b[14],a[12]=e,a[13]=g,a[14]=h;return a}a[0]=b[0],a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=b[1],a[5]=b[5],a[6]=b[9],a[7]=b[13],a[8]=b[2],a[9]=b[6],a[10]=b[10],a[11]=b[14],a[12]=b[3],a[13]=b[7],a[14]=b[11],a[15]=b[15];return a},mat4.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},mat4.inverse=function(a){var b=new Float32Array(16);b._type="matrix";var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;b[0]=(h*D-i*C+j*B)/E,b[1]=(-d*D+e*C-f*B)/E,b[2]=(p*x-q*w+r*v)/E,b[3]=(-l*x+m*w-n*v)/E,b[4]=(-g*D+i*A-j*z)/E,b[5]=(c*D-e*A+f*z)/E,b[6]=(-o*x+q*u-r*t)/E,b[7]=(k*x-m*u+n*t)/E,b[8]=(g*C-h*A+j*y)/E,b[9]=(-c*C+d*A-f*y)/E,b[10]=(o*w-p*u+r*s)/E,b[11]=(-k*w+l*u-n*s)/E,b[12]=(-g*B+h*z-i*y)/E,b[13]=(c*B-d*z+e*y)/E,b[14]=(-o*v+p*t-q*s)/E,b[15]=(k*v-l*t+m*s)/E;return b},mat4.invert=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=b*g-c*f,s=b*h-d*f,t=b*i-e*f,u=c*h-d*g,v=c*i-e*g,w=d*i-e*h,x=j*o-k*n,y=j*p-l*n,z=j*q-m*n,A=k*p-l*o,B=k*q-m*o,C=l*q-m*p,D=r*C-s*B+t*A+u*z-v*y+w*x;a[0]=(g*C-h*B+i*A)/D,a[1]=(-c*C+d*B-e*A)/D,a[2]=(o*w-p*v+q*u)/D,a[3]=(-k*w+l*v-m*u)/D,a[4]=(-f*C+h*z-i*y)/D,a[5]=(b*C-d*z+e*y)/D,a[6]=(-n*w+p*t-q*s)/D,a[7]=(j*w-l*t+m*s)/D,a[8]=(f*B-g*z+i*x)/D,a[9]=(-b*B+c*z-e*x)/D,a[10]=(n*v-o*t+q*r)/D,a[11]=(-j*v+k*t-m*r)/D,a[12]=(-f*A+g*y-h*x)/D,a[13]=(b*A-c*y+d*x)/D,a[14]=(-n*u+o*s-p*r)/D,a[15]=(j*u-k*s+l*r)/D;return a},mat4.as_mat3=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[4],b[4]=a[5],b[5]=a[6],b[6]=a[8],b[7]=a[9],b[8]=a[10];return b},mat4.as_mat2=function(a){var b=new Float32Array(4);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[4],b[3]=a[5];return b},mat4.as_inverse_transpose_mat3=function(a){var b=a[0],c=a[4],d=a[8],e=a[1],f=a[5],g=a[9],h=a[2],i=a[6],j=a[10],k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;if(!n)throw"singular matrix";var o=new Float32Array(9);o._type="matrix",o[0]=k/n,o[1]=(-j*c+d*i)/n,o[2]=(g*c-d*f)/n,o[3]=l/n,o[4]=(j*b-d*h)/n,o[5]=(-g*b+d*e)/n,o[6]=m/n,o[7]=(-i*b+c*h)/n,o[8]=(f*b-c*e)/n;return o},mat4.product=function(a,b){var c=new Float32Array(16);c._type="matrix";var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s;return c},mat4.multiply=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];a[0]=s*c+t*g+u*k+v*o,a[1]=s*d+t*h+u*l+v*p,a[2]=s*e+t*i+u*m+v*q,a[3]=s*f+t*j+u*n+v*r,a[4]=w*c+x*g+y*k+z*o,a[5]=w*d+x*h+y*l+z*p,a[6]=w*e+x*i+y*m+z*q,a[7]=w*f+x*j+y*n+z*r,a[8]=A*c+B*g+C*k+D*o,a[9]=A*d+B*h+C*l+D*p,a[10]=A*e+B*i+C*m+D*q,a[11]=A*f+B*j+C*n+D*r,a[12]=E*c+F*g+G*k+H*o,a[13]=E*d+F*h+G*l+H*p,a[14]=E*e+F*i+G*m+H*q,a[15]=E*f+F*j+G*n+H*r;return a},mat4.product_vec=function(a,b){var c=new Float32Array(4);c._type="vector";var d=b[0],e=b[1],f=b[2],g=b[3];c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*g,c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*g,c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*g,c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*g;return c},mat4.multiply_vec=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];b[0]=a[0]*c+a[4]*d+a[8]*e+a[12]*f,b[1]=a[1]*c+a[5]*d+a[9]*e+a[13]*f,b[2]=a[2]*c+a[6]*d+a[10]*e+a[14]*f,b[3]=a[3]*c+a[7]*d+a[11]*e+a[15]*f;return b},mat4.multiply_vec3=function(a,b){var c=b[0],d=b[1],e=b[2];b[0]=a[0]*c+a[4]*d+a[8]*e,b[1]=a[1]*c+a[5]*d+a[9]*e,b[2]=a[2]*c+a[6]*d+a[10]*e;return b},mat4.translation_of=function(a,b){var c=new Float32Array(16);c._type="matrix";var d=b[0],e=b[1],f=b[2],g=a[0],h=a[1],i=a[2],j=a[3],k=a[4],l=a[5],m=a[6],n=a[7],o=a[8],p=a[9],q=a[10],r=a[11];c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c[6]=m,c[7]=n,c[8]=o,c[9]=p,c[10]=q,c[11]=r,c[12]=g*d+k*e+o*f+a[12],c[13]=h*d+l*e+p*f+a[13],c[14]=i*d+m*e+q*f+a[14],c[15]=j*d+n*e+r*f+a[15];return c},mat4.translation=function(a){var b=new Float32Array(16);b._type="matrix",b[0]=b[5]=b[10]=b[15]=1,b[12]=a[0],b[13]=a[1],b[14]=a[2];return b},mat4.translate=function(a,b){var c=b[0],d=b[1],e=b[2];a[12]=a[0]*c+a[4]*d+a[8]*e+a[12],a[13]=a[1]*c+a[5]*d+a[9]*e+a[13],a[14]=a[2]*c+a[6]*d+a[10]*e+a[14],a[15]=a[3]*c+a[7]*d+a[11]*e+a[15];return a},mat4.scaling_of=function(a,b){var c=new Float32Array(16);c._type="matrix";var d=b[0],e=b[1],f=b[2];c[0]=a[0]*d,c[1]=a[1]*d,c[2]=a[2]*d,c[3]=a[3]*d,c[4]=a[4]*e,c[5]=a[5]*e,c[6]=a[6]*e,c[7]=a[7]*e,c[8]=a[8]*f,c[9]=a[9]*f,c[10]=a[10]*f,c[11]=a[11]*f,c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15];return c},mat4.scaling=function(a,b){var c=new Float32Array(16);c[0]=b[0],c[5]=b[1],c[10]=b[2],c[15]=1;return c},mat4.scale=function(a,b){var c=new Float32Array(16);c._type="matrix";var d=b[0],e=b[1],f=b[2];a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=f,a[9]*=f,a[10]*=f,a[11]*=f;return c},mat4.rotation_of=function(a,b,c){var d=c[0],e=c[1],f=c[2],g=Math.sqrt(d*d+e*e+f*f);if(!g)throw"zero-length axis";g!=1&&(d/=g,e/=g,f/=g);var h=Math.sin(b),i=Math.cos(b),j=1-i,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=d*d*j+i,x=e*d*j+f*h,y=f*d*j-e*h,z=d*e*j-f*h,A=e*e*j+i,B=f*e*j+d*h,C=d*f*j+e*h,D=e*f*j-d*h,E=f*f*j+i,F=new Float32Array(16);F._type="matrix",F[0]=k*w+o*x+s*y,F[1]=l*w+p*x+t*y,F[2]=m*w+q*x+u*y,F[3]=n*w+r*x+v*y,F[4]=k*z+o*A+s*B,F[5]=l*z+p*A+t*B,F[6]=m*z+q*A+u*B,F[7]=n*z+r*A+v*B,F[8]=k*C+o*D+s*E,F[9]=l*C+p*D+t*E,F[10]=m*C+q*D+u*E,F[11]=n*C+r*D+v*E,F[12]=a[12],F[13]=a[13],F[14]=a[14],F[15]=a[15];return F},mat4.rotation=function(a,b){var c=b[0],d=b[1],e=b[2],f=Math.sqrt(c*c+d*d+e*e);if(!f)throw"zero-length axis";f!=1&&(c/=f,d/=f,e/=f);var g=Math.sin(a),h=Math.cos(a),i=1-h,j=1,k=0,l=0,m=0,n=0,o=1,p=0,q=0,r=0,s=0,t=1,u=0,v=c*c*i+h,w=d*c*i+e*g,x=e*c*i-d*g,y=c*d*i-e*g,z=d*d*i+h,A=e*d*i+c*g,B=c*e*i+d*g,C=d*e*i-c*g,D=e*e*i+h,E=new Float32Array(16);E._type="matrix",E[0]=c*c*i+h,E[1]=d*c*i+e*g,E[2]=e*c*i-d*g,E[4]=c*d*i-e*g,E[5]=d*d*i+h,E[6]=e*d*i+c*g,E[8]=c*e*i+d*g,E[9]=d*e*i-c*g,E[10]=e*e*i+h,E[15]=1;return E},mat4.rotate=function(a,b,c){var d=c[0],e=c[1],f=c[2],g=Math.sqrt(d*d+e*e+f*f);if(!g)throw"zero-length axis";g!=1&&(d/=g,e/=g,f/=g);var h=Math.sin(b),i=Math.cos(b),j=1-i,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=d*d*j+i,x=e*d*j+f*h,y=f*d*j-e*h,z=d*e*j-f*h,A=e*e*j+i,B=f*e*j+d*h,C=d*f*j+e*h,D=e*f*j-d*h,E=f*f*j+i;a[0]=k*w+o*x+s*y,a[1]=l*w+p*x+t*y,a[2]=m*w+q*x+u*y,a[3]=n*w+r*x+v*y,a[4]=k*z+o*A+s*B,a[5]=l*z+p*A+t*B,a[6]=m*z+q*A+u*B,a[7]=n*z+r*A+v*B,a[8]=k*C+o*D+s*E,a[9]=l*C+p*D+t*E,a[10]=m*C+q*D+u*E,a[11]=n*C+r*D+v*E,a[12]=a[12],a[13]=a[13],a[14]=a[14],a[15]=a[15];return a},mat4.frustum=function(a,b,c,d,e,f){var g=new Float32Array(16);g._type="matrix";var h=b-a,i=d-c,j=f-e;g[0]=e*2/h,g[5]=e*2/i,g[8]=(b+a)/h,g[9]=(d+c)/i,g[10]=-(f+e)/j,g[11]=-1,g[14]=-(f*e*2)/j;return g},mat4.perspective=function(a,b,c,d){var e=c*Math.tan(a*Math.PI/360),f=e*b;return mat4.frustum(-f,f,-e,e,c,d)},mat4.ortho=function(a,b,c,d,e,f){var g=new Float32Array(16);g._type="matrix";var h=b-a,i=d-c,j=f-e;g[0]=2/h,g[5]=2/i,g[10]=-2/j,g[12]=-(a+b)/h,g[13]=-(d+c)/i,g[14]=-(f+e)/j,g[15]=1;return g},mat4.lookAt=function(a,b,c){var d=new Float32Array(16);d._type="matrix";var e=a[0],f=a[1],g=a[2],h=c[0],i=c[1],j=c[2],k=b[0],l=b[1],m=b[2];if(e==k&&f==l&&g==m)return mat4.identity();var n,o,p,q,r,s,t,u,v,w;n=e-b[0],o=f-b[1],p=g-b[2],w=Math.sqrt(n*n+o*o+p*p),n/=w,o/=w,p/=w,q=i*p-j*o,r=j*n-h*p,s=h*o-i*n;if(w=Math.sqrt(q*q+r*r+s*s))q/=w,r/=w,s/=w;t=o*s-p*r,u=p*q-n*s,v=n*r-o*q;if(w=Math.sqrt(t*t+u*u+v*v))t/=w,u/=w,v/=w;d[0]=q,d[1]=t,d[2]=n,d[4]=r,d[5]=u,d[6]=o,d[8]=s,d[9]=v,d[10]=p,d[12]=-(q*e+r*f+s*g),d[13]=-(t*e+u*f+v*g),d[14]=-(n*e+o*f+p*g),d[15]=1;return d},mat4.frobenius_norm=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]+a[4]*a[4]+a[5]*a[5]+a[6]*a[6]+a[7]*a[7]+a[8]*a[8]+a[9]*a[9]+a[10]*a[10]+a[11]*a[11]+a[12]*a[12]+a[13]*a[13]+a[14]*a[14]+a[15]*a[15])},mat4.map=function(a,b){return mat4.make(_.map(a,b))},mat4.str=function(a){return"[ ["+a[0]+"] ["+a[4]+"]"+"[ ["+a[8]+"] ["+a[12]+"]\n"+"[ ["+a[1]+"] ["+a[5]+"]"+"[ ["+a[9]+"] ["+a[13]+"]\n"+"[ ["+a[2]+"] ["+a[6]+"]"+"[ ["+a[10]+"] ["+a[14]+"]\n"+"[ ["+a[3]+"] ["+a[7]+"]"+"[ ["+a[11]+"] ["+a[15]+"] ]"},vec[2]=vec2,vec[3]=vec3,vec[4]=vec4,vec2.mat=mat2,vec3.mat=mat3,vec4.mat=mat4,vec.eps=1e-6,vec.make=function(a){return vec[a.length].make(a)},vec.equal=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].equal(a,b)},vec.plus=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].plus(a,b)},vec.minus=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].minus(a,b)},vec.negative=function(a){return vec[a.length].negative(a)},vec.scaling=function(a,b){return vec[a.length].scaling(a,b)},vec.schur_product=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].schur_product(a,b)},vec.normalized=function(a){return vec[a.length].schur_product(a)},vec.length=function(a){return vec[a.length].length(a)},vec.dot=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].dot(a,b)},vec.map=function(a,b){return vec[a.length].map(a,b)},vec.str=function(a){return a[a.length].str(a)},function(){function a(a){switch(a){case 4:return 2;case 9:return 3;case 16:return 4}throw"bad length"}mat[2]=mat2,mat[3]=mat3,mat[4]=mat4,mat2.vec=vec2,mat3.vec=vec3,mat4.vec=vec4,mat.eps=1e-6,mat.make=function(b){return mat[a(b.length)].make(b)},mat.map=function(b,c){return mat[a(b.length)].map(b,c)},mat.equal=function(b,c){if(b.length!=c.length)throw"mismatched lengths: "+b.length+", "+c.length;return mat[a(b.length)].equal(b,c)},mat.str=function(b){return mat[a(b.length)].str(b)}}(),Facet.attribute_buffer=function(a,b,c,d){var e=Facet._globals.ctx;d===undefined&&(d=!1);var f={"float":[e.FLOAT,Float32Array],"short":[e.SHORT,Int16Array],ushort:[e.UNSIGNED_SHORT,Uint16Array],"byte":[e.BYTE,Int8Array],ubyte:[e.UNSIGNED_BYTE,Uint8Array]};b=b||3,c=f[c||"float"];var g=new c[1](a),h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,g,e.STATIC_DRAW),h._shade_type="attribute_buffer",h.array=g,h.itemSize=b,h.numItems=a.length/b,h.bind=function(a){return function(b){e.bindBuffer(e.ARRAY_BUFFER,this),e.vertexAttribPointer(b,this.itemSize,a,d,0,0)}}(c[0]),h.draw=function(a){e.drawArrays(a,0,this.numItems)},h.bind_and_draw=function(a,b){this.bind(a),this.draw(b)};return h},function(){function b(b){var c=Facet._globals.ctx;if(b.batch_id!==a.batch_id){var d=b.attributes||{},e=b.uniforms||{},f=b.program,g=b.primitives,h;Facet.unload_batch(),a=b,b.set_caps(),c.useProgram(f);for(h in d){var i=f[h];typeof i!="undefined"&&(c.enableVertexAttribArray(i),d[h].bind(i))}var j=0;_.each(f.uniforms,function(a){var b=a.uniform_name,d=a.uniform_call,e=a.get();if(typeOf(e)==="undefined")throw"uniform "+b+" has not been set.";var g=constant_type(e);g==="other"?(a._facet_active_uniform=function(a,b){return function(d){c.activeTexture(c.TEXTURE0+b),c.bindTexture(c.TEXTURE_2D,d),c.uniform1i(a,b)}}(f[b],j),j++):g==="number"||g=="vector"?a._facet_active_uniform=function(a,b){return function(d){a.call(c,b,d)}}(c[d],f[b]):g==="matrix"&&(a._facet_active_uniform=function(a,b){return function(d){c[a](b,!1,d)}}(d,f[b])),a._facet_active_uniform(e)})}b.draw_chunk()}var a={};Facet.unload_batch=function(){var b=Facet._globals.ctx;if(a.attributes){for(var c in a.attributes)b.disableVertexAttribArray(a.program[c]);_.each(a.program.uniforms,function(a){delete a._facet_active_uniform})}a={},b.disable(b.DEPTH_TEST),b.disable(b.BLEND),b.depthMask(!0)};var c=1;Facet.bake=function(a,d){var e=Facet._globals.ctx,f={};_.each(d,function(a,b){Shade.is_program_parameter(b)&&(f[b]=a)});var g=Shade.program(f),h=_.build(_.map(g.attribute_buffers,function(a){return[a._shade_name,a]})),i={points:e.POINTS,line_strip:e.LINE_STRIP,line_loop:e.LINE_LOOP,lines:e.LINES,triangle_strip:e.TRIANGLE_STRIP,triangle_fan:e.TRIANGLE_FAN,triangles:e.TRIANGLES},j=i[a.type],k=a.elements,l;typeOf(a.elements)==="number"?l=function(){e.drawArrays(j,0,k)}:l=function(){k.bind_and_draw(k,j)};var m=[i[a.type],a.elements],n=c++,o={program:g,attributes:h,set_caps:d.mode&&d.mode.set_draw_caps||Facet.DrawingMode.standard.set_draw_caps,draw_chunk:l,batch_id:n},p=Facet.fresh_pick_id(),q;d.pick_id?q=Shade.make(d.pick_id):q=Shade.make(Shade.id(p));var r={};_.each(d,function(a,b){if(Shade.is_program_parameter(b))if(b==="color"||b==="gl_FragColor"){var c=d.pick_if||Shade.make(a).swizzle("a").gt(0);r[b]=q.discard_if(Shade.not(c))}else r[b]=a});var s=Shade.program(r),t=_.build(_.map(s.attribute_buffers,function(a){return[a._shade_name,a]})),u=c++,v={program:s,attributes:t,set_caps:d.mode&&d.mode.set_pick_caps||Facet.DrawingMode.standard.set_pick_caps,draw_chunk:l,batch_id:u},w=[o,v],x={batch_id:p,draw:function(){b(w[Facet.Picker.picking_mode])},_draw:function(){b(o)},_pick:function(){b(v)}};return x}}(),Facet.Camera={},Facet.Camera.perspective=function(a){function j(){f=mat4.perspective(b,c,d,e),h.set(Shade.mul(mat4.product(f,g)))}a=a||{},a=_.defaults(a,{look_at:[[0,0,0],[0,0,-1],[0,1,0]],field_of_view_y:45,aspect_ratio:1,near_distance:.1,far_distance:100});var b=a.field_of_view_y,c=a.aspect_ratio,d=a.near_distance,e=a.far_distance,f,g=mat4.lookAt(a.look_at[0],a.look_at[1],a.look_at[2]),h=Shade.uniform("mat4"),i=Shade.uniform("mat4",g);j();return{look_at:function(a,b,c){g=mat4.lookAt(a,b,c),i.set(g)},set_aspect_ratio:function(a){c=a,j(),h.set(Shade.mul(mat4.product(f,g)))},set_near_distance:function(a){d=a,j(),h.set(Shade.mul(mat4.product(f,g)))},set_far_distance:function(a){e=a,j(),h.set(Shade.mul(mat4.product(f,g)))},set_field_of_view_y:function(a){b=a,j(),h.set(Shade.mul(mat4.product(f,g)))},project:function(a){var b=a.type;if(b.equals(Shade.Types.vec2))return h.mul(Shade.vec(a,0,1));if(b.equals(Shade.Types.vec3))return h.mul(Shade.vec(a,1));if(b.equals(Shade.Types.vec4))return h.mul(a);throw"Type mismatch: expected vec, got "+b.repr()},eye_vertex:function(a){var b=a.type;if(b.equals(Shade.Types.vec2))return i.mul(Shade.vec(a,0,1));if(b.equals(Shade.Types.vec3))return i.mul(Shade.vec(a,1));if(b.equals(Shade.Types.vec4))return i.mul(a);throw"Type mismatch: expected vec, got "+b.repr()}}},function(){}(),Facet.element_buffer=function(a){var b=Facet._globals.ctx,c=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,c);var d=new Uint16Array(a);b.bufferData(b.ELEMENT_ARRAY_BUFFER,d,b.STATIC_DRAW),c._shade_type="element_buffer",c.array=d,c.itemSize=1,c.numItems=a.length,c.bind=function(a){b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this)},c.draw=function(a){b.drawElements(a,this.numItems,b.UNSIGNED_SHORT,0)},c.bind_and_draw=function(a,b){this.bind(a),this.draw(b)};return c},function(){var a=1;Facet.fresh_pick_id=function(b){b=b||1;var c=a;a+=b;return c}}(),Facet.id_buffer=function(a){if(typeOf(a)!=="array")throw"id_buffer expects array of integers";var b=new Int32Array(a),c=new Uint8Array(b.buffer);return Facet.attribute_buffer(c,4,"ubyte",!0)},Facet.initGL=function(a,b){a.unselectable=!0,a.onselectstart=function(){return!1};var c,d,e;b=_.defaults(b||{},{clearColor:[1,1,1,0],clearDepth:1,attributes:{alpha:!0,depth:!0}});if(b.clearColor.expression_type){if(!b.clearColor.is_constant())throw"clearColor must be constant expression";if(!b.clearColor.type.equals(Shade.Types.vec4))throw"clearColor must be vec4";d=_.toArray(b.clearColor.constant_value())}else d=b.clearColor;if(b.clearDepth.expression_type){if(!b.clearDepth.is_constant())throw"clearDepth must be constant expression";if(!b.clearDepth.type.equals(Shade.Types.float_t))throw"clearDepth must be float";e=b.clearDepth.constant_value()}else e=b.clearDepth;Facet._globals.display_callback=b.display||function(){},typeof b=="undefined"&&(b={});try{"attributes"in b?c=WebGLUtils.setupWebGL(a,b.attributes):c=WebGLUtils.setupWebGL(a);if(!c)throw"Failed context creation";if(b.debugging){function f(a,b,c){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+b}c=WebGLDebugUtils.makeDebugContext(c,f)}c.viewportWidth=a.width,c.viewportHeight=a.height;var g=["mouseover","mousemove","mousedown","mouseout","mouseup"];for(var h=0;h<g.length;++h){var i=g[h],j=b[i];typeof j!="undefined"&&a.addEventListener(i,j,!1)}}catch(k){alert(k)}c||alert("Could not initialise WebGL, sorry :-("),c.display=function(){this.viewport(0,0,this.viewportWidth,this.viewportHeight),this.clearDepth(e),this.clearColor.apply(c,d),this.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),Facet._globals.display_callback()},Facet.set_context(c);return c},Facet.load_image_into_texture=function(a){function h(){f.bindTexture(f.TEXTURE_2D,b),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0),f.texSubImage2D(f.TEXTURE_2D,0,d,e,a.width,a.height,f.RGBA,f.UNSIGNED_BYTE,a.buffer),c()}function g(a){f.bindTexture(f.TEXTURE_2D,b),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0),f.texSubImage2D(f.TEXTURE_2D,0,d,e,f.RGBA,f.UNSIGNED_BYTE,a),c(a)}a=_.defaults(a,{onload:function(){},x_offset:0,y_offset:0});var b=a.texture,c=a.onload,d=a.x_offset,e=a.y_offset,f=Facet._globals.ctx;if(a.src){var i=new Image;i.onload=function(){g(i)},a.crossOrigin&&(i.crossOrigin=a.crossOrigin),i.src=a.src}else if(a.img)if(a.img.isComplete)g(a.img);else{var j=b.image.onload||function(){};a.img.onload=function(){g(a.img),j()}}else h()},Facet.identity=function(){return mat4.identity()},Facet.translation=function(a){function c(a){return mat4.translation(a)}function b(a){var b=mat3.create();b[6]=a[0],b[7]=a[1];return b}if(a.length===3)return c(a);if(arguments.length===3)return c(arguments);if(a.length===2)return b(a);if(arguments.length===2)return b(arguments);throw"Invalid vector size for translation"},Facet.scaling=function(a){function d(a){return mat4.scaling(a)}function c(a){var b=mat3.create();b[0]=a[0],b[4]=a[1];return b}var b;if(a.length===3)return d(a);if(arguments.length===3)return d(arguments);if(a.length===2)return c(a);if(arguments.length===2)return c(arguments);throw"Invalid size for scale"},Facet.rotation=function(a,b){return mat4.rotation(a,b)},Facet.look_at=function(a,b,c,d,e,f,g,h,i){return mat4.lookAt([a,b,c],[d,e,f],[g,h,i])},Facet.perspective=mat4.perspective,Facet.frustum=mat4.frustum,Facet.ortho=mat4.ortho,Facet.shear=function(a,b){return mat4.create([1,0,a,0,0,1,b,0,0,0,1,0,0,0,0,1])},Facet.model=function(a){var b={},c;for(var d in a){var e=a[d];if(d==="type")b.type=e;else if(d==="elements")e._shade_type==="element_buffer"?b.elements=Shade.make(e):typeOf(e)==="array"?b.elements=Shade.make(Facet.element_buffer(e)):b.elements=e;else if(e._shade_type==="attribute_buffer")b[d]=Shade.make(e),c=e.numItems;else if(typeOf(e)==="array")if(typeOf(e[0])!=="array"){var f=e[0].type.vec_dimension(),g=[];_.each(e,function(a){var b=a.constant_value();for(var c=0;c<f;++c)g.push(b[c])});var h=Facet.attribute_buffer(g,f);b[d]=Shade.make(h),c=h.numItems}else{var h=Facet.attribute_buffer(e[0],e[1]);b[d]=Shade.make(h),c=h.numItems}else b[d]=e}if(!("elements"in b)){if(typeOf(c)==="undefined")throw"Facet.model could not figure out how many elements are in this model; consider passing an 'elements' field.";b.elements=c}return b},function(){var a;Facet.Picker={picking_mode:0,draw_pick_scene:function(b){var c=Facet._globals.ctx;a||(a=Facet.render_buffer({width:c.viewportWidth,height:c.viewportHeight,TEXTURE_MAG_FILTER:c.NEAREST,TEXTURE_MIN_FILTER:c.NEAREST})),b=b||Facet._globals.display_callback,this.picking_mode=1;try{a.render_to_buffer(function(){c.clearColor(0,0,0,0),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),b()})}finally{this.picking_mode=0}},pick:function(b,c){var d=Facet._globals.ctx,e=new ArrayBuffer(4),f=new Uint8Array(4);d.readPixels(b,c,1,1,d.RGBA,d.UNSIGNED_BYTE,f),a.render_to_buffer(function(){d.readPixels(b,c,1,1,d.RGBA,d.UNSIGNED_BYTE,f)});var g=new Uint32Array(f.buffer);return g[0]}}}(),Facet.profile=function(a,b,c,d){c&&c(),console.profile(a),setTimeout(function(){console.profileEnd(),d&&d()},b*1e3)},Facet.program=function(a,b){function d(a,b){var d=c.createShader(a);c.shaderSource(d,b),c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS)){alert(c.getShaderInfoLog(d));return null}return d}var c=Facet._globals.ctx,e=d(c.VERTEX_SHADER,a),f=d(c.FRAGMENT_SHADER,b),g=c.createProgram();c.attachShader(g,e),c.attachShader(g,f),c.linkProgram(g);if(!c.getProgramParameter(g,c.LINK_STATUS)){alert("Could not initialise shaders");return null}var h=c.getProgramParameter(g,c.ACTIVE_UNIFORMS),i=/.*\[0\]/;for(var j=0;j<h;++j){var k=c.getActiveUniform(g,j);if(i.test(k.name)){var l=k.name.substr(0,k.name.length-3);g[l]=c.getUniformLocation(g,l)}else g[k.name]=c.getUniformLocation(g,k.name)}var m=c.getProgramParameter(g,c.ACTIVE_ATTRIBUTES);for(j=0;j<m;++j){var k=c.getActiveAttrib(g,j);g[k.name]=c.getAttribLocation(g,k.name)}return g},Facet.render_buffer=function(a){var b=Facet._globals.ctx,c=b.createFramebuffer();b.bindFramebuffer(b.FRAMEBUFFER,c),a=_.defaults(a||{},{width:512,height:512}),c.width=a.width,c.height=a.height;var d=b.createTexture();d._shade_type="texture",b.bindTexture(b.TEXTURE_2D,d),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,a.TEXTURE_MAG_FILTER||b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,a.TEXTURE_MIN_FILTER||b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,a.TEXTURE_WRAP_S||b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,a.TEXTURE_WRAP_T||b.CLAMP_TO_EDGE),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,c.width,c.height,0,b.RGBA,b.UNSIGNED_BYTE,null);var e=b.createRenderbuffer();b.bindRenderbuffer(b.RENDERBUFFER,e),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,c.width,c.height),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,d,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,e);var f=b.checkFramebufferStatus(b.FRAMEBUFFER);switch(f){case b.FRAMEBUFFER_COMPLETE:break;case b.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case b.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case b.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case b.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+f}b.bindTexture(b.TEXTURE_2D,null),b.bindRenderbuffer(b.RENDERBUFFER,null),b.bindFramebuffer(b.FRAMEBUFFER,null);return{_shade_type:"render_buffer",texture:d,width:c.width,height:c.height,frame_buffer:c,render_to_buffer:function(a){try{b.bindFramebuffer(b.FRAMEBUFFER,c),b.viewport(0,0,c.width,c.height),a()}finally{b.bindFramebuffer(b.FRAMEBUFFER,null)}}}},Facet.set_context=function(a){Facet._globals.ctx=a},Facet.texture=function(a){function g(e){b.bindTexture(b.TEXTURE_2D,e),b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),e.image?b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,e.image):b.texImage2D(b.TEXTURE_2D,0,b.RGBA,e.width,e.height,0,b.RGBA,b.UNSIGNED_BYTE,e.buffer),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,a.TEXTURE_MAG_FILTER||b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,a.TEXTURE_MIN_FILTER||b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,a.TEXTURE_WRAP_S||b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,a.TEXTURE_WRAP_T||b.CLAMP_TO_EDGE),d&&b.generateMipmap(b.TEXTURE_2D),b.bindTexture(b.TEXTURE_2D,null),c(e),Facet.unload_batch()}var b=Facet._globals.ctx,c=a.onload||function(){},d=a.mipmaps||!1,e=a.width,f=a.height,h=b.createTexture();h._shade_type="texture",h.width=a.width,h.height=a.height;if(a.src){var i=new Image;i.onload=function(){h.width=i.width,h.height=i.height,g(h)},h.image=i,a.crossOrigin&&(i.crossOrigin=a.crossOrigin),i.src=a.src}else a.img?(h.image=a.img,h.image.isComplete?(h.width=h.image.width,h.height=h.image.height,g(h)):h.image.onload=function(){h.width=h.image.width,h.height=h.image.height,g(h)}):(h.buffer=a.buffer||null,g(h));return h},Facet.Net={},Facet.Net.buffer_ajax=function(a,b){var c=new window.XMLHttpRequest,d=!1;c.onreadystatechange=function(){if(c.readyState==4&&c.status==200&&d!=!0){if(c.responseType=="arraybuffer")b(c.response,a);else if(c.mozResponseArrayBuffer!=null)b(c.mozResponseArrayBuffer,a);else if(c.responseText!=null){var e=new String(c.responseText),f=Array(e.length);for(var g=0;g<e.length;g++)f[g]=e.charCodeAt(g)&255;var h=new Uint8Array(f);b(h.buffer,a)}d=!0}},c.open("GET",a,!0),c.hasOwnProperty("responseType")?c.responseType="arraybuffer":c.overrideMimeType("text/plain; charset=x-user-defined"),c.send()},Facet.Scale={},Facet.Scale.Geo={},Facet.Scale.Geo.mercator_to_spherical=function(a,b){var c=b.sinh().atan(),d=a;return Facet.Scale.Geo.latlong_to_spherical(c,d)},Facet.Scale.Geo.latlong_to_spherical=function(a,b){a=Shade.make(a),b=Shade.make(b);var c=a.cos();return Shade.vec(b.sin().mul(c),a.sin(),b.cos().mul(c),1)},Facet.DrawingMode={},Facet.DrawingMode.additive={set_draw_caps:function(){var a=Facet._globals.ctx;a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE),a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)},set_pick_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)}},Facet.DrawingMode.over={set_draw_caps:function(){var a=Facet._globals.ctx;a.enable(a.BLEND),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA),a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)},set_pick_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)}},Facet.DrawingMode.over_with_depth={set_draw_caps:function(){var a=Facet._globals.ctx;a.enable(a.BLEND),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA),a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS)},set_pick_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS)}},Facet.DrawingMode.standard={set_draw_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS)},set_pick_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS)}};var Shade={};(function(){function b(a,b,c,d){var e=[],f=Math.min(b.length,c.length,d.length);for(var g=0;g<f;++g)e.push(a(b[g],c[g],d[g]));return e}function a(a,b,c){var d=[],e=Math.min(b.length,c.length);for(var f=0;f<e;++f)d.push(a(b[f],c[f]));return d}Shade.debug=!1,function(){function a(a,b,c){this.begin=Shade.make(a).as_int(),this.end=Shade.make(b).as_int(),this.value=c||function(a){return a}}Shade.variable=function(a){return Shade._create_concrete_exp({parents:[],type:a,eval:function(){return this.glsl_name},compile:function(){}})},Shade.range=function(b,c,d){return new a(b,c,d)},a.prototype.transform=function(a){var b=this;return Shade.range(this.begin,this.end,function(c){var d=b.value(c),e=a(d);return e})},a.prototype.average=function(){return this.sum().div(this.end.sub(this.begin).as_float())},a.prototype.fold=function(a,b){a=Shade.make(a),b=Shade.make(b);var c=Shade.variable(Shade.Types.int_t),d=this.value(c),e=Shade.variable(b.type),f=e.type,g=a(e,d);return Shade._create_concrete_exp({parents:[this.begin,this.end,c,e,d,b,g],type:f,eval:function(){return this.glsl_name+"()"},element:Shade.memoize_on_field("_element",function(a){if(this.type.is_pod()){if(a===0)return this;throw this.type.repr()+" is an atomic type"
}return this.at(a)}),compile:function(a){var b=this.parents[0],c=this.parents[1],d=this.parents[2],e=this.parents[3],f=this.parents[4],g=this.parents[5],h=this.parents[6];a.strings.push(this.type.repr(),this.glsl_name,"() {\n"),a.strings.push("    ",e.type.declare(e.glsl_name),"=",g.eval(),";\n"),a.strings.push("    for (int",d.eval(),"=",b.eval(),";",d.eval(),"<",c.eval(),";","++",d.eval(),") {\n"),a.strings.push("        ",e.eval(),"=",h.eval()+";\n"),a.strings.push("    }\n"),a.strings.push("    return",this.type.repr(),"(",e.eval(),");\n"),a.strings.push("}\n")}})},a.prototype.sum=function(){var a=Shade.variable(Shade.Types.int_t),b=this.value(a),c=b.type,d,e=Shade.variable(c);if(b.type.equals(Shade.Types.int_t))d=Shade.Types.float_t;else if(_.any([Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec3,Shade.Types.vec4,Shade.Types.mat2,Shade.Types.mat3,Shade.Types.mat4],function(a){return a.equals(c)}))d=c;else throw"Type error, sum can't support range of type "+c.repr();return Shade._create_concrete_exp({parents:[this.begin,this.end,a,e,b],type:d,eval:function(){return this.glsl_name+"()"},element:Shade.memoize_on_field("_element",function(a){if(this.type.is_pod()){if(a===0)return this;throw this.type.repr()+" is an atomic type"}return this.at(a)}),compile:function(a){var b=this.parents[0],c=this.parents[1],d=this.parents[2],e=this.parents[3],f=this.parents[4];a.strings.push(this.type.repr(),this.glsl_name,"() {\n"),a.strings.push("    ",e.type.declare(e.glsl_name),"=",e.type.zero,";\n"),a.strings.push("    for (int",d.eval(),"=",b.eval(),";",d.eval(),"<",c.eval(),";","++",d.eval(),") {\n"),a.strings.push("        ",e.eval(),"=",e.eval(),"+",f.eval(),";\n"),a.strings.push("    }\n"),a.strings.push("    return",this.type.repr(),"(",e.eval(),");\n"),a.strings.push("}\n")}})}}(),Shade.unique_name=function(){var a=0;return function(){a=a+1;return"_unique_name_"+a}}(),Shade._create=function(){var a=0;return function(b,c){function d(){for(var b in c)this[b]=c[b];this.guid="GUID_"+a,a+=1}d.prototype=b;return new d}}(),Shade._create_concrete=function(a,b){function c(c){for(var d=0;d<b.length;++d){var e=b[d];if(!(e in c))throw"New expression missing "+b[d];if(typeOf(c[e])==="undefined")throw"field '"+e+"' cannot be undefined."}return Shade._create(a,c)}return c},Shade.memoize_on_field=function(a,b){return function(){typeOf(this[a])==="undefined"&&(this[a]={}),typeOf(this[a][arguments[0]])==="undefined"&&(this[a][arguments[0]]=b.apply(this,arguments));return this[a][arguments[0]]}},Shade.Types={},Shade.Types.base_t={is_floating:function(){return!1},is_integral:function(){return!1},is_array:function(){return!1},is_pod:function(){return!1},is_vec:function(){return!1},vec_dimension:function(){throw"is_vec() === false, cannot call vec_dimension"},is_function:function(){return!1},is_sampler:function(){return!1},equals:function(a){if(typeOf(a)==="undefined")throw"Type.equals can't be compared to undefined";return this.repr()==a.repr()},swizzle:function(a){throw"type '"+this.repr()+"' does not support swizzling."},element_type:function(a){throw"invalid call: atomic expression"},declare:function(a){return this.repr()+" "+a}},Shade.basic=function(a){function b(a){return a==="float"?!0:a==="int"?!0:a==="bool"?!0:a==="void"?!0:a==="sampler2D"?!0:a.substring(0,3)==="mat"&&Number(a[3])>1&&Number(a[3])<5?!0:a.substring(0,3)==="vec"&&Number(a[3])>1&&Number(a[3])<5?!0:a.substring(0,4)==="bvec"&&Number(a[4])>1&&Number(a[4])<5?!0:a.substring(0,4)==="ivec"&&Number(a[4])>1&&Number(a[4])<5?!0:!1}if(!b(a))throw"invalid basic type '"+a+"'.";return Shade._create(Shade.Types.base_t,{declare:function(b){return a+" "+b},repr:function(){return a},swizzle:function(a){if(!this.is_array())throw"Swizzle pattern requires array type";var b=this.repr(),c=Number(b[b.length-1]),d,e;switch(c){case 2:d=/[rgxyst]+/,e=[/[rg]/,/[xy]/,/[st]/];break;case 3:d=/[rgbxyzstp]+/,e=[/[rgb]/,/[xyz]/,/[stp]/];break;case 4:d=/[rgbazxyzwstpq]+/,e=[/[rgba]/,/[xyzw]/,/[stpq]/];break;default:throw"Internal error?!"}if(!a.match(d))throw"Invalid swizzle pattern '"+a+"'.";var f=0;for(var g=0;g<e.length;++g)a.match(e[g])&&(f+=1);if(f!=1)throw"Swizzle pattern '"+a+"' belongs to more than one group.";return a.length===1?this.array_base():Shade.basic(b.substring(0,b.length-1)+a.length)},is_pod:function(){var a=this.repr();return["float","bool","int"].indexOf(a)!==-1},is_vec:function(){var a=this.repr();return a.substring(0,3)==="vec"?!0:a.substring(0,4)==="ivec"?!0:a.substring(0,4)==="bvec"?!0:!1},is_mat:function(){var a=this.repr();return a.substring(0,3)==="mat"?!0:!1},vec_dimension:function(){var a=this.repr();if(a.substring(0,3)==="vec")return parseInt(a[3]);if(a.substring(0,4)==="ivec"||a.substring(0,4)==="bvec")return parseInt(a[4]);if(this.repr()==="float"||this.repr()==="int"||this.repr()==="bool")return 1;throw this.is_vec()?"internal error":"is_vec() === false, cannot call vec_dimension"},is_array:function(){var a=this.repr();return a.substring(0,3)==="mat"?!0:this.is_vec()?!0:!1},array_base:function(){var a=this.repr();if(a.substring(0,3)==="mat")return Shade.basic("vec"+a[3]);if(a.substring(0,3)==="vec")return Shade.basic("float");if(a.substring(0,4)==="bvec")return Shade.basic("bool");if(a.substring(0,4)==="ivec")return Shade.basic("int");if(a=="float")return Shade.basic("float");throw"datatype not array!"},size_for_vec_constructor:function(){var a=this.repr();if(this.is_array())return this.array_size();if(a==="float"||a==="bool"||a==="int")return 1;throw"not usable inside vec constructor"},array_size:function(){if(this.is_vec())return this.vec_dimension();var a=this.repr();if(a.substring(0,3)==="mat")return parseInt(a[3]);throw"datatype not array!"},is_floating:function(){var a=this.repr();return a==="float"?!0:a.substring(0,3)==="vec"?!0:a.substring(0,3)==="mat"?!0:!1},is_integral:function(){var a=this.repr();return a==="int"?!0:a.substring(0,4)==="ivec"?!0:!1},is_sampler:function(){var a=this.repr();return a==="sampler2D"?!0:!1},element_type:function(a){if(this.is_pod()){if(a===0)return this;throw"invalid call: "+this.repr()+" is atomic"}if(this.is_vec()){var b=this.repr()[0],c=this.array_size();if(a<0||a>=c)throw"invalid call: "+this.repr()+" has no element "+a;if(b==="v")return Shade.Types.float_t;if(b==="b")return Shade.Types.bool_t;if(b==="i")return Shade.Types.int_t;throw"Internal error"}throw"Unimplemented for mats"}})},Shade.array=function(a,b){return Shade._create(Shade.Types.base_t,{is_array:function(){return!0},declare:function(c){return a.declare(c)+"["+b+"]"},repr:function(){return a.repr()+"["+b+"]"},array_size:function(){return b},array_base:function(){return a}})},Shade.Types.function_t=function(a,b){return Shade._create(Shade.Types.base_t,{repr:function(){return"("+a.repr()+")("+", ".join(b.map(function(a){return a.repr()}))},is_function:function(){return!0},function_return_type:function(){return a},function_parameter:function(a){return b[a]},function_parameter_count:function(){return b.length}})},function(){var a=["mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4"];for(var b=0;b<a.length;++b)Shade.Types[a[b]]=Shade.basic(a[b]);Shade.Types.float_t=Shade.basic("float"),Shade.Types.bool_t=Shade.basic("bool"),Shade.Types.int_t=Shade.basic("int"),Shade.Types.sampler2D=Shade.basic("sampler2D"),Shade.Types.int_t.zero="0",Shade.Types.float_t.zero="0.0",Shade.Types.vec2.zero="vec2(0,0)",Shade.Types.vec3.zero="vec3(0,0,0)",Shade.Types.vec4.zero="vec4(0,0,0,0)",Shade.Types.mat2.zero="mat2(0,0,0,0)",Shade.Types.mat3.zero="mat3(0,0,0,0,0,0,0,0,0)",Shade.Types.mat4.zero="mat4(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)"}(),Shade.make=function(a){var b=typeOf(a);if(b==="boolean"||b==="number")return Shade.constant(a);if(b==="array")return Shade.seq(a);b=constant_type(a);if(b==="vector"||b==="matrix")return Shade.constant(a);if(a._shade_type==="attribute_buffer")return Shade.attribute_from_buffer(a);if(a._shade_type==="render_buffer")return Shade.sampler2D_from_texture(a.texture);if(a._shade_type==="texture")return Shade.sampler2D_from_texture(a);return a},Shade.VERTEX_PROGRAM_COMPILE=1,Shade.FRAGMENT_PROGRAM_COMPILE=2,Shade.UNSET_PROGRAM_COMPILE=3,Shade.CompilationContext=function(a){return{freshest_glsl_name:0,compile_type:a||Shade.UNSET_PROGRAM_COMPILE,float_precision:"highp",strings:[],initialization_exprs:[],declarations:{uniform:{},attribute:{},varying:{}},source:function(){return this.strings.join(" ")},request_fresh_glsl_name:function(){var a=this.freshest_glsl_name++;return"glsl_name_"+a},declare:function(a,b,c,d){if(typeof c=="undefined")throw"must define type";if(b in d){var e=d[b];if(!e.equals(c))throw"Compile error: Different expressions use conflicting types for '"+a+" "+b+"': '"+e.repr()+"', '"+c.repr()+"'."}else d[b]=c,this.strings.push(a+" "+c.declare(b)+";\n")},declare_uniform:function(a,b){this.declare("uniform",a,b,this.declarations.uniform)},declare_varying:function(a,b){this.declare("varying",a,b,this.declarations.varying)},declare_attribute:function(a,b){this.declare("attribute",a,b,this.declarations.attribute)},compile:function(a){var b=a.sorted_sub_expressions(),c,d=this;_.each(b,function(a){a.children_count=0,a.is_unconditional=!1,a.glsl_name=d.request_fresh_glsl_name(),a.set_requirements(this);for(var b=0;b<a.parents.length;++b)a.parents[b].children_count++}),b[b.length-1].is_unconditional=!0,c=b.length;while(c--){var e=b[c];e.propagate_conditions()}this.strings.push("precision",this.float_precision,"float;\n");for(c=0;c<b.length;++c)b[c].compile(this);this.strings.push("void main() {\n");for(c=0;c<this.initialization_exprs.length;++c)this.strings.push("    ",this.initialization_exprs[c],";\n");this.strings.push("    ",a.eval(),";\n","}\n")},add_initialization:function(a){this.initialization_exprs.push(a)},value_function:function(){this.strings.push(arguments[0].type.repr(),arguments[0].glsl_name,"(void) {\n","    return ");for(var a=1;a<arguments.length;++a)this.strings.push(arguments[a]);this.strings.push(";\n}\n")},void_function:function(){this.strings.push("void",arguments[0].glsl_name,"(void) {\n","    ");for(var a=1;a<arguments.length;++a)this.strings.push(arguments[a]);this.strings.push(";\n}\n")}}},Shade.Exp={debug_print:function(a){a===undefined&&(a=0);var b="";for(var c=0;c<a;++c)b=b+" ";if(this.parents.length===0)console.log(b+"["+this.expression_type+":"+this.guid+"]"+"()");else{console.log(b+"["+this.expression_type+":"+this.guid+"]"+"(");for(c=0;c<this.parents.length;++c)this.parents[c].debug_print(a+2);console.log(b+")")}},eval:function(){return this.glsl_name+"()"},parent_is_unconditional:function(a){return!0},propagate_conditions:function(){for(var a=0;a<this.parents.length;++a)this.parents[a].is_unconditional=this.parents[a].is_unconditional||this.is_unconditional&&this.parent_is_unconditional(a)},set_requirements:function(){},stage:null,sorted_sub_expressions:function(){var a=[],b=function(c){if(a.indexOf(c)==-1){var d=c.parents;if(typeOf(d)==="undefined")throw"Internal error: expression "+c.eval()+" has undefined parents.";for(var e=0;e<d.length;++e)b(d[e]);a.push(c)}};b(this);return a},is_constant:function(){return!1},constant_value:function(){throw"invalid call: this.is_constant() == false"},element_is_constant:function(a){return!1},element_constant_value:function(a){throw"invalid call: no constant elements"},element:function(a){throw"invalid call: atomic expression"},add:function(a){return Shade.add(this,a)},mul:function(a){return Shade.mul(this,a)},div:function(a){return Shade.div(this,a)},sub:function(a){return Shade.sub(this,a)},length:function(){return Shade.length(this)},distance:function(a){return Shade.distance(this,a)},dot:function(a){return Shade.dot(this,a)},cross:function(a){return Shade.cross(this,a)},normalize:function(){return Shade.normalize(this)},reflect:function(a){return Shade.reflect(this,a)},refract:function(a,b){return Shade.refract(this,a,b)},texture2D:function(a){return Shade.texture2D(this,a)},clamp:function(a,b){return Shade.clamp(this,a,b)},min:function(a){return Shade.min(this,a)},max:function(a){return Shade.max(this,a)},per_vertex:function(){return Shade.per_vertex(this)},discard_if:function(a){return Shade.discard_if(this,a)},as_int:function(){if(this.type.equals(Shade.Types.int_t))return this;var a=this;return Shade._create_concrete_value_exp({parents:[a],type:Shade.Types.int_t,value:function(){return"int("+this.parents[0].eval()+")"},is_constant:function(){return a.is_constant()},constant_value:function(){var b=a.constant_value();return Math.floor(b)},expression_type:"cast(int)"})},as_bool:function(){if(this.type.equals(Shade.Types.bool_t))return this;var a=this;return Shade._create_concrete_value_exp({parents:[a],type:Shade.Types.bool_t,value:function(){return"bool("+this.parents[0].eval()+")"},is_constant:function(){return a.is_constant()},constant_value:function(){var b=a.constant_value();return~~b},expression_type:"cast(bool)"})},as_float:function(){if(this.type.equals(Shade.Types.float_t))return this;var a=this;return Shade._create_concrete_value_exp({parents:[a],type:Shade.Types.float_t,value:function(){return"float("+this.parents[0].eval()+")"},is_constant:function(){return a.is_constant()},constant_value:function(){var b=a.constant_value();return Number(b)},expression_type:"cast(float)"})},swizzle:function(a){function b(a){function b(a){switch(a.toLowerCase()){case"r":return 0;case"g":return 1;case"b":return 2;case"a":return 3;case"x":return 0;case"y":return 1;case"z":return 2;case"w":return 3;case"s":return 0;case"t":return 1;case"p":return 2;case"q":return 3;default:throw"Invalid swizzle pattern"}}var c=[];for(var d=0;d<a.length;++d)c.push(b(a[d]));return c}var c=this,d=b(a);return Shade._create_concrete_exp({parents:[c],type:c.type.swizzle(a),expression_type:"swizzle",eval:function(){return this.parents[0].eval()+"."+a},is_constant:Shade.memoize_on_field("_is_constant",function(){var a=this;return _.all(d,function(b){return a.parents[0].element_is_constant(b)})}),constant_value:Shade.memoize_on_field("_constant_value",function(){if(this.type.is_pod())return this.parents[0].element_constant_value(d[0]);var a=this,b=_.map(d,function(b){return a.parents[0].element_constant_value(b)}),c=this.type.vec_dimension();switch(c){case 2:return vec2.make(b);case 3:return vec3.make(b);case 4:return vec4.make(b);default:throw"bad vec dimension "+c}}),element:function(a){return this.parents[0].element(d[a])},element_is_constant:Shade.memoize_on_field("_element_is_constant",function(a){return this.parents[0].element_is_constant(d[a])}),element_constant_value:Shade.memoize_on_field("_element_constant_value",function(a){return this.parents[0].element_constant_value(d[a])}),compile:function(){}})},at:function(a){var b=this;a=Shade.make(a),a._must_be_function_call=!0;return Shade._create_concrete_exp({parents:[b,a],type:b.type.array_base(),expression_type:"index",eval:function(){return this.parents[1].type.is_integral()?this.parents[0].eval()+"["+this.parents[1].eval()+"]":this.parents[0].eval()+"[int("+this.parents[1].eval()+")]"},is_constant:function(){return this.parents[0].is_constant()&&this.parents[1].is_constant()},constant_value:Shade.memoize_on_field("_constant_value",function(){var a=this.parents[0].constant_value();if(typeOf(a)==="array")return a[this.parents[1].constant_value()];if(a._type==="vector")return a[this.parents[1].constant_value()];throw"at constant_value currently broken"}),element:Shade.memoize_on_field("_element",function(a){if(!this.parents[1].is_constant())throw"at().element cannot be called with non-constant index";var b=this.parents[1].constant_value(),c=this.parents[0].element(b);return c===this?c.at(a):c.element(a)}),element_is_constant:Shade.memoize_on_field("_element_is_constant",function(a){if(!this.parents[1].is_constant())return!1;var b=this.parents[1].constant_value(),c=this.parents[0].element(b);return c===this?!1:c.element_is_constant(a)}),element_constant_value:Shade.memoize_on_field("_element_constant_value",function(a){var b=this.parents[1].constant_value(),c=this.parents[0].element(b);if(c===this)throw"Would have gone into an infinite loop here: internal error.";return c.element_constant_value(a)}),compile:function(){}})},expression_type:"other",_type:"shade_expression",_attribute_buffers:[],_uniforms:[],attribute_buffers:function(){return _.flatten(this.sorted_sub_expressions().map(function(a){return a._attribute_buffers}))},uniforms:function(){return _.flatten(this.sorted_sub_expressions().map(function(a){return a._uniforms}))},find_if:function(a){return _.select(this.sorted_sub_expressions(),a)},replace_if:function(a,b){function f(a){var b=_.select(d,function(b){return a.guid===b[0].guid&&b[0].guid!==b[1].guid});return b.length===0?a:b[0][1]}function e(a){return _.some(d,function(b){return a.guid===b[0].guid&&b[0].guid!==b[1].guid})}var c=this.sorted_sub_expressions(),d=[];for(var g=0;g<c.length;++g){var h=c[g];if(a(h))d.push([h,b(h)]);else if(_.some(h.parents,e)){var i=[h,Shade._create(h,{parents:_.map(h.parents,f)})];d.push(i)}else d.push([h,h])}var j=d[d.length-1][1];return j}},Shade._create_concrete_exp=Shade._create_concrete(Shade.Exp,["parents","compile","type"]),Shade.ValueExp=Shade._create(Shade.Exp,{is_constant:Shade.memoize_on_field("_is_constant",function(){return _.all(this.parents,function(a){return a.is_constant()})}),_must_be_function_call:!1,eval:function(){return this._must_be_function_call?this.glsl_name+"()":this.children_count<=1?this.value():this.is_unconditional?this.precomputed_value_glsl_name:this.glsl_name+"()"},compile:function(a){this._must_be_function_call?this.is_unconditional?this.children_count>1?(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),a.add_initialization(this.precomputed_value_glsl_name+" = "+this.value()),a.value_function(this,this.precomputed_value_glsl_name)):a.value_function(this,this.value()):this.children_count>1?(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),this.has_precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(Shade.Types.bool_t.declare(this.has_precomputed_value_glsl_name),";\n"),a.add_initialization(this.has_precomputed_value_glsl_name+" = false"),a.value_function(this,"("+this.has_precomputed_value_glsl_name+"?"+this.precomputed_value_glsl_name+": (("+this.has_precomputed_value_glsl_name+"=true),("+this.precomputed_value_glsl_name+"="+this.value()+")))")):a.value_function(this,this.value()):this.is_unconditional?this.children_count>1&&(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),a.add_initialization(this.precomputed_value_glsl_name+" = "+this.value())):this.children_count>1&&(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),this.has_precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(Shade.Types.bool_t.declare(this.has_precomputed_value_glsl_name),";\n"),a.add_initialization(this.has_precomputed_value_glsl_name+" = false"),a.value_function(this,"("+this.has_precomputed_value_glsl_name+"?"+this.precomputed_value_glsl_name+": (("+this.has_precomputed_value_glsl_name+"=true),("+this.precomputed_value_glsl_name+"="+this.value()+")))"))}}),Shade._create_concrete_value_exp=Shade._create_concrete(Shade.ValueExp,["parents","type","value"]),Shade.swizzle=function(a,b){return Shade.make(a).swizzle(b)},Shade.constant=function(a,b){var c=function(a,b){function d(c){var d=a.array_size(),e=[];for(var f=0;f<d;++f)e.push(b[c+f*d]);return e}function c(a,b){return a+"("+_.toArray(b).join(", ")+")"}return Shade._create_concrete_exp({eval:function(a){return c(this.type.repr(),b)},expression_type:"constant{"+b+"}",is_constant:function(){return!0},element:Shade.memoize_on_field("_element",function(a){if(this.type.is_pod()){if(a===0)return this;throw"float is an atomic type, got this: "+a}return this.type.is_vec()?Shade.constant(b[a]):Shade.vec.apply(d(a))}),element_is_constant:function(a){return!0},element_constant_value:Shade.memoize_on_field("_element_constant_value",function(a){if(this.type.equals(Shade.Types.float_t)){if(a===0)return b[0];throw"float is an atomic type"}return this.type.is_vec()?b[a]:vec[this.type.array_size()].make(d(a))}),constant_value:Shade.memoize_on_field("_constant_value",function(){if(this.type.is_pod())return b[0];if(this.type.equals(Shade.Types.vec2)||this.type.equals(Shade.Types.vec3)||this.type.equals(Shade.Types.vec4))return vec[b.length].make(b);if(this.type.equals(Shade.Types.mat2)||this.type.equals(Shade.Types.mat3)||this.type.equals(Shade.Types.mat4))return mat[Math.sqrt(b.length)].make(b);throw"Internal Error: constant of unknown type"}),compile:function(a){},parents:[],type:a})},d=constant_type(a);if(d==="other"){d=typeOf(a);if(d==="array"){var e=a.map(Shade.make),f=e.length;if(f==0)throw"array constant must be non-empty";var g=Shade.array(e[0].type,f);return Shade._create_concrete_exp({parents:e,type:g,expression_type:"constant",eval:function(){return this.glsl_name},compile:function(a){this.array_initializer_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.glsl_name),";\n"),a.strings.push("void",this.array_initializer_glsl_name,"(void) {\n");for(var b=0;b<this.parents.length;++b)a.strings.push("    ",this.glsl_name,"[",b,"] =",this.parents[b].eval(),";\n");a.strings.push("}\n"),a.add_initialization(this.array_initializer_glsl_name+"()")},element:function(a){return this.parents[a]},element_is_constant:function(a){return this.parents[a].is_constant()},element_constant_value:function(a){return this.parents[a].constant_value()}})}throw"type error: constant should be bool, number, vector or matrix"}if(d==="number"){if(b&&!b.equals(Shade.Types.float_t)&&!b.equals(Shade.Types.int_t))throw"expected specified type for numbers to be float or int, got "+b.repr()+" instead.";return c(b||Shade.Types.float_t,[a])}if(d==="boolean"){if(b&&!b.equals(Shade.Types.bool_t))throw"boolean constants cannot be interpreted as "+b.repr();return c(Shade.Types.bool_t,[a])}if(d==="vector"){var h=a.length;if(h<2&&h>4)throw"Invalid length for constant vector: "+a;var i=_.map(a,function(a){return typeOf(a)});if(!_.all(i,function(a){return a===i[0]}))throw"Not all constant params have the same types;";if(i[0]==="number"){var j=Shade.basic("vec"+h);if(b&&!j.equals(b))throw"passed constant must have type "+j.repr()+", but was request to have incompatible type "+b.repr();return c(j,a)}throw"bad datatype for constant: "+i[0]}if(d==="boolean_vector"){var h=a.length,j=Shade.basic("bvec"+h);if(b&&!j.equals(b))throw"passed constant must have type "+j.repr()+", but was request to have incompatible type "+b.repr();return c(j,a)}if(d==="matrix"){var h=Math.sqrt(a.length),j=Shade.basic("mat"+h);if(b&&!j.equals(b))throw"passed constant must have type "+j.repr()+", but was request to have incompatible type "+b.repr();return c(j,a)}throw"type error: constant_type returned bogus value?"},Shade.as_int=function(a){return Shade.make(a).as_int()},Shade.as_bool=function(a){return Shade.make(a).as_bool()},Shade.as_float=function(a){return Shade.make(a).as_float()},Shade.set=function(a,b){a=Shade.make(a);var c=a.type;return Shade._create_concrete_exp({expression_type:"set",compile:function(a){if((b==="gl_FragColor"||b.substring(0,11)==="gl_FragData")&&a.compile_type!==Shade.FRAGMENT_PROGRAM_COMPILE)throw"gl_FragColor and gl_FragData assignment only allowed on fragment shaders";if((b==="gl_Position"||b==="gl_PointSize")&&a.compile_type!==Shade.VERTEX_PROGRAM_COMPILE)throw"gl_Position and gl_PointSize assignment only allowed on vertex shaders";if(a.compile_type!==Shade.VERTEX_PROGRAM_COMPILE&&b!=="gl_FragColor"&&b.substring(0,11)!=="gl_FragData")throw"The only allowed output variables on a fragment shader are gl_FragColor and gl_FragData[]";b!=="gl_FragColor"&&b!=="gl_Position"&&b!=="gl_PointSize"&&b.substring(0,11)!="gl_FragData"&&a.declare_varying(b,c),a.void_function(this,"(",b,"=",this.parents[0].eval(),")")},type:Shade.basic("void"),parents:[a]})},Shade.uniform=function(a,b){var c=[[Shade.Types.float_t,"uniform1f"],[Shade.Types.int_t,"uniform1i"],[Shade.Types.bool_t,"uniform1i"],[Shade.Types.sampler2D,"uniform1i"],[Shade.Types.vec2,"uniform2fv"],[Shade.Types.vec3,"uniform3fv"],[Shade.Types.vec4,"uniform4fv"],[Shade.Types.mat2,"uniformMatrix2fv"],[Shade.Types.mat3,"uniformMatrix3fv"],[Shade.Types.mat4,"uniformMatrix4fv"]],d=Shade.unique_name();if(typeof a=="undefined")throw"uniform requires type";typeof a=="string"&&(a=Shade.basic(a));var e,f=_.detect(c,function(b){return a.equals(b[0])});if(typeof f!="undefined")f=f[1];else throw"Unsupported type "+a.repr()+" for uniform.";var g=Shade._create_concrete_exp({parents:[],type:a,expression_type:"uniform",eval:function(){return this._must_be_function_call?this.glsl_name+"()":d},element:Shade.memoize_on_field("_element",function(a){if(this.type.is_pod()){if(a===0)return this;throw this.type.repr()+" is an atomic type"}return this.at(a)}),compile:function(a){a.declare_uniform(d,this.type),this._must_be_function_call&&(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),a.add_initialization(this.precomputed_value_glsl_name+" = "+d),a.value_function(this,this.precomputed_value_glsl_name))},set:function(a){var b=constant_type(a);b==="shade_expression"&&(a=a.constant_value()),e=a,this._facet_active_uniform&&this._facet_active_uniform(a)},get:function(a){return e},uniform_call:f,uniform_name:d});g._uniforms=[g],g.set(b);return g},Shade.sampler2D_from_texture=function(a){return a._shade_expression||function(){var b=Shade.uniform("sampler2D");b.set(a),a._shade_expression=b;return b}()},Shade.attribute_from_buffer=function(a){return a._shade_expression||function(){var b=[undefined,Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec3,Shade.Types.vec4],c=b[a.itemSize],d;typeof a._shade_name=="undefined"?(d=Shade.unique_name(),a._shade_name=d):d=a._shade_name;var e=Shade.attribute(d,c);e._attribute_buffers=[a],a._shade_expression=e;return e}()},Shade.attribute=function(a,b){if(typeof b=="undefined")throw"attribute requires type";typeof b=="string"&&(b=Shade.basic(b));return Shade._create_concrete_exp({parents:[],type:b,expression_type:"attribute",element:Shade.memoize_on_field("_element",function(a){if(this.type.equals(Shade.Types.float_t)){if(a===0)return this;throw"float is an atomic type"}return this.at(a)}),eval:function(){return this._must_be_function_call?this.glsl_name+"()":a},compile:function(b){b.declare_attribute(a,this.type),this._must_be_function_call&&(this.precomputed_value_glsl_name=b.request_fresh_glsl_name(),b.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),b.add_initialization(this.precomputed_value_glsl_name+" = "+a),b.value_function(this,this.precomputed_value_glsl_name))}})},Shade.varying=function(a,b){if(typeof b=="undefined")throw"varying requires type";typeof b=="string"&&(b=Shade.basic(b));return Shade._create_concrete_exp({parents:[],type:b,expression_type:"varying",element:Shade.memoize_on_field("_element",function(a){if(this.type.is_pod()){if(a===0)return this;throw this.type.repr()+" is an atomic type"}return this.at(a)}),eval:function(){return a},compile:function(b){b.declare_varying(a,this.type)}})},Shade.pointCoord=function(){return Shade._create_concrete_exp({expression_type:"builtin_input{gl_PointCoord}",parents:[],type:Shade.Types.vec2,eval:function(){return"gl_PointCoord"},compile:function(a){}})},function(){var a=function(b,c,d,e,f){var g=e(b.type,c.type);return Shade._create_concrete_value_exp({parents:[b,c],type:g,expression_type:"operator"+d,value:function(){return"("+this.parents[0].eval()+" "+d+" "+this.parents[1].eval()+")"},constant_value:Shade.memoize_on_field("_constant_value",function(){return f(this)}),element:Shade.memoize_on_field("_element",function(b){return a(this.parents[0].element(b),this.parents[1].element(b),d,e,f)}),element_constant_value:Shade.memoize_on_field("_element_constant_value",function(a){return this.element(a).constant_value()}),element_is_constant:Shade.memoize_on_field("_element_is_constant",function(a){return this.parents[0].element_is_constant(a)&&this.parents[1].element_is_constant(a)})})};Shade.add=function(){function d(a){var b=a.parents[0],c=a.parents[1],d;b.type.is_vec()?d=vec[b.type.vec_dimension()]:c.type.is_vec()&&(d=vec[c.type.vec_dimension()]);var e=b.constant_value(),f=c.constant_value();return b.type.equals(Shade.Types.int_t)&&c.type.equals(Shade.Types.int_t)?e+f:b.type.equals(Shade.Types.float_t)&&c.type.equals(Shade.Types.float_t)?e+f:c.type.equals(Shade.Types.float_t)?d.map(e,function(a){return a+f}):b.type.equals(Shade.Types.float_t)?d.map(f,function(a){return e+a}):d.plus(e,f)}function b(a,b){var c=[[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.float_t,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.float_t,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.float_t,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.int_t,Shade.Types.int_t,Shade.Types.int_t]];for(var d=0;d<c.length;++d)if(a.equals(c[d][0])&&b.equals(c[d][1]))return c[d][2];throw"type mismatch on add: unexpected types  '"+a.repr()+"' and '"+b.repr()+"'."}if(arguments.length===0)throw"add needs at least one argument";if(arguments.length===1)return arguments[0];var c=Shade.make(arguments[0]);for(var e=1;e<arguments.length;++e)c=a(c,Shade.make(arguments[e]),"+",b,d);return c},Shade.sub=function(){function c(a){var b=a.parents[0],c=a.parents[1],d;b.type.is_vec()?d=vec[b.type.vec_dimension()]:c.type.is_vec()&&(d=vec[c.type.vec_dimension()]);var e=b.constant_value(),f=c.constant_value();return b.type.equals(Shade.Types.int_t)&&c.type.equals(Shade.Types.int_t)?e-f:b.type.equals(Shade.Types.float_t)&&c.type.equals(Shade.Types.float_t)?e-f:c.type.equals(Shade.Types.float_t)?d.map(e,function(a){return a-f}):b.type.equals(Shade.Types.float_t)?d.map(f,function(a){return e-a}):d.minus(e,f)}function b(a,b){var c=[[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.float_t,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.float_t,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.float_t,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.int_t,Shade.Types.int_t,Shade.Types.int_t]];for(var d=0;d<c.length;++d)if(a.equals(c[d][0])&&b.equals(c[d][1]))return c[d][2];throw"type mismatch on sub: unexpected types  '"+a.repr()+"' and '"+b.repr()+"'."}if(arguments.length===0)throw"sub needs at least two arguments";if(arguments.length===1)throw"unary minus unimplemented";var d=Shade.make(arguments[0]);for(var e=1;e<arguments.length;++e)d=a(d,Shade.
make(arguments[e]),"-",b,c);return d},Shade.div=function(){function c(a){var b=a.parents[0],c=a.parents[1],d=b.constant_value(),e=c.constant_value(),f,g;b.type.is_array()?(f=vec[b.type.array_size()],g=mat[b.type.array_size()]):c.type.is_array()&&(f=vec[c.type.array_size()],g=mat[c.type.array_size()]);var h=constant_type(d),i=constant_type(e),j={number:{number:function(a,b){return a/b},vector:function(a,b){return f.map(b,function(b){return a/b})},matrix:function(a,b){return g.map(b,function(b){return a/b})}},vector:{number:function(a,b){return f.scaling(a,1/b)},vector:function(a,b){return f.map(b,function(b,c){return a[c]/b})},matrix:function(a,b){throw"internal error, can't eval vector/matrix"}},matrix:{number:function(a,b){return g.scaling(a,1/b)},vector:function(a,b){throw"internal error, can't eval matrix/vector"},matrix:function(a,b){throw"internal error, can't eval matrix/matrix"}}};return j[h][i](d,e)}function b(a,b){if(typeof a=="undefined")throw"t1 multiplication with undefined type?";if(typeof b=="undefined")throw"t2 multiplication with undefined type?";var c=[[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.float_t,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.float_t,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.float_t,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.mat2,Shade.Types.mat2]];for(var d=0;d<c.length;++d)if(a.equals(c[d][0])&&b.equals(c[d][1]))return c[d][2];throw"type mismatch on div: unexpected types  '"+a.repr()+"' and '"+b.repr()+"'."}if(arguments.length===0)throw"div needs at least two arguments";var d=Shade.make(arguments[0]);for(var e=1;e<arguments.length;++e)d=a(d,Shade.make(arguments[e]),"/",b,c);return d},Shade.mul=function(){function c(a){var b=a.parents[0],c=a.parents[1],d=b.constant_value(),e=c.constant_value(),f,g;b.type.is_array()?(f=vec[b.type.array_size()],g=mat[b.type.array_size()]):c.type.is_array()&&(f=vec[c.type.array_size()],g=mat[c.type.array_size()]);var h=constant_type(d),i=constant_type(e),j={number:{number:function(a,b){return a*b},vector:function(a,b){return f.scaling(b,a)},matrix:function(a,b){return g.scaling(b,a)}},vector:{number:function(a,b){return f.scaling(a,b)},vector:function(a,b){return f.schur_product(a,b)},matrix:function(a,b){return g.product_vec(g.transpose(b),a)}},matrix:{number:function(a,b){return g.scaling(a,b)},vector:function(a,b){return g.product_vec(a,b)},matrix:function(a,b){return g.product(a,b)}}};return j[h][i](d,e)}function b(a,b){if(typeof a=="undefined")throw"t1 multiplication with undefined type?";if(typeof b=="undefined")throw"t2 multiplication with undefined type?";var c=[[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.mat4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.vec4,Shade.Types.mat4,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.float_t,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.mat3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec3,Shade.Types.mat3,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.float_t,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.mat2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec2,Shade.Types.mat2,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.float_t,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.int_t,Shade.Types.int_t,Shade.Types.int_t]];for(var d=0;d<c.length;++d)if(a.equals(c[d][0])&&b.equals(c[d][1]))return c[d][2];throw"type mismatch on mul: unexpected types  '"+a.repr()+"' and '"+b.repr()+"'."}if(arguments.length===0)throw"mul needs at least one argument";if(arguments.length===1)return arguments[0];var d=Shade.make(arguments[0]);for(var e=1;e<arguments.length;++e)d=a(d,Shade.make(arguments[e]),"*",b,c);return d}}(),Shade.neg=function(a){return Shade.sub(0,a)},Shade.Exp.neg=function(){return Shade.neg(this)},Shade.vec=function(){var a=[],b=[],c=0,d;for(var e=0;e<arguments.length;++e){var f=Shade.make(arguments[e]);a.push(f),b.push(c);if(typeOf(d)==="undefined")d=f.type.element_type(0);else if(!d.equals(f.type.element_type(0)))throw"vec requires equal types";c+=f.type.size_for_vec_constructor()}b.push(c);if(c<1||c>4)throw"vec constructor requires resulting width to be between 1 and 4, got "+c+" instead.";var g;if(d.equals(Shade.Types.float_t))g=Shade.basic("vec"+c);else if(d.equals(Shade.Types.int_t))g=Shade.basic("ivec"+c);else if(d.equals(Shade.Types.bool_t))g=Shade.basic("bvec"+c);else throw"vec type must be bool, int, or float.";return Shade._create_concrete_value_exp({parents:a,parent_offsets:b,type:g,expression_type:"vec",size:c,element:function(a){var b=a;for(var d=0;d<this.parents.length;++d){var e=this.parent_offsets[d+1]-this.parent_offsets[d];if(a<e)return this.parents[d].element(a);a=a-e}throw"Element "+b+" out of bounds (size="+c+")"},element_is_constant:function(a){var b=a;for(var d=0;d<this.parents.length;++d){var e=this.parent_offsets[d+1]-this.parent_offsets[d];if(a<e)return this.parents[d].element_is_constant(a);a=a-e}throw"Element "+b+" out of bounds (size="+c+")"},element_constant_value:function(a){var b=a;for(var d=0;d<this.parents.length;++d){var e=this.parent_offsets[d+1]-this.parent_offsets[d];if(a<e)return this.parents[d].element_constant_value(a);a=a-e}throw"Element "+b+" out of bounds (size="+c+")"},constant_value:Shade.memoize_on_field("_constant_value",function(){var a=[],b=_.each(this.parents,function(b){var c=b.constant_value();if(typeOf(c)==="number")a.push(c);else for(var d=0;d<c.length;++d)a.push(c[d])});return vec[a.length].make(a)}),value:function(){return this.type.repr()+"("+this.parents.map(function(a){return a.eval()}).join(", ")+")"}})},Shade.mat=function(){var a=[],b=arguments.length,c;for(var d=0;d<arguments.length;++d){var e=arguments[d];a.push(e);if(d===0)c=e.type.size_for_vec_constructor();else if(c!==e.type.size_for_vec_constructor())throw"mat: all vecs must have same dimension"}if(c!==b)throw"non-square matrices currently not supported";if(b<1||b>4)throw"mat constructor requires resulting dimension to be between 2 and 4.";var f=Shade.basic("mat"+b);return Shade._create_concrete_value_exp({parents:a,type:f,expression_type:"mat",size:b,element:function(a){return this.parents[a]},element_is_constant:function(a){return this.parents[a].is_constant()},element_constant_value:function(a){return this.parents[a].constant_value()},constant_value:Shade.memoize_on_field("_constant_value",function(){var a=[],b=_.each(this.parents,function(b){b=b.constant_value();for(var c=0;c<b.length;++c)a.push(b[c])});return mat[this.type.array_size()].make(a)}),value:function(){return this.type.repr()+"("+this.parents.map(function(a){return a.eval()}).join(", ")+")"}})},Shade.mat3=function(a){var b=a.type;if(b.equals(Shade.Types.mat2))return Shade.mat(Shade.vec(a.at(0),0),Shade.vec(a.at(1),0),Shade.vec(0,0,1));if(b.equals(Shade.Types.mat3))return a;if(b.equals(Shade.Types.mat4))return Shade.mat(a.element(0).swizzle("xyz"),a.element(1).swizzle("xyz"),a.element(2).swizzle("xyz"));throw"mat3: need matrix to convert to mat3"},Shade.per_vertex=function(a){a=Shade.make(a);return Shade._create_concrete_exp({expression_name:"per_vertex",parents:[a],type:a.type,stage:"vertex",eval:function(){return this.parents[0].eval()},compile:function(){}})},function(){function n(c){function d(a,b,c){return(1-c)*a+c*b}var e=c.parents[0],f=c.parents[1],g=c.parents[2],h=e.constant_value(),i=f.constant_value(),j=g.constant_value();return e.type.equals(Shade.Types.float_t)?d(h,i,j):f.type.equals(g.type)?vec.make(b(d,h,i,j)):vec.make(a(function(a,b){return d(a,b,j)},h,i))}function l(a){function c(a,b,c){return Math.max(b,Math.min(c,a))}var d=a.parents[0],e=a.parents[1],f=a.parents[2],g=d.constant_value(),h=e.constant_value(),i=f.constant_value();return d.type.equals(Shade.Types.float_t)?c(g,h,i):d.type.equals(e.type)?vec.make(b(c,g,h,i)):vec.map(g,function(a){return c(a,h,i)})}function k(b){return function(c){var d=_.map(c.parents,function(a){return a.constant_value()});return c.parents[0].type.equals(Shade.Types.float_t)?b.apply(b,d):c.parents[0].type.equals(Shade.Types.int_t)?b.apply(b,d):c.parents[0].type.equals(c.parents[1].type)?vec.make(a(b,d[0],d[1])):vec.map(d[0],function(a){return b(a,d[1])})}}function j(){if(arguments.length==1)return e("atan",h)(arguments[0]);if(arguments.length==2){var a=i(Math.atan2);return f("atan",a)(arguments[0],arguments[1])}throw"atan expects 1 or 2 parameters, got "+arguments.length+" instead."}function i(a){return function(b){var c=b.parents[0].constant_value(),d=b.parents[1].constant_value();if(b.type.equals(Shade.Types.float_t))return a(c,d);var e=[];for(var f=0;f<c.length;++f)e.push(a(c[f],d[f]));return vec.make(e)}}function h(a){var b=a.parents[0].constant_value();return a.type.equals(Shade.Types.float_t)?Math.atan(b):vec.map(c,Math.atan)}function f(a,b){return d(a,[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4]],b)}function e(a,b){return d(a,[[Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4]],b)}function d(a,b,c){function g(a){var b=a[0].length-1;return function(){if(arguments.length!=b)throw"expected "+b+" arguments, got "+arguments.length+" instead.";for(var c=0;c<a.length;++c){var d=a[c],e=!0;for(var f=0;f<b;++f)if(!d[f].equals(arguments[f].type)){e=!1;break}if(e)return d[b]}var g=_.map(_.toArray(arguments).slice(0,arguments.length),function(a){return a.type.repr()}).join(", ");throw"Could not find appropriate type match for ("+g+")"}}for(var d=0;d<b.length;++d)for(var e=0;e<b[d].length;++e){var f=b[d][e];if(typeof f=="undefined")throw"undefined type in type_resolver"}var h=g(b);return c?function(){var b,d=[];for(var e=0;e<arguments.length;++e)d.push(Shade.make(arguments[e]));try{b=h.apply(this,d)}catch(f){throw"type error on "+a+": "+f}return Shade._create_concrete_value_exp({parents:d,type:b,expression_type:"builtin_function{"+a+"}",value:function(){return[a,"(",this.parents.map(function(a){return a.eval()}).join(", "),")"].join(" ")},constant_value:Shade.memoize_on_field("_constant_value",function(){return c(this)})})}:function(){var b,c=[];for(var d=0;d<arguments.length;++d)c.push(Shade.make(arguments[d]));try{b=h.apply(this,c)}catch(e){throw"type error on "+a+": "+e}return Shade._create_concrete_value_exp({parents:c,expression_type:"builtin_function{"+a+"}",type:b,value:function(){return[a,"(",this.parents.map(function(a){return a.eval()}).join(", "),")"].join(" ")},is_constant:function(){return!1}})}}var g={radians:function(a){return a*Math.PI/180},degrees:function(a){return a/Math.PI*180},sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,abs:Math.abs,sign:function(a){return a<0?-1:a===0?0:1},floor:Math.floor,ceil:Math.ceil,fract:function(a){return a-Math.floor(a)},exp:Math.exp,log:Math.log,exp2:function(a){return Math.exp(a*Math.log(a,2))},log2:function(a){return Math.log(a)/Math.log(2)},sqrt:Math.sqrt,inversesqrt:function(a){return 1/Math.sqrt(a)}};_.each(g,function(a,b){function c(b){if(b.type.equals(Shade.Types.float_t))return a(b.parents[0].constant_value());var c=b.parents[0].constant_value();return vec.map(c,a)}Shade[b]=e(b,c),Shade.Exp[b]=function(a){return function(){return a(this)}}(Shade[b])}),Shade.atan=j,Shade.Exp.atan=function(){return Shade.atan(this)},Shade.pow=f("pow",i(Math.pow)),_.each({mod:function(a,b){return a%b},min:Math.min,max:Math.max},function(a,b){Shade[b]=d(b,[[Shade.Types.int_t,Shade.Types.int_t,Shade.Types.int_t],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4]],k(a))});var m=d("clamp",[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec4]],l);Shade.clamp=m;var o=d("mix",[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4]],n);Shade.mix=o;var p=d("step",[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4]],function(b){function c(a,b){return b<a?0:1}var d=b.parents[0],e=b.parents[1],f=d.constant_value(),g=e.constant_value();return e.type.equals(Shade.Types.float_t)?c(f,g):d.type.equals(e.type)?vec.make(a(c,f,g)):vec.map(g,function(a){return c(f,a)})});Shade.step=p;var q=d("smoothstep",[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4]],function(a){var b=a.parents[0],c=a.parents[1],d=a.parents[2],e=Shade.clamp(d.sub(b).div(c.sub(b)),0,1);return e.mul(e).mul(Shade.sub(3,e.mul(2))).constant_value()});Shade.smoothstep=q;var r=d("length",[[Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t]],function(a){var b=a.parents[0].constant_value();return a.parents[0].type.equals(Shade.Types.float_t)?b*b:vec.length(b)});Shade.length=r;var s=d("distance",[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.float_t]],function(a){return a.parents[0].sub(a.parents[1]).length().constant_value()});Shade.distance=s;var t=d("dot",[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.float_t]],function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return a.parents[0].type.equals(Shade.Types.float_t)?b*c:vec.dot(b,c)});Shade.dot=t;var u=d("cross",[[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3]],function(a){return vec3.cross(a.parents[0].constant_value(),a.parents[1].constant_value())});Shade.cross=u;var v=d("normalize",[[Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4]],function(a){return a.parents[0].div(a.parents[0].length()).constant_value()});Shade.normalize=v;var w=d("faceforward",[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4]],function(a){var b=a.parents[0],c=a.parents[1],d=a.parents[2];return d.dot(c).constant_value()<0?b.constant_value():Shade.sub(0,b).constant_value()});Shade.faceforward=w;var x=d("reflect",[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4]],function(a){var b=a.parents[0],c=a.parents[1];return b.sub(Shade.mul(2,c.dot(b),c)).constant_value()});Shade.reflect=x;var y=d("refract",[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4]],function(a){var b=a.parents[0],c=a.parents[1],d=a.parents[2],e=Shade.sub(1,Shade.mul(d,d,Shade.sub(1,c.dot(b).mul(c.dot(b)))));return e.constant_value()<0?Vector.Zero(b.type.array_size()):d.mul(b).sub(d.mul(c.dot(b)).add(e.sqrt()).mul(c)).constant_value()});Shade.refract=y;var z=d("texture2D",[[Shade.Types.sampler2D,Shade.Types.vec2,Shade.Types.vec4]]);Shade.texture2D=z,Shade.equal=d("equal",[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bool_t],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bool_t],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bool_t],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bool_t],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bool_t],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bool_t],[Shade.Types.bvec2,Shade.Types.bvec2,Shade.Types.bool_t],[Shade.Types.bvec3,Shade.Types.bvec3,Shade.Types.bool_t],[Shade.Types.bvec4,Shade.Types.bvec4,Shade.Types.bool_t]],function(b){var c=b.parents[0].constant_value(),d=b.parents[1].constant_value();return _.all(a(function(a,b){return a===b}),c,d)}),Shade.Exp.equal=function(a){return Shade.equal(this,a)},Shade.notEqual=d("notEqual",[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bool_t],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bool_t],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bool_t],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bool_t],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bool_t],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bool_t],[Shade.Types.bvec2,Shade.Types.bvec2,Shade.Types.bool_t],[Shade.Types.bvec3,Shade.Types.bvec3,Shade.Types.bool_t],[Shade.Types.bvec4,Shade.Types.bvec4,Shade.Types.bool_t]],function(b){var c=b.parents[0].constant_value(),d=b.parents[1].constant_value();return!_.all(a(function(a,b){return a===b}),c,d)}),Shade.Exp.notEqual=function(a){return Shade.notEqual(this,a)},Shade.lessThan=d("lessThan",[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bvec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bvec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bvec4],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bvec2],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bvec3],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bvec4]],function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return _.map(b,function(a,b){return a<c[b]})}),Shade.Exp.lessThan=function(a){return Shade.lessThan(this,a)},Shade.lessThanEqual=d("lessThanEqual",[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bvec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bvec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bvec4],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bvec2],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bvec3],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bvec4]],function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return _.map(b,function(a,b){return a<=c[b]})}),Shade.Exp.lessThanEqual=function(a){return Shade.lessThanEqual(this,a)},Shade.greaterThan=d("greaterThan",[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bvec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bvec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bvec4],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bvec2],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bvec3],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bvec4]],function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return _.map(b,function(a,b){return a>c[b]})}),Shade.Exp.greaterThan=function(a){return Shade.greaterThan(this,a)},Shade.greaterThanEqual=d("greaterThanEqual",[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bvec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bvec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bvec4],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bvec2],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bvec3],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bvec4]],function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return _.map(b,function(a,b){return a>=c[b]})}),Shade.Exp.greaterThanEqual=function(a){return Shade.greaterThanEqual(this,a)},Shade.all=d("all",[[Shade.Types.bvec2,Shade.Types.bool_t],[Shade.Types.bvec3,Shade.Types.bool_t],[Shade.Types.bvec4,Shade.Types.bool_t]],function(a){var b=a.parents[0].constant_value();return _.all(b,function(a){return a})}),Shade.Exp.all=function(){return Shade.all(this)},Shade.any=d("any",[[Shade.Types.bvec2,Shade.Types.bool_t],[Shade.Types.bvec3,Shade.Types.bool_t],[Shade.Types.bvec4,Shade.Types.bool_t]],function(a){var b=a.parents[0].constant_value();return _.any(b,function(a){return a})}),Shade.Exp.any=function(){return Shade.any(this)},Shade.matrixCompMult=d("matrixCompMult",[[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4]],function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return mat.map(b,function(a,b){return a*c[b]})}),Shade.Exp.matrixCompMult=function(a){return Shade.matrixCompMult(this,a)}}(),Shade.seq=function(a){return a.length==1?a[0]:Shade._create_concrete_exp({expression_name:"seq",parents:a,eval:function(a){return this.parents.map(function(a){return a.eval()}).join("; ")},type:Shade.basic("void"),compile:function(a){}})},Shade.Optimizer={},Shade.Optimizer.transform_expression=function(a){return function(b){for(var c=0;c<a.length;++c){var d=a[c][0],e=a[c][1];if(a[c][2]){var f;do f=b.guid,b=b.replace_if(d,e);while(b.guid!==f)}else b=b.replace_if(d,e)}return b}},Shade.Optimizer.is_constant=function(a){return a.is_constant()},Shade.Optimizer.replace_with_constant=function(a){var b=a.constant_value(),c=Shade.constant(b,a.type);return c},Shade.Optimizer.is_zero=function(a){if(!a.is_constant())return!1;var b=a.constant_value(),c=constant_type(b);return c==="number"?b===0:c==="vector"?_.all(b,function(a){return a===0}):typeof b=="matrix"?_.all(b,function(a){return a===0}):!1},Shade.Optimizer.is_mul_identity=function(a){if(!a.is_constant())return!1;var b=a.constant_value(),c=constant_type(b);if(c==="number")return b===1;if(c==="vector")switch(b.length){case 2:return vec.equal(b,vec.make([1,1]));case 3:return vec.equal(b,vec.make([1,1,1]));case 4:return vec.equal(b,vec.make([1,1,1,1]));default:throw"Bad vec length: "+b.length}return c==="matrix"?mat.equal(b,mat[Math.sqrt(b.length)].identity()):!1},Shade.Optimizer.is_times_zero=function(a){return a.expression_type==="operator*"&&(Shade.Optimizer.is_zero(a.parents[0])||Shade.Optimizer.is_zero(a.parents[1]))},Shade.Optimizer.is_plus_zero=function(a){return a.expression_type==="operator+"&&(Shade.Optimizer.is_zero(a.parents[0])||Shade.Optimizer.is_zero(a.parents[1]))},Shade.Optimizer.replace_with_nonzero=function(a){if(Shade.Optimizer.is_zero(a.parents[0]))return a.parents[1];if(Shade.Optimizer.is_zero(a.parents[1]))return a.parents[0];throw"no zero value on input to replace_with_nonzero?!"},Shade.Optimizer.is_times_one=function(a){if(a.expression_type!=="operator*")return!1;var b=a.parents[0].type,c=a.parents[1].type,d=Shade.Types.float_t;if(b.equals(c))return Shade.Optimizer.is_mul_identity(a.parents[0])||Shade.Optimizer.is_mul_identity(a.parents[1]);if(!b.equals(d)&&c.equals(d))return Shade.Optimizer.is_mul_identity(a.parents[1]);if(b.equals(d)&&!c.equals(d))return Shade.Optimizer.is_mul_identity(a.parents[0]);if(b.is_vec()&&c.is_mat())return Shade.Optimizer.is_mul_identity(a.parents[1]);if(b.is_mat()&&c.is_vec())return Shade.Optimizer.is_mul_identity(a.parents[0]);throw"Internal error, never should have gotten here"},Shade.Optimizer.replace_with_notone=function(a){var b=a.parents[0].type,c=a.parents[1].type,d=Shade.Types.float_t;if(b.equals(c)){if(Shade.Optimizer.is_mul_identity(a.parents[0]))return a.parents[1];if(Shade.Optimizer.is_mul_identity(a.parents[1]))return a.parents[0];throw"Intenal error, never should have gotten here"}if(!b.equals(d)&&c.equals(d))return a.parents[0];if(b.equals(d)&&!c.equals(d))return a.parents[1];throw"no is_mul_identity value on input to replace_with_notone?!"},Shade.Optimizer.replace_with_zero=function(a){if(a.type.equals(Shade.Types.float_t))return Shade.constant(0);if(a.type.equals(Shade.Types.int_t))return Shade.as_int(0);if(a.type.equals(Shade.Types.vec2))return Shade.constant(vec2.create());if(a.type.equals(Shade.Types.vec3))return Shade.constant(vec3.create());if(a.type.equals(Shade.Types.vec4))return Shade.constant(vec4.create());if(a.type.equals(Shade.Types.mat2))return Shade.constant(mat2.create());if(a.type.equals(Shade.Types.mat3))return Shade.constant(mat3.create());if(a.type.equals(Shade.Types.mat4))return Shade.constant(mat4.create());throw"not a type replaceable with zero!?"},Shade.Optimizer.vec_at_constant_index=function(a){if(a.expression_type!=="index")return!1;if(!a.parents[1].is_constant())return!1;var b=a.parents[1].constant_value();if(typeOf(b)!=="number")return!1;var c=a.parents[0].type;return c.equals(Shade.Types.vec2)&&b>=0&&b<=1?!0:c.equals(Shade.Types.vec3)&&b>=0&&b<=2?!0:c.equals(Shade.Types.vec4)&&b>=0&&b<=3?!0:!1},Shade.Optimizer.replace_vec_at_constant_with_swizzle=function(a){var b=a.parents[1].constant_value();if(b==0)return a.parents[0].swizzle("x");if(b==1)return a.parents[0].swizzle("y");if(b==2)return a.parents[0].swizzle("z");if(b==3)return a.parents[0].swizzle("w");throw"Internal error, shouldn't get here"},Shade.program=function(a){function l(a){var c=Shade.unique_name();b[c]=a,k.push(c);return Shade.varying(c,a.type)}function j(a){return a.stage==="vertex"}function i(a){return a.expression_type==="varying"}function h(a){return a.expression_type==="attribute"}var b={},c={};_.each(a,function(a,d){d==="color"||d==="gl_FragColor"?c.gl_FragColor=Shade.make(a):d==="position"?b.gl_Position=Shade.make(a):d==="point_size"?b.gl_PointSize=Shade.make(a):b[d]=Shade.make(a)});var d=Shade.CompilationContext(Shade.VERTEX_PROGRAM_COMPILE),e=Shade.CompilationContext(Shade.FRAGMENT_PROGRAM_COMPILE),f=[],g=[],k=[],m=Shade.Optimizer.transform_expression([[j,l],[h,l],[Shade.Optimizer.is_times_zero,Shade.Optimizer.replace_with_zero,!0],[Shade.Optimizer.is_times_one,Shade.Optimizer.replace_with_notone,!0],[Shade.Optimizer.is_plus_zero,Shade.Optimizer.replace_with_nonzero,!0],[Shade.Optimizer.vec_at_constant_index,Shade.Optimizer.replace_vec_at_constant_with_swizzle,!1],[Shade.Optimizer.is_constant,Shade.Optimizer.replace_with_constant]]),n=Shade.Optimizer.transform_expression([[Shade.Optimizer.is_times_zero,Shade.Optimizer.replace_with_zero,!0],[Shade.Optimizer.is_times_one,Shade.Optimizer.replace_with_notone,!0],[Shade.Optimizer.is_plus_zero,Shade.Optimizer.replace_with_nonzero,!0],[Shade.Optimizer.vec_at_constant_index,Shade.Optimizer.replace_vec_at_constant_with_swizzle,!1],[Shade.Optimizer.is_constant,Shade.Optimizer.replace_with_constant]]),o=[];_.each(c,function(a,b){a=m(a),o.push.apply(o,_.map(a.find_if(i),function(a){return a.eval()})),g.push(Shade.set(a,b))}),_.each(b,function(a,b){(k.indexOf(b)===-1||o.indexOf(b)!==-1)&&f.push(Shade.set(n(a),b))});var p=Shade.seq(f),q=Shade.seq(g);d.compile(p),e.compile(q);var r=d.source(),s=e.source();Shade.debug&&(console.log("Vertex program final AST:"),p.debug_print(),console.log("Vertex program source:"),console.log(r),console.log("Fragment program final AST:"),q.debug_print(),console.log("Fragment program source:"),console.log(s));var t=Facet.program(r,s);t.attribute_buffers=p.attribute_buffers(),t.uniforms=_.union(p.uniforms(),q.uniforms());return t},Shade.is_program_parameter=function(a){return["color","position","point_size","gl_FragColor","gl_Position","gl_PointSize"].indexOf(a)!=-1},Shade.Utils={},Shade.Utils.lerp=function(a){var b=_.toArray(a);b.push(b[b.length-1]);return function(a){var c=Shade.constant(b);a=Shade.clamp(a,0,1).mul(b.length-2);var d=a.fract(),e=a.floor();return Shade.mix(c.at(e),c.at(e.add(1)),d)}},Shade.Utils.choose=function(a){var b=_.toArray(a);return function(a){var c=Shade.constant(b);a=Shade.clamp(a,0,b.length-1).floor().as_int();return c.at(a)}},Shade.Utils.linear=function(a,b,c,d){var e=Shade.sub(b,a),f=Shade.sub(d,c);return function(b){return Shade.make(b).sub(a).mul(f.div(e)).add(c)}},Shade.Utils.fit=function(a){var b=a._shade_type;b==="attribute_buffer"&&(a=a.array);var c=_.min(a),d=_.max(a);return Shade.Utils.linear(c,d,0,1)},Shade.gl_light=function(a){var b=a.light_position,c=a.vertex,d=a.material_color,e=a.light_ambient||Shade.vec(0,0,0,1),f=a.light_diffuse||Shade.vec(1,1,1,1),g=a.per_vertex||!1,h=a.normal,i=b.sub(c).normalize(),j=Shade.max(i.dot(h),0);g&&(j=Shade.per_vertex(j));return Shade.add(e.mul(d),j.mul(f).mul(d))},function(){var a=Shade.vec(0,0,0,0);Shade.gl_fog=function(b){b=_.defaults(b,{mode:"exp",density:1,start:0,end:1,fog_color:a,per_vertex:!1});var c=b.mode||"exp",d=Shade.make(b.fog_color),e=b.color,f=Shade.make(b.z),g;if(b.mode==="exp"){var h=Shade.make(b.density),i=Shade.make(b.start);g=f.sub(i).mul(h).exp()}else if(c==="exp2"){var h=Shade.make(b.density),i=Shade.make(b.start);g=f.sub(i).min(0).mul(h),g=g.mul(g),g=g.neg().exp()}else if(c==="linear"){var i=Shade.make(b.start),j=Shade.make(b.end);j=Shade.make(j),i=Shade.make(i),g=j.sub(f).div(j.sub(i))}g=g.clamp(0,1),b.per_vertex&&(g=g.per_vertex());return Shade.mix(d,e,g)}}(),Shade.cosh=function(a){return Shade.exp(a).add(a.neg().exp()).div(2)},Shade.Exp.cosh=function(){return Shade.cosh(this)},Shade.sinh=function(a){return Shade.exp(a).sub(a.neg().exp()).div(2)},Shade.Exp.sinh=function(){return Shade.sinh(this)},function(){var b=function(a,b,c,d,e){e=e||function(a){return!0};return Shade._create_concrete_value_exp({parents:[a,b],type:Shade.Types.bool_t,expression_type:"operator"+c,value:function(){return"("+this.parents[0].eval()+" "+c+" "+this.parents[1].eval()+")"},constant_value
:Shade.memoize_on_field("_constant_value",function(){return d(this)}),parent_is_unconditional:e})},c=function(a){return function(b){var c=b.parents[0],d=b.parents[1];return a(c.constant_value(),d.constant_value())}},d=function(a,c,d){return function(){if(arguments.length===0)return Shade.constant(!1);if(arguments.length===1)return Shade.make(arguments[1]).as_bool();var e=Shade.make(arguments[0]);if(!e.type.equals(Shade.Types.bool_t))throw"operator "+a+" requires booleans, got argument 1 as "+arguments[0].type.repr()+" instead.";var f=e;for(var g=1;g<arguments.length;++g){var h=Shade.make(arguments[g]);if(!h.type.equals(Shade.Types.bool_t))throw"operator "+a+" requires booleans, got argument "+(g+1)+" as "+h.type.repr()+" instead.";f=b(f,h,a,c,d)}return f}};Shade.or=d("||",c(function(a,b){return a||b}),function(a){return a==0}),Shade.Exp.or=function(a){return Shade.or(this,a)},Shade.and=d("&&",c(function(a,b){return a&&b}),function(a){return a==0}),Shade.Exp.and=function(a){return Shade.and(this,a)},Shade.xor=d("^^",c(function(a,b){return~~(a^b)})),Shade.Exp.xor=function(a){return Shade.xor(this,a)},Shade.not=function(a){a=Shade.make(a);if(!a.type.equals(Shade.Types.bool_t))throw"logical_not requires bool expression";return Shade._create_concrete_value_exp({parents:[a],type:Shade.Types.bool_t,expression_type:"operator!",value:function(){return"(!"+this.parents[0].eval()+")"},constant_value:Shade.memoize_on_field("_constant_value",function(){return!this.parents[0].constant_value()})})},Shade.Exp.not=function(){return Shade.not(this)};var e=function(a,c,d){return function(e,f){var g=Shade.make(e),h=Shade.make(f);c(g.type,h.type);return b(g,h,a,d)}},f=function(a){return function(b,c){if((!b.equals(Shade.Types.float_t)||!c.equals(Shade.Types.float_t))&&(!b.equals(Shade.Types.int_t)||!c.equals(Shade.Types.int_t)))throw"operator"+a+" requires two ints or two floats, got "+b.repr()+" and "+c.repr()+" instead."}},g=function(a){return function(b,c){if(!b.equals(c))throw"operator"+a+" requires same types, got "+b.repr()+" and "+c.repr()+" instead.";if(b.is_array()&&!b.is_vec())throw"operator"+a+" does not support arrays"}};Shade.lt=e("<",f("<"),c(function(a,b){return a<b})),Shade.Exp.lt=function(a){return Shade.lt(this,a)},Shade.le=e("<=",f("<="),c(function(a,b){return a<=b})),Shade.Exp.le=function(a){return Shade.le(this,a)},Shade.gt=e(">",f(">"),c(function(a,b){return a>b})),Shade.Exp.gt=function(a){return Shade.gt(this,a)},Shade.ge=e(">=",f(">="),c(function(a,b){return a>=b})),Shade.Exp.ge=function(a){return Shade.ge(this,a)},Shade.eq=e("==",g("=="),c(function(b,c){if(typeOf(b)==="number"||typeOf(b)==="boolean")return b===c;if(typeOf(b)==="array")return _.all(a(function(a,b){return a===b},b,c),function(a){return a});if(constant_type(b)==="vector"||constant_type(b)==="matrix")return b.eql(c);throw"internal error: Unrecognized type "+typeOf(b)+" "+constant_type(b)})),Shade.Exp.eq=function(a){return Shade.eq(this,a)},Shade.ne=e("!=",g("!="),c(function(b,c){if(typeOf(b)==="number"||typeOf(b)==="boolean")return b!==c;if(typeOf(b)==="array")return _.any(a(function(a,b){return a!==b},b,c),function(a){return a});if(constant_type(b)==="vector"||constant_type(b)==="matrix")return!b.eql(c);throw"internal error: Unrecognized type "+typeOf(b)+" "+constant_type(b)})),Shade.Exp.ne=function(a){return Shade.ne(this,a)}}(),Shade.selection=function(a,b,c){a=Shade.make(a),b=Shade.make(b),c=Shade.make(c);if(!b.type.equals(c.type))throw"selection return expressions must have same types";if(!a.type.equals(a.type))throw"selection condition must be of type bool";return Shade._create_concrete_value_exp({parents:[a,b,c],type:b.type,expression_type:"selection",value:function(){return"("+this.parents[0].eval()+"?"+this.parents[1].eval()+":"+this.parents[2].eval()+")"},constant_value:function(){return this.parents[0].constant_value()?this.parents[1].constant_value():this.parents[2].constant_value()},parent_is_unconditional:function(a){return a===0}})},Shade.Exp.selection=function(a,b){return Shade.selection(this,a,b)},Shade.rotation=function(a,b){a=Shade.make(a),b=Shade.make(b).normalize();var c=a.sin(),d=a.cos(),e=Shade.sub(1,d),f=b.at(0),g=b.at(1),h=b.at(2);return Shade.mat(Shade.vec(f.mul(f).mul(e).add(d),g.mul(f).mul(e).add(h.mul(c)),h.mul(f).mul(e).sub(g.mul(c)),0),Shade.vec(f.mul(g).mul(e).sub(h.mul(c)),g.mul(g).mul(e).add(d),h.mul(g).mul(e).add(f.mul(c)),0),Shade.vec(f.mul(h).mul(e).add(g.mul(c)),g.mul(h).mul(e).sub(f.mul(c)),h.mul(h).mul(e).add(d),0),Shade.vec(0,0,0,1))},Shade.translation=function(a){return Shade.mat(Shade.vec(1,0,0,0),Shade.vec(0,1,0,0),Shade.vec(0,0,1,0),Shade.vec(a,1))},Shade.look_at=function(a,b,c){a=Shade.make(a),b=Shade.make(b),c=Shade.make(c);var d=a.sub(b).normalize(),e=c.cross(d).normalize(),f=d.cross(e).normalize();return Shade.mat(Shade.vec(e,0),Shade.vec(f,0),Shade.vec(d,0),Shade.vec(e.dot(a).neg(),f.dot(a).neg(),d.dot(a).neg(),1))},Shade.discard_if=function(a,b){a=Shade.make(a),b=Shade.make(b);var c=Shade._create_concrete_exp({is_constant:Shade.memoize_on_field("_is_constant",function(){var a=_.all(this.parents,function(a){return a.is_constant()});return a&&!this.parents[1].constant_value()}),_must_be_function_call:!0,type:a.type,parents:[b,a],parent_is_unconditional:function(a){return a===0},compile:function(b){b.strings.push(a.type.repr(),this.glsl_name,"(void) {\n","    if (",this.parents[0].eval(),") discard;\n","    return ",this.parents[1].eval(),";\n}\n")},constant_value:function(){return a.constant_value()}});return c},Shade.id=function(a){var b=a&255,c=a>>8&255,d=a>>16&255,e=a>>24&255;return vec4.make([b/255,c/255,d/255,e/255])};return Shade})(),Facet.Marks={},Facet.Marks.dots=function(a){function b(a){return a.mul(2).sub(1)}a=_.defaults(a,{x_scale:function(a){return a},y_scale:function(a){return a},xy_scale:function(a){return a},fill_color:Shade.vec(0,0,0,1),stroke_color:Shade.vec(0,0,0,1),point_diameter:5,stroke_width:2,mode:Facet.DrawingMode.over,alpha:!0,plain:!1});var c=Shade,d=Shade.make(a.fill_color),e=Shade.make(a.stroke_color),f=Shade.make(a.point_diameter),g=Shade.make(a.stroke_width).add(1),h=Shade.make(a.alpha),i=a.x_scale,j=a.y_scale,k={type:"points"};a.x?k.vertex=c.vec(b(a.x_scale(a.x)),b(a.y_scale(a.y))):a.xy&&(k.vertex=a.xy_scale(a.xy).mul(2).sub(c.vec(1,1))),a.model?k.elements=a.model.elements:a.elements&&(k.elements=a.elements);var l=Facet.model(k),m=c.pointCoord().sub(c.vec(.5,.5)).length().mul(f),n=f.div(2),o=n.sub(m),p=c.vec(l.vertex,0,1),q=c.mix(d,e,c.clamp(g.sub(o),0,1));if(a.plain){var r=Facet.bake(l,{position:p,point_size:f,color:d,mode:a.mode});r.gl_Position=p;return r}var r=Facet.bake(l,{position:p,point_size:f,color:c.selection(h,q.mul(c.vec(1,1,1,c.clamp(o,0,1))),q).discard_if(m.gt(n)),mode:a.mode});r.gl_Position=p;return r},Facet.Marks.globe=function(a){a=_.defaults(a||{},{longitude_center:-98,latitude_center:38,zoom:3});var b=Facet._globals.ctx,c=!1,d=!1,e,f=[0,0],g,h,i,j,k=spherical_mercator_patch(40),l=Shade.uniform("mat4"),m=Facet.texture_from_image({width:2048,height:2048,TEXTURE_MAG_FILTER:b.LINEAR,TEXTURE_MIN_FILTER:b.LINEAR});g=Shade.uniform("float"),h=Shade.uniform("float"),i=Shade.uniform("float"),j=Shade.uniform("float");var n=Shade.vec(g,i),o=Shade.vec(h,j),p=Shade.uniform("sampler2D",m),q=Facet.bake(k,{gl_Position:a.view_proj.mul(l).mul(k.vertex(n,o)),gl_FragColor:Shade.texture2D(p,k.transformed_uv(n,o))});for(var r=0;r<8;++r)for(var s=0;s<8;++s)Facet.load_image_into_texture({texture:m,src:"http://tile.openstreetmap.org/3/"+r+"/"+s+".png",crossOrigin:"anonymous",x_offset:(r+4)%8*256,y_offset:2048-(s+1)*256,onload:function(){b.display()}});return{longitude_center:a.longitude_center,latitude_center:a.latitude_center,zoom:a.zoom,model_matrix:l,mousedown:function(a){e=[a.offsetX,a.offsetY],f=[0,0]},mousemove:function(a){a.which&1&&!a.shiftKey&&(d=!0,this.longitude_center-=(a.offsetX-e[0])/(3.3*this.zoom),this.latitude_center+=(a.offsetY-e[1])/(4.4*this.zoom),this.latitude_center=Math.max(Math.min(80,this.latitude_center),-80)),a.which&1&&a.shiftKey&&(c=!0,this.zoom*=1+(a.offsetY-e[1])/240),e=[a.offsetX,a.offsetY],b.display()},mouseup:function(a){var g=this;if(d){f[0]=-(a.offsetX-e[0])/(3.3*g.zoom),f[1]=(a.offsetY-e[1])/(4.4*g.zoom),e=[a.offsetX,a.offsetY];var h=function(){b.display(),g.longitude_center+=f[0],g.latitude_center+=f[1],g.latitude_center=Math.max(Math.min(80,g.latitude_center),-80),f[0]*=.95,f[1]*=.95,Math.max(Math.abs(f[0]),Math.abs(f[1]))>.01&&window.requestAnimFrame(h,g.canvas)};h()}d=c=!1},draw:function(){while(this.longitude_center<0)this.longitude_center+=360;while(this.longitude_center>360)this.longitude_center-=360;var a=Facet.rotation(this.latitude_center*(Math.PI/180),[1,0,0]),c=Facet.rotation(this.longitude_center*(Math.PI/180),[0,-1,0]);b.enable(b.DEPTH_TEST),b.depthFunc(b.LESS),this.model_matrix.set(mat4.product(a,c));var d=latlong_to_mercator(this.latitude_center,this.longitude_center),e=Math.PI*Math.min(1,1/(this.zoom*Math.cos(this.latitude_center/180*Math.PI))),f=d[0]-e,k=d[0]+e;while(f>Math.PI*2)f-=Math.PI*2,k-=Math.PI*2;i.set(d[1]-e),j.set(d[1]+e),f<0?(g.set(f+Math.PI*2),h.set(Math.PI*2),q.draw(),g.set(0),h.set(k),q.draw()):k>Math.PI*2?(g.set(f),h.set(Math.PI*2),q.draw(),g.set(0),h.set(k-Math.PI*2),q.draw()):(g.set(f),h.set(k),q.draw())}}};var Models={mesh:function(a,b){var c=[],d=[];typeof b=="undefined"&&(b=a);if(b<=0)throw"v_secs must be positive";if(a<=0)throw"u_secs must be positive";b=Math.floor(b),a=Math.floor(a);for(var e=0;e<=b;++e){var f=e/b;for(var g=0;g<=a;++g){var h=g/a;c.push(h,f)}}for(e=0;e<b;++e){for(var g=0;g<=a;++g)d.push(e*(a+1)+g,(e+1)*(a+1)+g);e<b-1&&d.push((e+1)*(a+1)+a,(e+2)*(a+1),(e+2)*(a+1))}var i=Shade,j=Facet.attribute_buffer(c,2),k=i.sub(i.mul(Math.PI,i.swizzle(j,"r")),Math.PI/2),l=i.mul(2*Math.PI,i.swizzle(j,"g")),m=i.cos(k);return Facet.model({type:"triangle_strip",tex_coord:j,vertex:Shade.mul(j,2).sub(Shade.vec(1,1)),elements:Facet.element_buffer(d)})},sphere:function(a,b){var c=[],d=[];typeof b=="undefined"&&(b=a);if(a<=0)throw"lat_secs must be positive";if(b<=0)throw"long_secs must be positive";a=Math.floor(a),b=Math.floor(b);for(var e=0;e<=a;++e){var f=e/a;for(var g=0;g<b;++g){var h=g/b;c.push(h,f)}}for(e=0;e<a;++e)for(var g=0;g<b;++g)d.push(e*b+g,e*b+(g+1)%b,(e+1)*b+g,e*b+(g+1)%b,(e+1)*b+(g+1)%b,(e+1)*b+g);var i=Shade,j=Facet.attribute_buffer(c,2),f=i.sub(i.mul(Math.PI,i.swizzle(j,"r")),Math.PI/2),h=i.mul(2*Math.PI,i.swizzle(j,"g")),k=i.cos(f);return Facet.model({type:"triangles",elements:Facet.element_buffer(d),vertex:i.vec(i.sin(h).mul(k),i.sin(f),i.cos(h).mul(k),1)})},square:function(){var a=Shade.make(Facet.attribute_buffer([0,0,1,0,0,1,1,1],2));return Facet.model({type:"triangles",elements:Facet.element_buffer([0,1,2,1,3,2]),vertex:a,tex_coord:a})},flat_cube:function(){return Facet.model({type:"triangles",elements:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],vertex:[[1,1,-1,-1,1,-1,-1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1],3],normal:[[0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0],3],tex_coord:[[0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],2]})}};(function(){var a={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370D8",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#D87093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},b={},c=/ *rgb *\( *(\d+) *, *(\d+) *, *(\d+) *\) */;Shade.color=function(b,d){typeOf(d)==="undefined"&&(d=1);if(b[0]==="#"){if(b.length===4)return Shade.vec(parseInt(b[1],16)/15,parseInt(b[2],16)/15,parseInt(b[3],16)/15,d);if(b.length==7)return Shade.vec(parseInt(b.substr(1,2),16)/255,parseInt(b.substr(3,2),16)/255,parseInt(b.substr(5,2),16)/255,d);throw"hex specifier must be either #rgb or #rrggbb"}var e=c.exec(b);if(e)return Shade.vec(parseInt(e[1])/255,parseInt(e[2])/255,parseInt(e[3])/255,d);if(b in a)return Shade.color(a[b],d);throw"Unrecognized color specifier "+b}})()