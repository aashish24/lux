/*
 * Facet: An EDSL for WebGL graphics
 * By Carlos Scheidegger, cscheid@research.att.com
 * 
 * Copyright (c) 2011, 2012 AT&T Intellectual Property
 * 
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors: See github logs.
 *
 */// Facet depends on the following software libraries:
////////////////////////////////////////////////////////////////////////////////
// BEGIN UNDERSCORE.JS NOTICE
// 
// Underscore.js 1.1.7
// (c) 2011 Jeremy Ashkenas, DocumentCloud Inc.
// Underscore is freely distributable under the MIT license.
// Portions of Underscore are inspired or borrowed from Prototype,
// Oliver Steele's Functional, and John Resig's Micro-Templating.
// For all details and documentation:
// http://documentcloud.github.com/underscore
//
// END UNDERSCORE.JS NOTICE
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// BEGIN WEBGL-DEBUG.JS NOTICE
// https://cvs.khronos.org/svn/repos/registry/trunk/public/webgl/sdk/debug/webgl-debug.js
//
// Copyright (c) 2009 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.
//
// END WEBGL-DEBUG.JS NOTICE
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// BEGIN WEBGL-UTILS.JS NOTICE
// https://cvs.khronos.org/svn/repos/registry/trunk/public/webgl/sdk/demos/common/webgl-utils.js
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */// END WEBGL-UTILS.JS NOTICE
////////////////////////////////////////////////////////////////////////////////
/*

  Facet is a library for making WebGL marginally
  less painful to program, featuring things like nicer support for
  fragment and vertex programs, webgl buffers, textures, etc.

 */function latlong_to_mercator(a,b){a=a/(180/Math.PI),b=b/(180/Math.PI);return[b,Math.log(1/Math.cos(a)+Math.tan(a))]}function spherical_mercator_patch(a){var b=[],c=[],d,e;for(d=0;d<=a;++d)for(e=0;e<=a;++e)b.push(d/a,e/a);for(d=0;d<a;++d)for(e=0;e<a;++e){var f=(a+1)*d+e;c.push(f,f+1,f+a+2,f,f+a+2,f+a+1)}return Facet.model({type:"triangles",uv:[b,2],elements:c,vertex:function(a,b){var c=this.uv.mul(b.sub(a)).add(a);return Facet.Scale.Geo.mercator_to_spherical(c.at(0),c.at(1))},transformed_uv:function(a,b){return Shade.mix(a,b,this.uv).div(Math.PI*2).add(Shade.vec(0,.5))}})}function facet_typeOf(a){var b=typeof a;if(b==="function"&&a._facet_expression)return"object";b==="object"&&(a?typeof a.length=="number"&&!a.propertyIsEnumerable("length")&&typeof a.splice=="function"&&(b="array"):b="null");return b}function facet_constant_type(a){var b=typeof a;if(b==="boolean")return"boolean";if(b==="number")return"number";if(a){b=a._type;if(!b)return"other"}return b}Facet={},Facet._globals={ctx:undefined},function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=d.slice,g=d.unshift,h=e.toString,i=e.hasOwnProperty,j=d.forEach,k=d.map,l=d.reduce,m=d.reduceRight,n=d.filter,o=d.every,p=d.some,q=d.indexOf,r=d.lastIndexOf;e=Array.isArray;var s=Object.keys,t=Function.prototype.bind,u=function(a){return new z(a)};typeof module!="undefined"&&module.exports?(module.exports=u,u._=u):a._=u,u.VERSION="1.1.7";var v=u.each=u.forEach=function(a,b,d){if(a!=null)if(j&&a.forEach===j)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;e<f;e++)if(e in a&&b.call(d,a[e],e,a)===c)break}else for(e in a)if(i.call(a,e)&&b.call(d,a[e],e,a)===c)break};u.map=function(a,b,c){var d=[];if(a==null)return d;if(k&&a.map===k)return a.map(b,c);v(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)});return d},u.reduce=u.foldl=u.inject=function(a,b,c,d){var e=c!==void 0;a==null&&(a=[]);if(l&&a.reduce===l)return d&&(b=u.bind(b,d)),e?a.reduce(b,c):a.reduce(b);v(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c},u.reduceRight=u.foldr=function(a,b,c,d){a==null&&(a=[]);if(m&&a.reduceRight===m)return d&&(b=u.bind(b,d)),c!==void 0?a.reduceRight(b,c):a.reduceRight(b);a=(u.isArray(a)?a.slice():u.toArray(a)).reverse();return u.reduce(a,b,c,d)},u.find=u.detect=function(a,b,c){var d;w(a,function(a,e,f){if(b.call(c,a,e,f))return d=a,!0});return d},u.filter=u.select=function(a,b,c){var d=[];if(a==null)return d;if(n&&a.filter===n)return a.filter(b,c);v(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)});return d},u.reject=function(a,b,c){var d=[];if(a==null)return d;v(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)});return d},u.every=u.all=function(a,b,d){var e=!0;if(a==null)return e;if(o&&a.every===o)return a.every(b,d);v(a,function(a,f,g){if(!(e=e&&b.call(d,a,f,g)))return c});return e};var w=u.some=u.any=function(a,b,d){b=b||u.identity;var e=!1;if(a==null)return e;if(p&&a.some===p)return a.some(b,d);v(a,function(a,f,g){if(e|=b.call(d,a,f,g))return c});return!!e};u.include=u.contains=function(a,b){var c=!1;if(a==null)return c;if(q&&a.indexOf===q)return a.indexOf(b)!=-1;w(a,function(a){if(c=a===b)return!0});return c},u.invoke=function(a,b){var c=f.call(arguments,2);return u.map(a,function(a){return(b.call?b||a:a[b]).apply(a,c)})},u.pluck=function(a,b){return u.map(a,function(a){return a[b]})},u.max=function(a,b,c){if(!b&&u.isArray(a))return Math.max.apply(Math,a);var d={computed:-Infinity};v(a,function(a,e,f){e=b?b.call(c,a,e,f):a,e>=d.computed&&(d={value:a,computed:e})});return d.value},u.min=function(a,b,c){if(!b&&u.isArray(a))return Math.min.apply(Math,a);var d={computed:Infinity};v(a,function(a,e,f){e=b?b.call(c,a,e,f):a,e<d.computed&&(d={value:a,computed:e})});return d.value},u.sortBy=function(a,b,c){return u.pluck(u.map(a,function(a,d,e){return{value:a,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0}),"value")},u.groupBy=function(a,b){var c={};v(a,function(a,d){var e=b(a,d);(c[e]||(c[e]=[])).push(a)});return c},u.sortedIndex=function(a,b,c){c||(c=u.identity);for(var d=0,e=a.length;d<e;){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d},u.toArray=function(a){return a?a.toArray?a.toArray():u.isArray(a)?f.call(a):u.isArguments(a)?f.call(a):u.values(a):[]},u.size=function(a){return u.toArray(a).length},u.first=u.head=function(a,b,c){return b!=null&&!c?f.call(a,0,b):a[0]},u.rest=u.tail=function(a,b,c){return f.call(a,b==null||c?1:b)},u.last=function(a){return a[a.length-1]},u.compact=function(a){return u.filter(a,function(a){return!!a})},u.flatten=function(a){return u.reduce(a,function(a,b){if(u.isArray(b))return a.concat(u.flatten(b));a[a.length]=b;return a},[])},u.without=function(a){return u.difference(a,f.call(arguments,1))},u.uniq=u.unique=function(a,b){return u.reduce(a,function(a,c,d){if(0==d||(b===!0?u.last(a)!=c:!u.include(a,c)))a[a.length]=c;return a},[])},u.union=function(){return u.uniq(u.flatten(arguments))},u.intersection=u.intersect=function(a){var b=f.call(arguments,1);return u.filter(u.uniq(a),function(a){return u.every(b,function(b){return u.indexOf(b,a)>=0})})},u.difference=function(a,b){return u.filter(a,function(a){return!u.include(b,a)})},u.zip=function(){for(var a=f.call(arguments),b=u.max(u.pluck(a,"length")),c=Array(b),d=0;d<b;d++)c[d]=u.pluck(a,""+d);return c},u.indexOf=function(a,b,c){if(a==null)return-1;var d;if(c)return c=u.sortedIndex(a,b),a[c]===b?c:-1;if(q&&a.indexOf===q)return a.indexOf(b);c=0;for(d=a.length;c<d;c++)if(a[c]===b)return c;return-1},u.lastIndexOf=function(a,b){if(a==null)return-1;if(r&&a.lastIndexOf===r)return a.lastIndexOf(b);for(var c=a.length;c--;)if(a[c]===b)return c;return-1},u.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=Array(d);e<d;)f[e++]=a,a+=c;return f},u.bind=function(a,b){if(a.bind===t&&t)return t.apply(a,f.call(arguments,1));var c=f.call(arguments,2);return function(){return a.apply(b,c.concat(f.call(arguments)))}},u.bindAll=function(a){var b=f.call(arguments,1);b.length==0&&(b=u.functions(a)),v(b,function(b){a[b]=u.bind(a[b],a)});return a},u.memoize=function(a,b){var c={};b||(b=u.identity);return function(){var d=b.apply(this,arguments);return i.call(c,d)?c[d]:c[d]=a.apply(this,arguments)}},u.delay=function(a,b){var c=f.call(arguments,2);return setTimeout(function(){return a.apply(a,c)},b)},u.defer=function(a){return u.delay.apply(u,[a,1].concat(f.call(arguments,1)))};var x=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,a.apply(e,f)};c&&clearTimeout(d);if(c||!d)d=setTimeout(g,b)}};u.throttle=function(a,b){return x(a,b,!1)},u.debounce=function(a,b){return x(a,b,!0)},u.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}},u.wrap=function(a,b){return function(){var c=[a].concat(f.call(arguments));return b.apply(this,c)}},u.compose=function(){var a=f.call(arguments);return function(){for(var b=f.call(arguments),c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},u.after=function(a,b){return function(){if(--a<1)return b.apply(this,arguments)}},u.keys=s||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],c;for(c in a)i.call(a,c)&&(b[b.length]=c);return b},u.values=function(a){return u.map(a,u.identity)},u.functions=u.methods=function(a){var b=[],c;for(c in a)u.isFunction(a[c])&&b.push(c);return b.sort()},u.extend=function(a){v(f.call(arguments,1),function(b){for(var c in b)b[c]!==void 0&&(a[c]=b[c])});return a},u.defaults=function(a){v(f.call(arguments,1),function(b){for(var c in b)a[c]==null&&(a[c]=b[c])});return a},u.clone=function(a){return u.isArray(a)?a.slice():u.extend({},a)},u.tap=function(a,b){b(a);return a},u.isEqual=function(a,b){if(a===b)return!0;var c=typeof a;if(c!=typeof b)return!1;if(a==b)return!0;if(!a&&b||a&&!b)return!1;a._chain&&(a=a._wrapped),b._chain&&(b=b._wrapped);if(a.isEqual)return a.isEqual(b);if(b.isEqual)return b.isEqual(a);if(u.isDate(a)&&u.isDate(b))return a.getTime()===b.getTime();if(u.isNaN(a)&&u.isNaN(b))return!1;if(u.isRegExp(a)&&u.isRegExp(b))return a.source===b.source&&a.global===b.global&&a.ignoreCase===b.ignoreCase&&a.multiline===b.multiline;if(c!=="object")return!1;if(a.length&&a.length!==b.length)return!1;c=u.keys(a);var d=u.keys(b);if(c.length!=d.length)return!1;for(var e in a)if(!(e in b)||!u.isEqual(a[e],b[e]))return!1;return!0},u.isEmpty=function(a){if(u.isArray(a)||u.isString(a))return a.length===0;for(var b in a)if(i.call(a,b))return!1;return!0},u.isElement=function(a){return!!a&&a.nodeType==1},u.isArray=e||function(a){return h.call(a)==="[object Array]"},u.isObject=function(a){return a===Object(a)},u.isArguments=function(a){return!!a&&!!i.call(a,"callee")},u.isFunction=function(a){return!(!a||!a.constructor||!a.call||!a.apply)},u.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},u.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)},u.isNaN=function(a){return a!==a},u.isBoolean=function(a){return a===!0||a===!1},u.isDate=function(a){return!(!a||!a.getTimezoneOffset||!a.setUTCFullYear)},u.isRegExp=function(a){return!(!a||!a.test||!a.exec||!a.ignoreCase&&a.ignoreCase!==!1)},u.isNull=function(a){return a===null},u.isUndefined=function(a){return a===void 0},u.noConflict=function(){a._=b;return this},u.identity=function(a){return a},u.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)},u.mixin=function(a){v(u.functions(a),function(b){B(b,u[b]=a[b])})};var y=0;u.uniqueId=function(a){var b=y++;return a?a+b:b},u.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},u.template=function(a,b){var c=u.templateSettings;c="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(c.interpolate,function(a,b){return"',"+b.replace(/\\'/g,"'")+",'"}).replace(c.evaluate||null,function(a,b){return"');"+b.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",c=new Function("obj",c);return b?c(b):c};var z=function(a){this._wrapped=a};u.prototype=z.prototype;var A=function(a,b){return b?u(a).chain():a},B=function(a,b){z.prototype[a]=function(){var a=f.call(arguments);g.call(a,this._wrapped);return A(b.apply(u,a),this._chain)}};u.mixin(u),v(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];z.prototype[a]=function(){b.apply(this._wrapped,arguments);return A(this._wrapped,this._chain)}}),v(["concat","join","slice"],function(a){var b=d[a];z.prototype[a]=function(){return A(b.apply(this._wrapped,arguments),this._chain)}}),z.prototype.chain=function(){this._chain=!0;return this},z.prototype.value=function(){return this._wrapped}}(),WebGLDebugUtils=function(){function k(a){function x(a){return typeof a=="function"?a:function(b){a.handleEvent(b)}}function r(){for(var b=0;b<f.length;++b){var c=f[b];c instanceof WebGLBuffer?a.deleteBuffer(c):c instanceof WebctxFramebuffer?a.deleteFramebuffer(c):c instanceof WebctxProgram?a.deleteProgram(c):c instanceof WebctxRenderbuffer?a.deleteRenderbuffer(c):c instanceof WebctxShader?a.deleteShader(c):c instanceof WebctxTexture&&a.deleteTexture(c)}}function q(a){return{statusMessage:a}}function o(a,b){var c=a[b];return function(){if(!d){if(!m(arguments)){k[a.INVALID_OPERATION]=!0;return}var b=c.apply(a,arguments);return b}}}function n(){var a=Object.keys(k);for(var b=0;b<a.length;++b)delete glErrorShdow_[a]}function m(a){for(var b=0;b<a.length;++b){var d=a[b];if(l(d))return d.__webglDebugContextLostId__==c}return!0}function l(a){return a instanceof WebGLBuffer||a instanceof WebGLFramebuffer||a instanceof WebGLProgram||a instanceof WebGLRenderbuffer||a instanceof WebGLShader||a instanceof WebGLTexture}var b={},c=1,d=!1,e=0,f=[],g=undefined,h=undefined,i=undefined,k={};for(var p in a)typeof a[p]=="function"?b[p]=o(a,p):b[p]=a[p];b.loseContext=function(){if(!d){d=!0,++c;while(a.getError());n(),k[a.CONTEXT_LOST_WEBGL]=!0,setTimeout(function(){g&&g(q("context lost"))},0)}},b.restoreContext=function(){if(d)if(h)setTimeout(function(){r(),j(a),d=!1;if(h){var b=h;h=i,i=undefined,b(q("context restored"))}},0);else throw"You can not restore the context without a listener"},b.getError=function(){if(!d){var b;while(b=a.getError())k[b]=!0}for(var b in k)if(k[b]){delete k[b];return b}return a.NO_ERROR};var s=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"];for(var t=0;t<s.length;++t){var u=s[t];b[u]=function(b){return function(){if(d)return null;var e=b.apply(a,arguments);e.__webglDebugContextLostId__=c,f.push(e);return e}}(a[u])}var v=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(var t=0;t<v.length;++t){var u=v[t];b[u]=function(b){return function(){return d?null:b.apply(a,arguments)}}(b[u])}var w=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(var t=0;t<w.length;++t){var u=w[t];b[u]=function(b){return function(){return d?!1:b.apply(a,arguments)}}(b[u])}b.checkFramebufferStatus=function(b){return function(){return d?a.FRAMEBUFFER_UNSUPPORTED:b.apply(a,arguments)}}(b.checkFramebufferStatus),b.getAttribLocation=function(b){return function(){return d?-1:b.apply(a,arguments)}}(b.getAttribLocation),b.getVertexAttribOffset=function(b){return function(){return d?0:b.apply(a,arguments)}}(b.getVertexAttribOffset),b.isContextLost=function(){return d},b.registerOnContextLostListener=function(a){g=x(a)},b.registerOnContextRestoredListener=function(a){d?i=x(a):h=x(a)};return b}function j(a){var b=a.getParameter(a.MAX_VERTEX_ATTRIBS),c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);for(var d=0;d<b;++d)a.disableVertexAttribArray(d),a.vertexAttribPointer(d,4,a.FLOAT,!1,0,0),a.vertexAttrib1f(d,0);a.deleteBuffer(c);var e=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);for(var d=0;d<e;++d)a.activeTexture(a.TEXTURE0+d),a.bindTexture(a.TEXTURE_CUBE_MAP,null),a.bindTexture(a.TEXTURE_2D,null);a.activeTexture(a.TEXTURE0),a.useProgram(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.disable(a.BLEND),a.disable(a.CULL_FACE),a.disable(a.DEPTH_TEST),a.disable(a.DITHER),a.disable(a.SCISSOR_TEST),a.blendColor(0,0,0,0),a.blendEquation(a.FUNC_ADD),a.blendFunc(a.ONE,a.ZERO),a.clearColor(0,0,0,0),a.clearDepth(1),a.clearStencil(-1),a.colorMask(!0,!0,!0,!0),a.cullFace(a.BACK),a.depthFunc(a.LESS),a.depthMask(!0),a.depthRange(0,1),a.frontFace(a.CCW),a.hint(a.GENERATE_MIPMAP_HINT,a.DONT_CARE),a.lineWidth(1),a.pixelStorei(a.PACK_ALIGNMENT,4),a.pixelStorei(a.UNPACK_ALIGNMENT,4),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.UNPACK_COLORSPACE_CONVERSION_WEBGL&&a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.BROWSER_DEFAULT_WEBGL),a.polygonOffset(0,0),a.sampleCoverage(1,!1),a.scissor(0,0,a.canvas.width,a.canvas.height),a.stencilFunc(a.ALWAYS,0,4294967295),a.stencilMask(4294967295),a.stencilOp(a.KEEP,a.KEEP,a.KEEP),a.viewport(0,0,a.canvas.clientWidth,a.canvas.clientHeight),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT);while(a.getError());}function i(b,c){function f(a,b){return function(){var d=a[b].apply(a,arguments),f=a.getError();f!=0&&(e[f]=!0,c(f,b,arguments));return d}}d(b),c=c||function(b,c,d){var e="";for(var f=0;f<d.length;++f)e+=(f==0?"":", ")+h(c,f,d[f]);a("WebGL error "+g(b)+" in "+c+"("+e+")")};var e={},i={};for(var j in b)typeof b[j]=="function"?i[j]=f(b,j):i[j]=b[j];i.getError=function(){for(var a in e)if(e[a]){e[a]=!1;return a}return b.NO_ERROR};return i}function h(a,c,d){var e=b[a];if(e!==undefined&&e[c])return g(d);return d.toString()}function g(a){e();var b=c[a];return b!==undefined?b:"*UNKNOWN WebGL ENUM (0x"+a.toString(16)+")"}function f(a){e();return c[a]!==undefined}function e(){if(c==null)throw"WebGLDebugUtils.init(ctx) not called"}function d(a){if(c==null){c={};for(var b in a)typeof a[b]=="number"&&(c[a[b]]=b)}}var a=function(a){window.console&&window.console.log&&window.console.log(a)},b={enable:{0:!0},disable:{0:!0},getParameter:{0:!0},drawArrays:{0:!0},drawElements:{0:!0,2:!0},createShader:{0:!0},getShaderParameter:{1:!0},getProgramParameter:{1:!0},getVertexAttrib:{1:!0},vertexAttribPointer:{2:!0},bindTexture:{0:!0},activeTexture:{0:!0},getTexParameter:{0:!0,1:!0},texParameterf:{0:!0,1:!0},texParameteri:{0:!0,1:!0,2:!0},texImage2D:{0:!0,2:!0,6:!0,7:!0},texSubImage2D:{0:!0,6:!0,7:!0},copyTexImage2D:{0:!0,2:!0},copyTexSubImage2D:{0:!0},generateMipmap:{0:!0},bindBuffer:{0:!0},bufferData:{0:!0,2:!0},bufferSubData:{0:!0},getBufferParameter:{0:!0,1:!0},pixelStorei:{0:!0,1:!0},readPixels:{4:!0,5:!0},bindRenderbuffer:{0:!0},bindFramebuffer:{0:!0},checkFramebufferStatus:{0:!0},framebufferRenderbuffer:{0:!0,1:!0,2:!0},framebufferTexture2D:{0:!0,1:!0,2:!0},getFramebufferAttachmentParameter:{0:!0,1:!0,2:!0},getRenderbufferParameter:{0:!0,1:!0},renderbufferStorage:{0:!0,1:!0},clear:{0:!0},depthFunc:{0:!0},blendFunc:{0:!0,1:!0},blendFuncSeparate:{0:!0,1:!0,2:!0,3:!0},blendEquation:{0:!0},blendEquationSeparate:{0:!0,1:!0},stencilFunc:{0:!0},stencilFuncSeparate:{0:!0,1:!0},stencilMaskSeparate:{0:!0},stencilOp:{0:!0,1:!0,2:!0},stencilOpSeparate:{0:!0,1:!0,2:!0,3:!0},cullFace:{0:!0},frontFace:{0:!0}},c=null;return{init:d,mightBeEnum:f,glEnumToString:g,glFunctionArgToString:h,makeDebugContext:i,makeLostContextSimulatingContext:k,resetToInitialState:j}}(),WebGLUtils=function(){var a=function(a){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+a+"</div>"+"</div>"+"</td></tr></table>"},b='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',c='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',d=function(d,f){function g(b){var c=d.parentNode;c&&(c.innerHTML=a(b))}if(!window.WebGLRenderingContext){g(b);return null}var h=e(d,f);h||g(c);return h},e=function(a,b){var c=["webgl","experimental-webgl","webkit-3d","moz-webgl"],d=null;for(var e=0;e<c.length;++e){try{d=a.getContext(c[e],b)}catch(f){}if(d)break}return d};return{create3DContext:e,setupWebGL:d}}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}(),_.mixin({build:function(a){var b={};_.each(a,function(a){b[a[0]]=a[1]});return b}});var vec={},mat={};vec.eps=1e-6,mat.eps=1e-6;var vec2={};vec2.create=function(){var a=new Float32Array(2);a._type="vector";return a},vec2.copy=function(a){var b=new Float32Array(2);b._type="vector",b[0]=a[0],b[1]=a[1];return b},vec2.make=vec2.copy,vec2.equal=function(a,b){return Math.abs(a[0]-b[0])<vec.eps&&Math.abs(a[1]-b[1])<vec.eps},vec2.random=function(){var a=vec2.make([Math.random(),Math.random()]);return a},vec2.set=function(a,b){a[0]=b[0],a[1]=b[1];return a},vec2.plus=function(a,b){var c=new Float32Array(2);c._type="vector",c[0]=a[0]+b[0],c[1]=a[1]+b[1];return c},vec2.add=function(a,b){a[0]+=b[0],a[1]+=b[1];return a},vec2.minus=function(a,b){var c=new Float32Array(2);c._type="vector",c[0]=a[0]-b[0],c[1]=a[1]-b[1];return c},vec2.subtract=function(a,b){a[0]-=b[0],a[1]-=b[1];return a},vec2.negative=function(a){var b=new Float32Array(2);b._type="vector",b[0]=-a[0],b[1]=-a[1];return b},vec2.negate=function(a){a[0]=-a[0],a[1]=-a[1];return a},vec2.scaling=function(a,b){var c=new Float32Array(2);c._type="vector",c[0]=a[0]*b,c[1]=a[1]*b;return c},vec2.scale=function(a,b){a[0]*=b,a[1]*=b;return a},vec2.schur_product=function(a,b){var c=new Float32Array(2);c._type="vector",c[0]=a[0]*b[0],c[1]=a[1]*b[1];return c},vec2.schur_multiply=function(a,b){a[0]*=b[0],a[1]*=b[1];return a},vec2.normalized=function(a){var b=new Float32Array(2);b._type="vector";var c=a[0],d=a[1],e=Math.sqrt(c*c+d*d);if(!e)return b;if(e==1){b[0]=c,b[1]=d;return b}b[0]=c/e,b[1]=d/e;return b},vec2.normalize=function(a){var b=a[0],c=a[1],d=Math.sqrt(b*b+c*c);if(!d){a[0]=a[1]=0;return a}a[0]/=d,a[1]/=d;return a},vec2.length=function(a){var b=a[0],c=a[1];return Math.sqrt(b*b+c*c)},vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]},vec2.map=function(a,b){return vec2.make(_.map(a,b))},vec2.str=function(a){return"["+a[0]+", "+a[1]+"]"};var vec3={};vec3.create=function(){var a=new Float32Array(3);a._type="vector";return a},vec3.copy=function(a){var b=new Float32Array(3);b._type="vector",b[0]=a[0],b[1]=a[1],b[2]=a[2];return b},vec3.make=vec3.copy,vec3.equal=function(a,b){return Math.abs(a[0]-b[0])<vec.eps&&Math.abs(a[1]-b[1])<vec.eps&&Math.abs(a[2]-b[2])<vec.eps},vec3.random=function(){var a=vec3.make([Math.random(),Math.random(),Math.random()]);return a},vec3.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2];return a},vec3.plus=function(a,b){var c=new Float32Array(3);c._type="vector",c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2];return c},vec3.add=function(a,b){a[0]+=b[0],a[1]+=b[1],a[2]+=b[2];return a},vec3.minus=function(a,b){var c=new Float32Array(3);c._type="vector",c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2];return c},vec3.subtract=function(a,b){a[0]-=b[0],a[1]-=b[1],a[2]-=b[2];return a},vec3.negative=function(a){var b=new Float32Array(3);b._type="vector",b[0]=-a[0],b[1]=-a[1],b[2]=-a[2];return b},vec3.negate=function(a){a[0]=-a[0],a[1]=-a[1],a[2]=-a[2];return a},vec3.scaling=function(a,b){var c=new Float32Array(3);c._type="vector",c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b;return c},vec3.scale=function(a,b){a[0]*=b,a[1]*=b,a[2]*=b;return a},vec3.schur_product=function(a,b){var c=new Float32Array(3);c._type="vector",c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2];return c},vec3.schur_multiply=function(a,b){a[0]*=b[0],a[1]*=b[1],a[2]*=b[2];return a},vec3.normalized=function(a){var b=new Float32Array(3);b._type="vector";var c=a[0],d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);if(!f)return b;if(f==1){b[0]=c,b[1]=d,b[2]=e;return b}b[0]=c/f,b[1]=d/f,b[2]=e/f;return b},vec3.normalize=function(a){var b=a[0],c=a[1],d=a[2],e=Math.sqrt(b*b+c*c+d*d);if(!e){a[0]=a[1]=a[2]=0;return a}a[0]/=e,a[1]/=e,a[2]/=e;return a},vec3.cross=function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2],i=new Float32Array(3);i._type="vector",i[0]=d*h-e*g,i[1]=e*f-c*h,i[2]=c*g-d*f;return i},vec3.length=function(a){var b=a[0],c=a[1],d=a[2];return Math.sqrt(b*b+c*c+d*d)},vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},vec3.map=function(a,b){return vec3.make(_.map(a,b))},vec3.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};var vec4={};vec4.create=function(){var a=new Float32Array(4);a._type="vector";return a},vec4.copy=function(a){var b=new Float32Array(4);b._type="vector",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3];return b},vec4.make=vec4.copy,vec4.random=function(){var a=[Math.random(),Math.random(),Math.random(),Math.random()];return vec4.make(a)},vec4.equal=function(a,b){return Math.abs(a[0]-b[0])<vec.eps&&Math.abs(a[1]-b[1])<vec.eps&&Math.abs(a[2]-b[2])<vec.eps&&Math.abs(a[3]-b[3])<vec.eps},vec4.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3];return a},vec4.plus=function(a,b){var c=new Float32Array(4);c._type="vector",c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3];return c},vec4.add=function(a,b){a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=b[3];return a},vec4.minus=function(a,b){var c=new Float32Array(4);c._type="vector",c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3];return c},vec4.subtract=function(a,b){a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a[3]-=b[3];return a},vec4.negative=function(a){var b=new Float32Array(4);b._type="vector",b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3];return b},vec4.negate=function(a){a[0]=-a[0],a[1]=-a[1],a[2]=-a[2],a[3]=-a[3];return a},vec4.scaling=function(a,b){var c=new Float32Array(4);c._type="vector",c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b;return c},vec4.scale=function(a,b){a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b;return a},vec4.schur_product=function(a,b){var c=new Float32Array(4);c._type="vector",c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3];return c},vec4.schur_multiply=function(a,b){a[0]*=b[0],a[1]*=b[1],a[2]*=b[2],a[3]*=b[3];return a},vec4.normalized=function(a){var b=new Float32Array(4);b._type="vector";var c=a[0],d=a[1],e=a[2],f=a[3],g=Math.sqrt(c*c+d*d+e*e+f*f);if(!g)return b;if(g==1){b[0]=c,b[1]=d,b[2]=e,b[3]=f;return b}b[0]=c/g,b[1]=d/g,b[2]=e/g,b[3]=f/g;return b},vec4.normalize=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=Math.sqrt(b*b+c*c+d*d+e*e);if(!f){a[0]=a[1]=a[2]=a[3]=0;return a}a[0]/=f,a[1]/=f,a[2]/=f,a[3]/=f;return a},vec4.length=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return Math.sqrt(b*b+c*c+d*d+e*e)},vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},vec4.map=function(a,b){return vec4.make(_.map(a,b))},vec4.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var mat2={};mat2.create=function(){var a=new Float32Array(4);a._type="matrix";return a},mat2.copy=function(a){var b=new Float32Array(4);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3];return b},mat2.make=mat2.copy,mat2.equal=function(a,b){return Math.abs(a[0]-b[0])<mat.eps&&Math.abs(a[1]-b[1])<mat.eps&&Math.abs(a[2]-b[2])<mat.eps&&Math.abs(a[3]-b[3])<mat.eps},mat2.random=function(){var a=new Float32Array(4);a._type="matrix",a[0]=Math.random(),a[1]=Math.random(),a[2]=Math.random(),a[3]=Math.random();return a},mat2.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3];return a},function(){var a=new Float32Array([1,0,0,1]);mat2.identity=function(){var b=new Float32Array(a);b._type="matrix";return b},mat2.set_identity=function(b){mat2.set(b,a);return b}}(),mat2.transpose=function(a){var b=new Float32Array(4);b._type="matrix",b[0]=a[0],b[1]=a[2],b[2]=a[1],b[3]=a[3];return b},mat2.set_transpose=function(a,b){if(b==a){var c=b[1];a[1]=b[2],a[2]=c;return a}a[0]=b[0],a[1]=b[2],a[2]=b[1],a[3]=b[3];return a},mat2.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},mat2.inverse=function(a){var b=new Float32Array(4);b._type="matrix";var c=a[0],d=a[1],e=a[2],f=a[3],g=c*f-d*e;if(g===0)throw"Singular matrix";b[0]=f/g,b[1]=-d/g,b[2]=-e/g,b[3]=c/g;return b},mat2.invert=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=b*e-c*d;if(f===0)throw"Singular matrix";a[0]=e/f,a[1]=-c/f,a[2]=-d/f,a[3]=b/f;return a},mat2.as_mat4=function(a){var b=new Float32Array(16);b._type="matrix",b[0]=a[0],b[1]=a[1],b[4]=a[2],b[5]=a[3];return b},mat2.as_mat3=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[1],b[3]=a[2],b[4]=a[3];return b},mat2.product=function(a,b){var c=new Float32Array(4);c._type="matrix";var d=a[0],e=a[1],f=a[2],g=a[3],h=b[0],i=b[1],j=b[2],k=b[3];c[0]=h*d+i*f,c[1]=h*e+i*g,c[2]=j*d+k*f,c[3]=j*e+k*g;return c},mat2.multiply=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3];a[0]=g*c+h*e,a[1]=g*d+h*f,a[2]=i*c+j*e,a[3]=i*d+j*f;return a},mat2.product_vec=function(a,b){var c=new Float32Array(2);c._type="vector";var d=b[0],e=b[1];c[0]=a[0]*d+a[2]*e,c[1]=a[1]*d+a[3]*e;return c},mat2.multiply_vec=function(a,b){var c=b[0],d=b[1];b[0]=a[0]*c+a[2]*d,b[1]=a[1]*c+a[3]*d;return b},mat2.frobenius_norm=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},mat2.map=function(a,b){return mat2.make(_.map(a,b))},mat2.str=function(a){return"[ ["+a[0]+"] ["+a[2]+"] ]\n"+"[ ["+a[1]+"] ["+a[3]+"] ]"};var mat3={};mat3.create=function(){var a=new Float32Array(9);a._type="matrix";return a},mat3.copy=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8];return b},mat3.make=mat3.copy,mat3.equal=function(a,b){return Math.abs(a[0]-b[0])<mat.eps&&Math.abs(a[1]-b[1])<mat.eps&&Math.abs(a[2]-b[2])<mat.eps&&Math.abs(a[3]-b[3])<mat.eps&&Math.abs(a[4]-b[4])<mat.eps&&Math.abs(a[5]-b[5])<mat.eps&&Math.abs(a[6]-b[6])<mat.eps&&Math.abs(a[7]-b[7])<mat.eps&&Math.abs(a[8]-b[8])<mat.eps},mat3.random=function(){var a=new Float32Array(9);a._type="matrix",a[0]=Math.random(),a[1]=Math.random(),a[2]=Math.random(),a[3]=Math.random(),a[4]=Math.random(),a[5]=Math.random(),a[6]=Math.random(),a[7]=Math.random(),a[8]=Math.random();return a},mat3.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8];return a},function(){var a=new Float32Array([1,0,0,0,1,0,0,0,1]);mat3.identity=function(){var b=new Float32Array(a);b._type="matrix";return b},mat3.set_identity=function(b){mat3.set(b,a);return b}}(),mat3.transpose=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[3],b[2]=a[6],b[3]=a[1],b[4]=
a[4],b[5]=a[7],b[6]=a[2],b[7]=a[5],b[8]=a[8];return b},mat3.set_transpose=function(a,b){if(b==a){var c=b[1],d=b[2],e=b[5];a[1]=b[3],a[2]=b[6],a[3]=c,a[5]=b[7],a[6]=d,a[7]=e;return a}a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8];return a},mat3.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8];return b*f*j+c*g*h+d*e*i-d*f*h-c*e*j-b*g*i},mat3.inverse=function(a){var b=new Float32Array(9);b._type="matrix";var c=a[0],d=a[3],e=a[6],f=a[1],g=a[4],h=a[7],i=a[2],j=a[5],k=a[8],l=c*g*k+d*h*i+e*f*j-e*g*i-d*f*k-c*h*j;if(l===0)throw"Singular matrix";b[0]=(g*k-h*j)/l,b[1]=(-f*k+h*i)/l,b[2]=(f*j-g*i)/l,b[3]=(-d*k+e*j)/l,b[4]=(c*k-e*i)/l,b[5]=(-c*j+d*i)/l,b[6]=(d*h-e*g)/l,b[7]=(-c*h+e*f)/l,b[8]=(c*g-d*f)/l;return b},mat3.invert=function(a){var b=a[0],c=a[3],d=a[6],e=a[1],f=a[4],g=a[7],h=a[2],i=a[5],j=a[8],k=b*f*j+c*g*h+d*e*i-d*f*h-c*e*j-b*g*i;if(k===0)throw"Singular matrix";a[0]=(f*j-g*i)/k,a[1]=(-e*j+g*h)/k,a[2]=(e*i-f*h)/k,a[3]=(-c*j+d*i)/k,a[4]=(b*j-d*h)/k,a[5]=(-b*i+c*h)/k,a[6]=(c*g-d*f)/k,a[7]=(-b*g+d*e)/k,a[8]=(b*f-c*e)/k;return a},mat3.as_mat4=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[4]=a[3],b[5]=a[4],b[6]=a[5],b[8]=a[6],b[9]=a[7],b[10]=a[8];return b},mat3.as_mat2=function(a){var b=new Float32Array(4);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[3],b[3]=a[4];return b},mat3.product=function(a,b){var c=new Float32Array(9);c._type="matrix";var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=b[0],n=b[1],o=b[2],p=b[3],q=b[4],r=b[5],s=b[6],t=b[7],u=b[8];c[0]=m*d+n*g+o*j,c[1]=m*e+n*h+o*k,c[2]=m*f+n*i+o*l,c[3]=p*d+q*g+r*j,c[4]=p*e+q*h+r*k,c[5]=p*f+q*i+r*l,c[6]=s*d+t*g+u*j,c[7]=s*e+t*h+u*k,c[8]=s*f+t*i+u*l;return c},mat3.multiply=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=b[0],m=b[1],n=b[2],o=b[3],p=b[4],q=b[5],r=b[6],s=b[7],t=b[8];a[0]=l*c+m*f+n*i,a[1]=l*d+m*g+n*j,a[2]=l*e+m*h+n*k,a[3]=o*c+p*f+q*i,a[4]=o*d+p*g+q*j,a[5]=o*e+p*h+q*k,a[6]=r*c+s*f+t*i,a[7]=r*d+s*g+t*j,a[8]=r*e+s*h+t*k;return a},mat3.product_vec=function(a,b){var c=new Float32Array(3);c._type="vector";var d=b[0],e=b[1],f=b[2];c[0]=a[0]*d+a[3]*e+a[6]*f,c[1]=a[1]*d+a[4]*e+a[7]*f,c[2]=a[2]*d+a[5]*e+a[8]*f;return c},mat3.multiply_vec=function(a,b){var c=b[0],d=b[1],e=b[2];b[0]=a[0]*c+a[3]*d+a[6]*e,b[1]=a[1]*c+a[4]*d+a[7]*e,b[2]=a[2]*c+a[5]*d+a[8]*e;return b},mat3.frobenius_norm=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]+a[4]*a[4]+a[5]*a[5]+a[6]*a[6]+a[7]*a[7]+a[8]*a[8])},mat3.map=function(a,b){return mat3.make(_.map(a,b))},mat3.str=function(a){return"[ ["+a[0]+"] ["+a[3]+"] ["+a[6]+"] ]\n"+"[ ["+a[1]+"] ["+a[4]+"] ["+a[7]+"] ]\n"+"[ ["+a[2]+"] ["+a[5]+"] ["+a[8]+"] ]"};var mat4={};mat4.create=function(a){var b=new Float32Array(16);b._type="matrix";return b},mat4.copy=function(a){var b=new Float32Array(16);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15];return b},mat4.make=mat4.copy,mat4.equal=function(a,b){return Math.abs(a[0]-b[0])<mat.eps&&Math.abs(a[1]-b[1])<mat.eps&&Math.abs(a[2]-b[2])<mat.eps&&Math.abs(a[3]-b[3])<mat.eps&&Math.abs(a[4]-b[4])<mat.eps&&Math.abs(a[5]-b[5])<mat.eps&&Math.abs(a[6]-b[6])<mat.eps&&Math.abs(a[7]-b[7])<mat.eps&&Math.abs(a[8]-b[8])<mat.eps&&Math.abs(a[9]-b[9])<mat.eps&&Math.abs(a[10]-b[10])<mat.eps&&Math.abs(a[11]-b[11])<mat.eps&&Math.abs(a[12]-b[12])<mat.eps&&Math.abs(a[13]-b[13])<mat.eps&&Math.abs(a[14]-b[14])<mat.eps&&Math.abs(a[15]-b[15])<mat.eps},mat4.random=function(){var a=mat4.create();for(var b=0;b<16;++b)a[b]=Math.random();return a},mat4.set=function(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15];return a},function(){var a=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);mat4.identity=function(){var b=new Float32Array(a);b._type="matrix";return b},mat4.set_identity=function(b){mat4.set(b,a);return b}}(),mat4.transpose=function(a){var b=new Float32Array(16);b._type="matrix",b[0]=a[0],b[1]=a[4],b[2]=a[8],b[3]=a[12],b[4]=a[1],b[5]=a[5],b[6]=a[9],b[7]=a[13],b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=a[14],b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15];return b},mat4.set_transpose=function(a,b){if(b==a){var c=b[1],d=b[2],e=b[3],f=b[6],g=b[7],h=b[11];a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=c,a[6]=b[9],a[7]=b[13],a[8]=d,a[9]=e,a[11]=b[14],a[12]=e,a[13]=g,a[14]=h;return a}a[0]=b[0],a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=b[1],a[5]=b[5],a[6]=b[9],a[7]=b[13],a[8]=b[2],a[9]=b[6],a[10]=b[10],a[11]=b[14],a[12]=b[3],a[13]=b[7],a[14]=b[11],a[15]=b[15];return a},mat4.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},mat4.inverse=function(a){var b=new Float32Array(16);b._type="matrix";var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;b[0]=(h*D-i*C+j*B)/E,b[1]=(-d*D+e*C-f*B)/E,b[2]=(p*x-q*w+r*v)/E,b[3]=(-l*x+m*w-n*v)/E,b[4]=(-g*D+i*A-j*z)/E,b[5]=(c*D-e*A+f*z)/E,b[6]=(-o*x+q*u-r*t)/E,b[7]=(k*x-m*u+n*t)/E,b[8]=(g*C-h*A+j*y)/E,b[9]=(-c*C+d*A-f*y)/E,b[10]=(o*w-p*u+r*s)/E,b[11]=(-k*w+l*u-n*s)/E,b[12]=(-g*B+h*z-i*y)/E,b[13]=(c*B-d*z+e*y)/E,b[14]=(-o*v+p*t-q*s)/E,b[15]=(k*v-l*t+m*s)/E;return b},mat4.invert=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=b*g-c*f,s=b*h-d*f,t=b*i-e*f,u=c*h-d*g,v=c*i-e*g,w=d*i-e*h,x=j*o-k*n,y=j*p-l*n,z=j*q-m*n,A=k*p-l*o,B=k*q-m*o,C=l*q-m*p,D=r*C-s*B+t*A+u*z-v*y+w*x;a[0]=(g*C-h*B+i*A)/D,a[1]=(-c*C+d*B-e*A)/D,a[2]=(o*w-p*v+q*u)/D,a[3]=(-k*w+l*v-m*u)/D,a[4]=(-f*C+h*z-i*y)/D,a[5]=(b*C-d*z+e*y)/D,a[6]=(-n*w+p*t-q*s)/D,a[7]=(j*w-l*t+m*s)/D,a[8]=(f*B-g*z+i*x)/D,a[9]=(-b*B+c*z-e*x)/D,a[10]=(n*v-o*t+q*r)/D,a[11]=(-j*v+k*t-m*r)/D,a[12]=(-f*A+g*y-h*x)/D,a[13]=(b*A-c*y+d*x)/D,a[14]=(-n*u+o*s-p*r)/D,a[15]=(j*u-k*s+l*r)/D;return a},mat4.as_mat3=function(a){var b=new Float32Array(9);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[4],b[4]=a[5],b[5]=a[6],b[6]=a[8],b[7]=a[9],b[8]=a[10];return b},mat4.as_mat2=function(a){var b=new Float32Array(4);b._type="matrix",b[0]=a[0],b[1]=a[1],b[2]=a[4],b[3]=a[5];return b},mat4.as_inverse_transpose_mat3=function(a){var b=a[0],c=a[4],d=a[8],e=a[1],f=a[5],g=a[9],h=a[2],i=a[6],j=a[10],k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;if(!n)throw"singular matrix";var o=new Float32Array(9);o._type="matrix",o[0]=k/n,o[1]=(-j*c+d*i)/n,o[2]=(g*c-d*f)/n,o[3]=l/n,o[4]=(j*b-d*h)/n,o[5]=(-g*b+d*e)/n,o[6]=m/n,o[7]=(-i*b+c*h)/n,o[8]=(f*b-c*e)/n;return o},mat4.product=function(a,b){var c=new Float32Array(16);c._type="matrix";var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s;return c},mat4.multiply=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];a[0]=s*c+t*g+u*k+v*o,a[1]=s*d+t*h+u*l+v*p,a[2]=s*e+t*i+u*m+v*q,a[3]=s*f+t*j+u*n+v*r,a[4]=w*c+x*g+y*k+z*o,a[5]=w*d+x*h+y*l+z*p,a[6]=w*e+x*i+y*m+z*q,a[7]=w*f+x*j+y*n+z*r,a[8]=A*c+B*g+C*k+D*o,a[9]=A*d+B*h+C*l+D*p,a[10]=A*e+B*i+C*m+D*q,a[11]=A*f+B*j+C*n+D*r,a[12]=E*c+F*g+G*k+H*o,a[13]=E*d+F*h+G*l+H*p,a[14]=E*e+F*i+G*m+H*q,a[15]=E*f+F*j+G*n+H*r;return a},mat4.product_vec=function(a,b){var c=new Float32Array(4);c._type="vector";var d=b[0],e=b[1],f=b[2],g=b[3];c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*g,c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*g,c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*g,c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*g;return c},mat4.multiply_vec=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];b[0]=a[0]*c+a[4]*d+a[8]*e+a[12]*f,b[1]=a[1]*c+a[5]*d+a[9]*e+a[13]*f,b[2]=a[2]*c+a[6]*d+a[10]*e+a[14]*f,b[3]=a[3]*c+a[7]*d+a[11]*e+a[15]*f;return b},mat4.multiply_vec3=function(a,b){var c=b[0],d=b[1],e=b[2];b[0]=a[0]*c+a[4]*d+a[8]*e,b[1]=a[1]*c+a[5]*d+a[9]*e,b[2]=a[2]*c+a[6]*d+a[10]*e;return b},mat4.translation_of=function(a,b){var c=new Float32Array(16);c._type="matrix";var d=b[0],e=b[1],f=b[2],g=a[0],h=a[1],i=a[2],j=a[3],k=a[4],l=a[5],m=a[6],n=a[7],o=a[8],p=a[9],q=a[10],r=a[11];c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c[6]=m,c[7]=n,c[8]=o,c[9]=p,c[10]=q,c[11]=r,c[12]=g*d+k*e+o*f+a[12],c[13]=h*d+l*e+p*f+a[13],c[14]=i*d+m*e+q*f+a[14],c[15]=j*d+n*e+r*f+a[15];return c},mat4.translation=function(a){var b=new Float32Array(16);b._type="matrix",b[0]=b[5]=b[10]=b[15]=1,b[12]=a[0],b[13]=a[1],b[14]=a[2];return b},mat4.translate=function(a,b){var c=b[0],d=b[1],e=b[2];a[12]=a[0]*c+a[4]*d+a[8]*e+a[12],a[13]=a[1]*c+a[5]*d+a[9]*e+a[13],a[14]=a[2]*c+a[6]*d+a[10]*e+a[14],a[15]=a[3]*c+a[7]*d+a[11]*e+a[15];return a},mat4.scaling_of=function(a,b){var c=new Float32Array(16);c._type="matrix";var d=b[0],e=b[1],f=b[2];c[0]=a[0]*d,c[1]=a[1]*d,c[2]=a[2]*d,c[3]=a[3]*d,c[4]=a[4]*e,c[5]=a[5]*e,c[6]=a[6]*e,c[7]=a[7]*e,c[8]=a[8]*f,c[9]=a[9]*f,c[10]=a[10]*f,c[11]=a[11]*f,c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15];return c},mat4.scaling=function(a,b){var c=new Float32Array(16);c[0]=b[0],c[5]=b[1],c[10]=b[2],c[15]=1;return c},mat4.scale=function(a,b){var c=new Float32Array(16);c._type="matrix";var d=b[0],e=b[1],f=b[2];a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=f,a[9]*=f,a[10]*=f,a[11]*=f;return c},mat4.rotation_of=function(a,b,c){var d=c[0],e=c[1],f=c[2],g=Math.sqrt(d*d+e*e+f*f);if(!g)throw"zero-length axis";g!=1&&(d/=g,e/=g,f/=g);var h=Math.sin(b),i=Math.cos(b),j=1-i,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=d*d*j+i,x=e*d*j+f*h,y=f*d*j-e*h,z=d*e*j-f*h,A=e*e*j+i,B=f*e*j+d*h,C=d*f*j+e*h,D=e*f*j-d*h,E=f*f*j+i,F=new Float32Array(16);F._type="matrix",F[0]=k*w+o*x+s*y,F[1]=l*w+p*x+t*y,F[2]=m*w+q*x+u*y,F[3]=n*w+r*x+v*y,F[4]=k*z+o*A+s*B,F[5]=l*z+p*A+t*B,F[6]=m*z+q*A+u*B,F[7]=n*z+r*A+v*B,F[8]=k*C+o*D+s*E,F[9]=l*C+p*D+t*E,F[10]=m*C+q*D+u*E,F[11]=n*C+r*D+v*E,F[12]=a[12],F[13]=a[13],F[14]=a[14],F[15]=a[15];return F},mat4.rotation=function(a,b){var c=b[0],d=b[1],e=b[2],f=Math.sqrt(c*c+d*d+e*e);if(!f)throw"zero-length axis";f!=1&&(c/=f,d/=f,e/=f);var g=Math.sin(a),h=Math.cos(a),i=1-h,j=1,k=0,l=0,m=0,n=0,o=1,p=0,q=0,r=0,s=0,t=1,u=0,v=c*c*i+h,w=d*c*i+e*g,x=e*c*i-d*g,y=c*d*i-e*g,z=d*d*i+h,A=e*d*i+c*g,B=c*e*i+d*g,C=d*e*i-c*g,D=e*e*i+h,E=new Float32Array(16);E._type="matrix",E[0]=c*c*i+h,E[1]=d*c*i+e*g,E[2]=e*c*i-d*g,E[4]=c*d*i-e*g,E[5]=d*d*i+h,E[6]=e*d*i+c*g,E[8]=c*e*i+d*g,E[9]=d*e*i-c*g,E[10]=e*e*i+h,E[15]=1;return E},mat4.rotate=function(a,b,c){var d=c[0],e=c[1],f=c[2],g=Math.sqrt(d*d+e*e+f*f);if(!g)throw"zero-length axis";g!=1&&(d/=g,e/=g,f/=g);var h=Math.sin(b),i=Math.cos(b),j=1-i,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=d*d*j+i,x=e*d*j+f*h,y=f*d*j-e*h,z=d*e*j-f*h,A=e*e*j+i,B=f*e*j+d*h,C=d*f*j+e*h,D=e*f*j-d*h,E=f*f*j+i;a[0]=k*w+o*x+s*y,a[1]=l*w+p*x+t*y,a[2]=m*w+q*x+u*y,a[3]=n*w+r*x+v*y,a[4]=k*z+o*A+s*B,a[5]=l*z+p*A+t*B,a[6]=m*z+q*A+u*B,a[7]=n*z+r*A+v*B,a[8]=k*C+o*D+s*E,a[9]=l*C+p*D+t*E,a[10]=m*C+q*D+u*E,a[11]=n*C+r*D+v*E,a[12]=a[12],a[13]=a[13],a[14]=a[14],a[15]=a[15];return a},mat4.frustum=function(a,b,c,d,e,f){var g=new Float32Array(16);g._type="matrix";var h=b-a,i=d-c,j=f-e;g[0]=e*2/h,g[5]=e*2/i,g[8]=(b+a)/h,g[9]=(d+c)/i,g[10]=-(f+e)/j,g[11]=-1,g[14]=-(f*e*2)/j;return g},mat4.perspective=function(a,b,c,d){var e=c*Math.tan(a*Math.PI/360),f=e*b;return mat4.frustum(-f,f,-e,e,c,d)},mat4.ortho=function(a,b,c,d,e,f){var g=new Float32Array(16);g._type="matrix";var h=b-a,i=d-c,j=f-e;g[0]=2/h,g[5]=2/i,g[10]=-2/j,g[12]=-(a+b)/h,g[13]=-(d+c)/i,g[14]=-(f+e)/j,g[15]=1;return g},mat4.lookAt=function(a,b,c){var d=new Float32Array(16);d._type="matrix";var e=a[0],f=a[1],g=a[2],h=c[0],i=c[1],j=c[2],k=b[0],l=b[1],m=b[2];if(e==k&&f==l&&g==m)return mat4.identity();var n,o,p,q,r,s,t,u,v,w;n=e-b[0],o=f-b[1],p=g-b[2],w=Math.sqrt(n*n+o*o+p*p),n/=w,o/=w,p/=w,q=i*p-j*o,r=j*n-h*p,s=h*o-i*n;if(w=Math.sqrt(q*q+r*r+s*s))q/=w,r/=w,s/=w;t=o*s-p*r,u=p*q-n*s,v=n*r-o*q;if(w=Math.sqrt(t*t+u*u+v*v))t/=w,u/=w,v/=w;d[0]=q,d[1]=t,d[2]=n,d[4]=r,d[5]=u,d[6]=o,d[8]=s,d[9]=v,d[10]=p,d[12]=-(q*e+r*f+s*g),d[13]=-(t*e+u*f+v*g),d[14]=-(n*e+o*f+p*g),d[15]=1;return d},mat4.frobenius_norm=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]+a[4]*a[4]+a[5]*a[5]+a[6]*a[6]+a[7]*a[7]+a[8]*a[8]+a[9]*a[9]+a[10]*a[10]+a[11]*a[11]+a[12]*a[12]+a[13]*a[13]+a[14]*a[14]+a[15]*a[15])},mat4.map=function(a,b){return mat4.make(_.map(a,b))},mat4.str=function(a){return"[ ["+a[0]+"] ["+a[4]+"]"+"[ ["+a[8]+"] ["+a[12]+"]\n"+"[ ["+a[1]+"] ["+a[5]+"]"+"[ ["+a[9]+"] ["+a[13]+"]\n"+"[ ["+a[2]+"] ["+a[6]+"]"+"[ ["+a[10]+"] ["+a[14]+"]\n"+"[ ["+a[3]+"] ["+a[7]+"]"+"[ ["+a[11]+"] ["+a[15]+"] ]"},vec[2]=vec2,vec[3]=vec3,vec[4]=vec4,vec2.mat=mat2,vec3.mat=mat3,vec4.mat=mat4,vec.eps=1e-6,vec.make=function(a){return vec[a.length].make(a)},vec.equal=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].equal(a,b)},vec.plus=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].plus(a,b)},vec.minus=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].minus(a,b)},vec.negative=function(a){return vec[a.length].negative(a)},vec.scaling=function(a,b){return vec[a.length].scaling(a,b)},vec.schur_product=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].schur_product(a,b)},vec.normalized=function(a){return vec[a.length].schur_product(a)},vec.length=function(a){return vec[a.length].length(a)},vec.dot=function(a,b){if(a.length!=b.length)throw"mismatched lengths";return vec[a.length].dot(a,b)},vec.map=function(a,b){return vec[a.length].map(a,b)},vec.str=function(a){return a[a.length].str(a)},function(){function a(a){switch(a){case 4:return 2;case 9:return 3;case 16:return 4}throw"bad length"}mat[2]=mat2,mat[3]=mat3,mat[4]=mat4,mat2.vec=vec2,mat3.vec=vec3,mat4.vec=vec4,mat.eps=1e-6,mat.make=function(b){return mat[a(b.length)].make(b)},mat.map=function(b,c){return mat[a(b.length)].map(b,c)},mat.equal=function(b,c){if(b.length!=c.length)throw"mismatched lengths: "+b.length+", "+c.length;return mat[a(b.length)].equal(b,c)},mat.str=function(b){return mat[a(b.length)].str(b)}}(),Facet.attribute_buffer=function(a,b,c,d){var e=Facet._globals.ctx;d===undefined&&(d=!1);var f={"float":[e.FLOAT,Float32Array],"short":[e.SHORT,Int16Array],ushort:[e.UNSIGNED_SHORT,Uint16Array],"byte":[e.BYTE,Int8Array],ubyte:[e.UNSIGNED_BYTE,Uint8Array]};b=b||3,c=f[c||"float"];var g=new c[1](a),h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,g,e.STATIC_DRAW),h._shade_type="attribute_buffer",h.array=g,h.itemSize=b,h.numItems=a.length/b,h.bind=function(a){return function(b){e.bindBuffer(e.ARRAY_BUFFER,this),e.vertexAttribPointer(b,this.itemSize,a,d,0,0)}}(c[0]),h.draw=function(a){e.drawArrays(a,0,this.numItems)},h.bind_and_draw=function(a,b){this.bind(a),this.draw(b)};return h},function(){function b(b){var c=Facet._globals.ctx;if(b.batch_id!==a.batch_id){var d=b.attributes||{},e=b.uniforms||{},f=b.program,g=b.primitives,h;Facet.unload_batch(),a=b,b.set_caps(),c.useProgram(f);for(h in d){var i=f[h];_.isUndefined(i)||(c.enableVertexAttribArray(i),d[h].bind(i))}var j=0;_.each(f.uniforms,function(a){var b=a.uniform_name,d=a.uniform_call,e=a.get();if(_.isUndefined(e))throw"parameter "+b+" has not been set.";var g=facet_constant_type(e);if(g==="other")a._facet_active_uniform=function(a,b){return function(d){c.activeTexture(c.TEXTURE0+b),c.bindTexture(c.TEXTURE_2D,d),c.uniform1i(a,b)}}(f[b],j),j++;else if(g==="number"||g==="vector"||g==="boolean")a._facet_active_uniform=function(a,b){return function(d){a.call(c,b,d)}}(c[d],f[b]);else if(g==="matrix")a._facet_active_uniform=function(a,b){return function(d){c[a](b,!1,d)}}(d,f[b]);else throw"could not figure out parameter type! "+g;a._facet_active_uniform(e)})}b.draw_chunk()}var a={};Facet.unload_batch=function(){var b=Facet._globals.ctx;if(a.attributes){for(var c in a.attributes)b.disableVertexAttribArray(a.program[c]);_.each(a.program.uniforms,function(a){delete a._facet_active_uniform})}a={},b.disable(b.DEPTH_TEST),b.disable(b.BLEND),b.depthMask(!0)};var c=1;Facet.bake=function(a,d){function q(a,b){return{program:a,attributes:g(a),set_caps:d.mode&&d.mode[b]||Facet.DrawingMode.standard[b],draw_chunk:o,batch_id:c++}}function k(){return h(function(a,b){if(b==="gl_FragColor"){var c=d.gl_Position.swizzle("z"),e=d.gl_Position.swizzle("w"),f=c.div(e).add(1).div(2),g=Shade.vec(f,f.mul(256),f.mul(65536),f.mul(1<<24));return g}return a})}function j(){var a;d.pick_id?a=Shade(d.pick_id):a=Shade(Shade.id(f));return h(function(b,c){if(c==="gl_FragColor"){var e=d.pick_if||Shade(b).swizzle("a").gt(0);return a.discard_if(Shade.not(e))}return b})}function i(){return h(function(a,b){return a})}function h(a){var b={};_.each(d,function(c,d){Shade.is_program_parameter(d)&&(b[d]=a(c,d))});return Shade.program(b)}function g(a){return _.build(_.map(a.attribute_buffers,function(a){return[a._shade_name,a]}))}d=Shade.canonicalize_program_object(d),_.isUndefined(d.gl_FragColor)&&(d.gl_FragColor=Shade.vec(1,1,1,1));if(d.gl_Position.type.equals(Shade.Types.vec2))d.gl_Position=Shade.vec(d.gl_Position,0,1);else if(d.gl_Position.type.equals(Shade.Types.vec3))d.gl_Position=Shade.vec(d.gl_Position,1);else if(!d.gl_Position.type.equals(Shade.Types.vec4))throw"position appearance attribute must be vec2, vec3 or vec4";var e=Facet._globals.ctx,f=Facet.fresh_pick_id(),l={points:e.POINTS,line_strip:e.LINE_STRIP,line_loop:e.LINE_LOOP,lines:e.LINES,triangle_strip:e.TRIANGLE_STRIP,triangle_fan:e.TRIANGLE_FAN,triangles:e.TRIANGLES},m=l[a.type],n=a.elements,o;facet_typeOf(n)==="number"?o=function(){e.drawArrays(m,0,n)}:o=function(){n.bind_and_draw(n,m)};var p=[l[a.type],a.elements],r=q(i(),"set_draw_caps"),s=q(j(),"set_pick_caps"),t=q(k(),"set_unproject_caps"),u=[r,s,t],v={batch_id:f,draw:function(){b(u[Facet._globals.ctx._facet_globals.batch_render_mode])},_draw:function(){b(r)},_pick:function(){b(s)}};return v}}(),function(){}(),Facet.element_buffer=function(a){var b=Facet._globals.ctx,c=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,c);var d=new Uint16Array(a);b.bufferData(b.ELEMENT_ARRAY_BUFFER,d,b.STATIC_DRAW),c._shade_type="element_buffer",c.array=d,c.itemSize=1,c.numItems=a.length,c.bind=function(){b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this)},c.draw=function(a){b.drawElements(a,this.numItems,b.UNSIGNED_SHORT,0)},c.bind_and_draw=function(a,b){this.bind(a),this.draw(b)};return c},function(){var a=1;Facet.fresh_pick_id=function(b){b=b||1;var c=a;a+=b;return c}}(),Facet.id_buffer=function(a){if(facet_typeOf(a)!=="array")throw"id_buffer expects array of integers";var b=new Int32Array(a),c=new Uint8Array(b.buffer);return Facet.attribute_buffer(c,4,"ubyte",!0)},function(){function a(a){a._facet_globals={},a._facet_globals.display_callback=Facet.Scene.render,a._facet_globals.scene=[],a._facet_globals.batch_render_mode=0}Facet.init=function(b,c){b.unselectable=!0,b.onselectstart=function(){return!1};var d,e,f;c=_.defaults(c||{},{clearColor:[1,1,1,0],clearDepth:1,attributes:{alpha:!0,depth:!0}});if(c.clearColor.expression_type){if(!c.clearColor.is_constant())throw"clearColor must be constant expression";if(!c.clearColor.type.equals(Shade.Types.vec4))throw"clearColor must be vec4";e=_.toArray(c.clearColor.constant_value())}else e=c.clearColor;if(c.clearDepth.expression_type){if(!c.clearDepth.is_constant())throw"clearDepth must be constant expression";if(!c.clearDepth.type.equals(Shade.Types.float_t))throw"clearDepth must be float";f=c.clearDepth.constant_value()}else f=c.clearDepth;try{if("attributes"in c){d=WebGLUtils.setupWebGL(b,c.attributes);var g=d.getContextAttributes();for(var h in c.attributes)if(c.attributes[h]!==g[h])throw"requested attribute "+h+": "+c.attributes[h]+" could not be satisfied"}else d=WebGLUtils.setupWebGL(b);if(!d)throw"failed context creation";if(c.debugging){var i=function(a,b,c){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+b};d=WebGLDebugUtils.makeDebugContext(d,i,c.tracing)}d.viewportWidth=b.width,d.viewportHeight=b.height;var j=["mouseover","mousemove","mousedown","mouseout","mouseup"];for(var k=0;k<j.length;++k){var l=j[k],m=c[l];_.isUndefined(m)||function(a){function c(b){b.facetX=b.offsetX,b.facetY=d.viewportHeight-b.offsetY;return a(b)}b.addEventListener(l,c,!1)}(m)}var n,o=_.map(d.getSupportedExtensions(),function(a){return a.toLowerCase()});if(o.indexOf("oes_texture_float")==-1){alert("OES_texture_float is not available on your browser/computer! Facet will not work, sorry.");throw"insufficient GPU support"}d.getExtension("oes_texture_float")}catch(p){alert(p)}if(!d){alert("Could not initialise WebGL, sorry :-(");throw"failed initalization"}a(d),Facet.set_context(d),c.display&&(Facet._globals.ctx._facet_globals.display_callback=c.display),d.display=function(){this.viewport(0,0,this.viewportWidth,this.viewportHeight),this.clearDepth(f),this.clearColor.apply(d,e),this.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT),Facet._globals.ctx._facet_globals.display_callback()},d.resize=function(a,b){this.viewportWidth=a,this.viewportHeight=b,this.canvas.width=a,this.canvas.height=b,this.display()};return d}}(),Facet.load_image_into_texture=function(a){function g(){var f=Facet._globals.ctx;f.bindTexture(f.TEXTURE_2D,b),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0),f.texSubImage2D(f.TEXTURE_2D,0,d,e,a.width,a.height,f.RGBA,f.UNSIGNED_BYTE,a.buffer),Facet.unload_batch(),c()}function f(a){var f=Facet._globals.ctx;f.bindTexture(f.TEXTURE_2D,b),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0),f.texSubImage2D(f.TEXTURE_2D,0,d,e,f.RGBA,f.UNSIGNED_BYTE,a),Facet.unload_batch(),c(a)}a=_.defaults(a,{onload:function(){},x_offset:0,y_offset:0});var b=a.texture,c=a.onload,d=a.x_offset,e=a.y_offset;if(a.src){var h=new Image;h.onload=function(){f(h)},a.crossOrigin&&(h.crossOrigin=a.crossOrigin),h.src=a.src}else if(a.img)if(a.img.isComplete)f(a.img);else{var i=b.image.onload||function(){};a.img.onload=function(){f(a.img),i()}}else g()},Facet.identity=function(){return mat4.identity()},Facet.translation=function(a){function c(a){return mat4.translation(a)}function b(a){var b=mat3.create();b[6]=a[0],b[7]=a[1];return b}if(a.length===3)return c(a);if(arguments.length===3)return c(arguments);if(a.length===2)return b(a);if(arguments.length===2)return b(arguments);throw"invalid vector size for translation"},Facet.scaling=function(a){function d(a){return mat4.scaling(a)}function c(a){var b=mat3.create();b[0]=a[0],b[4]=a[1];return b}var b;if(a.length===3)return d(a);if(arguments.length===3)return d(arguments);if(a.length===2)return c(a);if(arguments.length===2)return c(arguments);throw"invalid size for scale"},Facet.rotation=function(a,b){return mat4.rotation(a,b)},Facet.look_at=function(a,b,c,d,e,f,g,h,i){return mat4.lookAt([a,b,c],[d,e,f],[g,h,i])},Facet.perspective=mat4.perspective,Facet.frustum=mat4.frustum,Facet.ortho=mat4.ortho,Facet.shear=function(a,b){return mat4.create([1,0,a,0,0,1,b,0,0,0,1,0,0,0,0,1])},Facet.model=function(a){function c(a,b){return function(c){var d=c.constant_value();for(var e=0;e<b;++e)a.push(d[e])}}var b,d={add:function(a,e){if(a==="type")d.type=e;else if(a==="elements")e._shade_type==="element_buffer"?d.elements=Shade(e):facet_typeOf(e)==="array"?d.elements=Shade(Facet.element_buffer(e)):d.elements=e;else if(e._shade_type==="attribute_buffer")d[a]=Shade(e),b=e.numItems;else if(facet_typeOf(e)==="array"){var f;if(facet_typeOf(e[0])!=="array"&&e[0]._facet_expression){var g=e[0].type.vec_dimension(),h=[];_.each(e,c(h,g)),f=Facet.attribute_buffer(h,g),d[a]=Shade(f),b=f.numItems}else f=Facet.attribute_buffer(e[0],e[1]),d[a]=Shade(f),b=f.numItems}else d[a]=e}};for(var e in a){var f=a[e];d.add(e,f)}if(!("elements"in d)){if(_.isUndefined(b))throw"could not figure out how many elements are in this model; consider passing an 'elements' field";d.elements=b}return d},function(){var a;Facet.Picker={draw_pick_scene:function(b){var c=Facet._globals.ctx;a||(a=Facet.render_buffer({width:c.viewportWidth,height:c.viewportHeight,mag_filter:c.NEAREST,min_filter:c.NEAREST})),b=b||c._facet_globals.display_callback;var d=c._facet_globals.batch_render_mode;c._facet_globals.batch_render_mode=1;try{a.with_bound_buffer(function(){c.clearColor(0,0,0,0),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),b()})}finally{c._facet_globals.batch_render_mode=d}},pick:function(b,c){var d=Facet._globals.ctx,e=new ArrayBuffer(4),f=new Uint8Array(4);d.readPixels(b,c,1,1,d.RGBA,d.UNSIGNED_BYTE,f),a.with_bound_buffer(function(){d.readPixels(b,c,1,1,d.RGBA,d.UNSIGNED_BYTE,f)});var g=new Uint32Array(f.buffer);return g[0]}}}(),Facet.profile=function(a,b,c,d){c&&c(),console.profile(a),setTimeout(function(){console.profileEnd(),d&&d()},b*1e3)},Facet.program=function(a,b){function d(a,b){var d=c.createShader(a);c.shaderSource(d,b),c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS)){alert(c.getShaderInfoLog(d)),console.log("Error message: "),console.log(c.getShaderInfoLog(d)),console.log("Failing shader: "),console.log(b);return null}return d}var c=Facet._globals.ctx,e=d(c.VERTEX_SHADER,a),f=d(c.FRAGMENT_SHADER,b),g=c.createProgram();c.attachShader(g,e),c.attachShader(g,f),c.linkProgram(g);if(!c.getProgramParameter(g,c.LINK_STATUS)){alert("Could not initialise shaders");return null}var h=c.getProgramParameter(g,c.ACTIVE_UNIFORMS),i=/.*\[0\]/,j;for(var k=0;k<h;++k){j=c.getActiveUniform(g,k);if(i.test(j.name)){var l=j.name.substr(0,j.name.length-3);g[l]=c.getUniformLocation(g,l)}else g[j.name]=c.getUniformLocation(g,j.name)}var m=c.getProgramParameter(g,c.ACTIVE_ATTRIBUTES);for(k=0;k<m;++k)j=c.getActiveAttrib(g,k),g[j.name]=c.getAttribLocation(g,j.name);return g},Facet.render_buffer=function(a){var b=Facet._globals.ctx,c=b.createFramebuffer();a=_.defaults(a||{},{width:512,height:512,mag_filter:b.LINEAR,min_filter:b.LINEAR,wrap_s:b.CLAMP_TO_EDGE,wrap_t:b.CLAMP_TO_EDGE});var d=Facet.texture(a);c.init=function(b,c){var e=Facet._globals.ctx;this.width=a.width,this.height=a.height,e.bindFramebuffer(e.FRAMEBUFFER,this);var f=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,f),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,d,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,f);var g=e.checkFramebufferStatus(e.FRAMEBUFFER);try{switch(g){case e.FRAMEBUFFER_COMPLETE:break;case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case e.FRAMEBUFFER_UNSUPPORTED:throw"incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"incomplete framebuffer: "+g}}finally{e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null)}},c.init(a.width,a.height),c._shade_type="render_buffer",c.texture=d,c.resize=function(b,c){a.width=b,a.height=c,this.texture.init(a),this.init(b,c)},c.with_bound_buffer=function(a){var b=Facet._globals.ctx;try{b.bindFramebuffer(b.FRAMEBUFFER,this),b.viewport(0,0,this.width,this.height);return a()}finally{b.bindFramebuffer(b.FRAMEBUFFER,null)}},c.make_screen_batch=function(a){var b=Facet.Models.square();return Facet.bake(b,{position:b.vertex.mul(2).sub(1),color:a(Shade.texture2D(this.texture,b.tex_coord),b.tex_coord)})};return c},Facet.set_context=function(a){Facet._globals.ctx=a},Facet.texture=function(a){var b=Facet._globals.ctx,c=b.createTexture();c._shade_type="texture",c.init=function(a){function d(){var b=Facet._globals.ctx;b.bindTexture(b.TEXTURE_2D,c),b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),c.image?(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),b.pixelStorei(b.UNPACK_COLORSPACE_CONVERSION_WEBGL,b.BROWSER_DEFAULT_WEBGL),b.texImage2D(b.TEXTURE_2D,0,a.format,a.format,a.type,c.image)):(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),b.pixelStorei(b.UNPACK_COLORSPACE_CONVERSION_WEBGL,b.NONE),b.texImage2D(b.TEXTURE_2D,0,a.format,c.width,c.height,0,a.format,a.type,c.buffer)),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,a.mag_filter),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,a.min_filter),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,a.wrap_s),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,a.wrap_t),a.mipmaps&&b.generateMipmap(b.TEXTURE_2D),b.bindTexture(b.TEXTURE_2D,null),a.onload(c),Facet.unload_batch()}var b=Facet._globals.ctx;a=_.defaults(a,{onload:function(){},mipmaps:!1,mag_filter:b.LINEAR,min_filter:b.LINEAR,wrap_s:b.CLAMP_TO_EDGE,wrap_t:b.CLAMP_TO_EDGE,format:b.RGBA,type:b.UNSIGNED_BYTE}),this.width=a.width,this.height=a.height;var c=this;delete this.buffer,delete this.image;if(a.src){var e=new Image;e.onload=function(){c.width=e.width,c.height=e.height,d()},this.image=e,a.crossOrigin&&(e.crossOrigin=a.crossOrigin),e.src=a.src}else a.img?(this.image=a.img,this.image.isComplete?(this.width=this.image.width,this.height=this.image.height,d()):this.image.onload=function(){c.width=c.image.width,c.height=c.image.height,d()}):(this.buffer=a.buffer||null,d())},c.init(a);return c},function(){var a,b,c;Facet.Unprojector={draw_unproject_scene:function(d){var e=Facet._globals.ctx;a||(a=Facet.render_buffer({width:e.viewportWidth,height:e.viewportHeight,TEXTURE_MAG_FILTER:e.NEAREST,TEXTURE_MIN_FILTER:e.NEAREST}));if(!c){var f=Shade(Facet.attribute_buffer([-1,-1,1,-1,-1,1,1,1],2)),g=Facet.model({type:"triangle_strip",elements:4,vertex:f});b=Shade.parameter("float"),c=Facet.bake(g,{position:Shade.vec(f,b),color:Shade.vec(1,1,1,1)})}d=d||e._facet_globals.display_callback;var h=e._facet_globals.batch_render_mode;e._facet_globals.batch_render_mode=2,a.with_bound_buffer(function(){var a=e.getParameter(e.COLOR_CLEAR_VALUE),b=e.getParameter(e.DEPTH_CLEAR_VALUE);e.clearColor(b,b/256,b/65536,b/(1<<24)),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT);try{d()}finally{e.clearColor(a[0],a[1],a[2],a[3]),e._facet_globals.batch_render_mode=h}})},unproject:function(b,c){var d=Facet._globals.ctx,e=new ArrayBuffer(4),f=new Uint8Array(4);d.readPixels(b,c,1,1,d.RGBA,d.UNSIGNED_BYTE,f),a.with_bound_buffer(function(){d.readPixels(b,c,1,1,d.RGBA,d.UNSIGNED_BYTE,f)});return f[0]/256+f[1]/65536+f[2]/(1<<24)}}}(),Facet.Net={},function(){var a=function(a,b,c){function f(a,b){d[b]=a,e(d)}var d={},e=_.after(a.length,b);_.each(a,function(a){c(a,f)})};Facet.Net.ajax=function(b,c){if(facet_typeOf(b)==="array")return a(b,c,Facet.Net.ajax);var d=new XMLHttpRequest;d.open("GET",b,!0);var e=!1;d.onreadystatechange=function(){d.readyState===4&&d.status===200&&!e&&(c(d.response,b),e=!0)},d.send(null)},Facet.Net.json=function(b,c){if(facet_typeOf(b)==="array")return a(b,c,Facet.Net.json);var d=new XMLHttpRequest;d.open("GET",b,!0);var e=!1;d.onreadystatechange=function(){d.readyState===4&&d.status===200&&!e&&(c(JSON.parse(d.response),b),e=!0)},d.send(null)},Facet.Net.binary=function(b,c){if(facet_typeOf(b)==="array")return a(b,c,Facet.Net.binary);var d=new window.XMLHttpRequest,e=!1;d.onreadystatechange=function(){if(d.readyState===4&&d.status===200&&e!==!0){if(d.responseType==="arraybuffer")c(d.response,b);else if(d.mozResponseArrayBuffer!==null)c(d.mozResponseArrayBuffer,b);else if(d.responseText!==null){var a=String(d.responseText),f=Array(a.length);for(var g=0;g<a.length;g++)f[g]=a.charCodeAt(g)&255;var h=new Uint8Array(f);c(h.buffer,b)}e=!0}},d.open("GET",b,!0),d.hasOwnProperty("responseType")?d.responseType="arraybuffer":d.overrideMimeType("text/plain; charset=x-user-defined"),d.send()}}(),Facet.Scale={},Facet.Scale.Geo={},Facet.Scale
.Geo.mercator_to_spherical=function(a,b){var c=b.sinh().atan(),d=a;return Facet.Scale.Geo.latlong_to_spherical(c,d)},Facet.Scale.Geo.latlong_to_spherical=function(a,b){a=Shade(a),b=Shade(b);var c=a.cos();return Shade.vec(b.sin().mul(c),a.sin(),b.cos().mul(c),1)},Facet.DrawingMode={},Facet.DrawingMode.additive={set_draw_caps:function(){var a=Facet._globals.ctx;a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE),a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)},set_pick_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)},set_unproject_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)}},Facet.DrawingMode.over={set_draw_caps:function(){var a=Facet._globals.ctx;a.enable(a.BLEND),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA),a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)},set_pick_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)},set_unproject_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!1)}},Facet.DrawingMode.over_with_depth={set_draw_caps:function(){var a=Facet._globals.ctx;a.enable(a.BLEND),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL)},set_pick_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL)},set_unproject_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL)}},Facet.DrawingMode.standard={set_draw_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS)},set_pick_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS)},set_unproject_caps:function(){var a=Facet._globals.ctx;a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS)}},Facet.DrawingMode.pass={set_draw_caps:function(){var a=Facet._globals.ctx;a.disable(a.DEPTH_TEST),a.depthMask(!1)},set_pick_caps:function(){var a=Facet._globals.ctx;a.disable(a.DEPTH_TEST),a.depthMask(!1)},set_unproject_caps:function(){var a=Facet._globals.ctx;a.disable(a.DEPTH_TEST),a.depthMask(!1)}},Facet.Data={},Facet.Data.table=function(a){function b(){}a=_.defaults(a||{},{number_columns:[]});if(_.isUndefined(a.data))throw"data is a required field";if(_.isUndefined(a.data))throw"columns is a required field";b.prototype={is_numeric_row_complete:function(a){for(var b=0;b<this.number_columns.length;++b){var c=this.columns[b],d=a[c];if(typeof d!="number")return!1}return this.number_columns.length>0}};var c=new b;for(var d in a)c[d]=a[d];return c},Facet.Data.texture_table=function(a){var b=Facet._globals.ctx,c=[];for(var d=0;d<a.data.length;++d){var e=a.data[d];if(!a.is_numeric_row_complete(e))continue;for(var f=0;f<a.number_columns.length;++f){var g=a.columns[a.number_columns[f]],h=e[g];if(typeof h!="number")throw"texture_table requires numeric values";c.push(h)}}var i=a.number_columns.length,j=c.length/a.number_columns.length,k=1;return Facet.Data.texture_array({n_rows:j,n_cols:i,elements:c})},Facet.Data.texture_array=function(a){var b=Facet._globals.ctx,c=a.elements,d=a.n_cols,e=a.n_rows,f=1;while(4*f*f<c.length)f=f*2;var g=Math.ceil(c.length/(4*f)),h;if(f*g===c.length)facet_typeOf(c)==="array"?h=new Float32Array(c):h=c;else{h=new Float32Array(f*g*4);for(var i=0;i<c.length;++i)h[i]=c[i]}var j=Facet.texture({width:f,height:g,buffer:h,type:b.FLOAT,format:b.RGBA,min_filter:b.NEAREST,mag_filter:b.NEAREST}),k=Shade(function(a,b){var c=a.mul(d).add(b),e=c.mod(4),g=c.div(4).floor(),h=g.mod(f),i=g.div(f).floor(),j=Shade.vec(h,i,e);return j}),l=Shade(function(a,b){var c=k(a,b),d=c.swizzle("xy").add(Shade.vec(.5,.5)).div(Shade.vec(f,g));return Shade.texture2D(j,d).at(c.z())});return{n_rows:e,n_cols:d,at:l,index:k}},Facet.Data.array_1d=function(a){var b=Facet._globals.ctx,c=a,d=1;while(4*d*d<c.length)d=d*2;var e=Math.ceil(c.length/(4*d)),f;if(d*e===c.length)facet_typeOf(c)==="array"?f=new Float32Array(c):f=c;else{f=new Float32Array(d*e*4);for(var g=0;g<c.length;++g)f[g]=c[g]}var h=Facet.texture({width:d,height:e,buffer:f,type:b.FLOAT,format:b.RGBA,min_filter:b.NEAREST,min_filter:b.NEAREST}),i=Shade(function(a){var b=a.mod(4),c=a.div(4).floor(),e=c.mod(d),f=c.div(d).floor(),g=Shade.vec(e,f,b);return g}),j=Shade(function(a){var b=i(a),c=b.swizzle("xy").add(Shade.vec(.5,.5)).div(Shade.vec(d,e));return Shade.texture2D(h,c).at(b.z())});return{length:f.length,at:j,index:i}};var Shade=function(a){return Shade.make(a)};(function(){Shade.debug=!1,Shade.make=function(a){if(_.isUndefined(a))throw"expected a value, got undefined instead";var b=facet_typeOf(a);if(b==="string")throw"strings are not valid shade expressions";if(b==="boolean"||b==="number"){if(isNaN(a))throw"nans are not valid in shade expressions";return Shade.constant(a)}if(b==="array")return Shade.seq(a);if(b==="function")return function(){var b=[];for(var c=0;c<arguments.length;++c)b.push(Shade.make(arguments[c]));return a.apply(this,b)};b=facet_constant_type(a);if(b==="vector"||b==="matrix")return Shade.constant(a);if(a._shade_type==="attribute_buffer")return Shade.attribute_from_buffer(a);if(a._shade_type==="render_buffer")return Shade.sampler2D_from_texture(a.texture);if(a._shade_type==="texture")return Shade.sampler2D_from_texture(a);return a},Shade.memoize_on_field=function(a,b,c){c=c||function(a){return a};return function(){_.isUndefined(this._caches[a])&&(this._caches[a]={}),_.isUndefined(this._caches[a][arguments[0]])&&(this._caches[a][arguments[0]]=b.apply(this,arguments));return this._caches[a][arguments[0]]}},function(){var a={_caches:{}};a.fun=Shade.memoize_on_field("_cache",function(a){return Shade._create_concrete_value_exp({parents:[],type:a,value:function(){throw"<unknown> should never get to compilation"}})},function(a){return a.repr()}),Shade.unknown=function(b){return a.fun(b)}}(),Shade.Camera={},Shade.Camera.perspective=function(a){a=_.defaults(a||{},{look_at:[Shade.vec(0,0,0),Shade.vec(0,0,-1),Shade.vec(0,1,0)],field_of_view_y:45,near_distance:.1,far_distance:100});var b=a.field_of_view_y,c=a.near_distance,d=a.far_distance,e;if(a.aspect_ratio)e=a.aspect_ratio;else{var f=Facet._globals.ctx;if(_.isUndefined(f))throw"aspect_ratio is only optional with an active Facet context";e=f.viewportWidth/f.viewportHeight}var g=Shade.look_at(a.look_at[0],a.look_at[1],a.look_at[2]),h=Shade.perspective_matrix(b,e,c,d),i=Shade.mul(h,g),j=function(a){return j.project(a)};j.project=function(a){return i.mul(a)},j.eye_vertex=function(a){var b=a.type;return g.mul(a)};return j},Shade.Camera.ortho=function(a){function o(a){return o.project(a)}function l(){var a=Shade.add(e,d).div(2),c=Shade.sub(g,f).div(2),j=c.mul(b),k=a.sub(j),l=a.add(j),m=g,n=f;return Shade.ortho(k,l,n,m,h,i)}function k(){var a=Shade.add(g,f).div(2),c=Shade.sub(e,d).div(2),j=c.div(b),k=d,l=e,m=a.add(j),n=a.sub(j);return Shade.ortho(k,l,n,m,h,i)}a=_.defaults(a||{},{left:-1,right:1,bottom:-1,top:1,near:-1,far:1});var b;if(a.aspect_ratio)b=a.aspect_ratio;else{var c=Facet._globals.ctx;if(_.isUndefined(c))throw"aspect_ratio is only optional with an active Facet context";b=c.viewportWidth/c.viewportHeight}var d,e,f,g,h=a.near,i=a.far;if(!_.isUndefined(a.center)&&!_.isUndefined(a.zoom)){var j=Shade.div(1,a.zoom);d=a.center.at(0).sub(j),e=a.center.at(0).add(j),f=a.center.at(1).sub(j),g=a.center.at(1).add(j)}else d=a.left,e=a.right,f=a.bottom,g=a.top;var m=Shade.sub(e,d).div(Shade.sub(g,f)),n=m.gt(b).ifelse(k(),l());o.project=function(a){return n.mul(a)};return o},function(){var a={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370D8",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#D87093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},b=/ *rgb *\( *(\d+) *, *(\d+) *, *(\d+) *\) */;Shade.color=function(c,d){_.isUndefined(d)&&(d=1);if(c[0]==="#"){if(c.length===4)return Shade.vec(parseInt(c[1],16)/15,parseInt(c[2],16)/15,parseInt(c[3],16)/15,d);if(c.length==7)return Shade.vec(parseInt(c.substr(1,2),16)/255,parseInt(c.substr(3,2),16)/255,parseInt(c.substr(5,2),16)/255,d);throw"hex specifier must be either #rgb or #rrggbb"}var e=b.exec(c);if(e)return Shade.vec(parseInt(e[1],10)/255,parseInt(e[2],10)/255,parseInt(e[3],10)/255,d);if(c in a)return Shade.color(a[c],d);throw"unrecognized color specifier "+c}}(),Shade.variable=function(a){return Shade._create_concrete_exp({parents:[],type:a,evaluate:function(){return this.glsl_name},compile:function(){}})},Shade.range=function(a,b){var c=Shade.make(a).as_int(),d=Shade.make(b).as_int();return{begin:c,end:d,value:function(a){return a},average:function(){var a=Shade.variable(Shade.Types.int_t),b=this.value(a),c=b.type,d,e=Shade.variable(c);if(b.type.equals(Shade.Types.int_t))d=Shade.Types.float_t;else if(_.any([Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec3,Shade.Types.vec4,Shade.Types.mat2,Shade.Types.mat3,Shade.Types.mat4],function(a){return a.equals(c)}))d=c;else throw"Type error, average can't support range of type "+c.repr();return Shade._create_concrete_exp({parents:[this.begin,this.end,a,e,b],type:d,evaluate:function(){return this.glsl_name+"()"},element:Shade.memoize_on_field("_element",function(a){if(this.type.is_pod()){if(a===0)return this;throw this.type.repr()+" is an atomic type"}return this.at(a)}),compile:function(a){var b=this.parents[0],c=this.parents[1],d=this.parents[2],e=this.parents[3],f=this.parents[4];a.strings.push(this.type.repr(),this.glsl_name,"() {\n"),a.strings.push("    ",e.type.declare(e.glsl_name),"=",e.type.zero,";\n"),a.strings.push("    for (int",d.evaluate(),"=",b.evaluate(),";",d.evaluate(),"<",c.evaluate(),";","++",d.evaluate(),") {\n"),a.strings.push("        ",e.evaluate(),"=",e.evaluate(),"+",f.evaluate(),";\n"),a.strings.push("    }\n"),a.strings.push("    return",this.type.repr(),"(",e.evaluate(),")/float(",c.evaluate(),"-",b.evaluate(),");\n"),a.strings.push("}\n")}})}}},Shade.unique_name=function(){var a=0;return function(){a=a+1;return"_unique_name_"+a}}(),Shade._create=function(){var a=0;return function(b,c){var d=function(){return d.call_operator.apply(d,_.toArray(arguments))};for(var e in c)d[e]=c[e];d.guid="GUID_"+a,d._caches={},a+=1,d.__proto__=b;return d}}(),Shade._create_concrete=function(a,b){function c(c){for(var d=0;d<b.length;++d){var e=b[d];if(!(e in c))throw"new expression missing "+b[d];if(_.isUndefined(c[e]))throw"field '"+e+"' cannot be undefined"}return Shade._create(a,c)}return c},Shade.Types={},Shade.Types.base_t={is_floating:function(){return!1},is_integral:function(){return!1},is_array:function(){return!1},is_pod:function(){return!1},is_vec:function(){return!1},is_mat:function(){return!1},vec_dimension:function(){throw"is_vec() === false, cannot call vec_dimension"},is_function:function(){return!1},is_sampler:function(){return!1},equals:function(a){if(_.isUndefined(a))throw"type cannot be compared to undefined";return this.repr()==a.repr()},swizzle:function(a){throw"type '"+this.repr()+"' does not support swizzling"},element_type:function(a){throw"invalid call: atomic expression"},declare:function(a){return this.repr()+" "+a}},Shade.basic=function(a){function b(a){return a==="float"?!0:a==="int"?!0:a==="bool"?!0:a==="void"?!0:a==="sampler2D"?!0:a.substring(0,3)==="mat"&&Number(a[3])>1&&Number(a[3])<5?!0:a.substring(0,3)==="vec"&&Number(a[3])>1&&Number(a[3])<5?!0:a.substring(0,4)==="bvec"&&Number(a[4])>1&&Number(a[4])<5?!0:a.substring(0,4)==="ivec"&&Number(a[4])>1&&Number(a[4])<5?!0:!1}if(!b(a))throw"invalid basic type '"+a+"'";return Shade._create(Shade.Types.base_t,{declare:function(b){return a+" "+b},repr:function(){return a},swizzle:function(a){if(!this.is_vec())throw"swizzle requires a vec";var b=this.repr(),c=Number(b[b.length-1]),d,e;switch(c){case 2:d=/[rgxyst]+/,e=[/[rg]/,/[xy]/,/[st]/];break;case 3:d=/[rgbxyzstp]+/,e=[/[rgb]/,/[xyz]/,/[stp]/];break;case 4:d=/[rgbazxyzwstpq]+/,e=[/[rgba]/,/[xyzw]/,/[stpq]/];break;default:throw"internal error on swizzle"}if(!a.match(d))throw"invalid swizzle pattern '"+a+"'";var f=0;for(var g=0;g<e.length;++g)a.match(e[g])&&(f+=1);if(f!=1)throw"swizzle pattern '"+a+"' belongs to more than one group";return a.length===1?this.array_base():Shade.basic(b.substring(0,b.length-1)+a.length)},is_pod:function(){var a=this.repr();return["float","bool","int"].indexOf(a)!==-1},is_vec:function(){var a=this.repr();return a.substring(0,3)==="vec"?!0:a.substring(0,4)==="ivec"?!0:a.substring(0,4)==="bvec"?!0:!1},is_mat:function(){var a=this.repr();return a.substring(0,3)==="mat"?!0:!1},vec_dimension:function(){var a=this.repr();if(a.substring(0,3)==="vec")return parseInt(a[3],10);if(a.substring(0,4)==="ivec"||a.substring(0,4)==="bvec")return parseInt(a[4],10);if(this.repr()==="float"||this.repr()==="int"||this.repr()==="bool")return 1;throw this.is_vec()?"internal error":"is_vec() === false, cannot call vec_dimension"},is_array:function(){var a=this.repr();return a.substring(0,3)==="mat"?!0:this.is_vec()?!0:!1},array_base:function(){var a=this.repr();if(a.substring(0,3)==="mat")return Shade.basic("vec"+a[3]);if(a.substring(0,3)==="vec")return Shade.basic("float");if(a.substring(0,4)==="bvec")return Shade.basic("bool");if(a.substring(0,4)==="ivec")return Shade.basic("int");if(a=="float")return Shade.basic("float");throw"datatype not array"},size_for_vec_constructor:function(){var a=this.repr();if(this.is_array())return this.array_size();if(a==="float"||a==="bool"||a==="int")return 1;throw"not usable inside vec constructor"},array_size:function(){if(this.is_vec())return this.vec_dimension();var a=this.repr();if(a.substring(0,3)==="mat")return parseInt(a[3],10);throw"datatype not array"},is_floating:function(){var a=this.repr();return a==="float"?!0:a.substring(0,3)==="vec"?!0:a.substring(0,3)==="mat"?!0:!1},is_integral:function(){var a=this.repr();return a==="int"?!0:a.substring(0,4)==="ivec"?!0:!1},is_sampler:function(){var a=this.repr();return a==="sampler2D"?!0:!1},element_type:function(a){if(this.is_pod()){if(a===0)return this;throw"invalid call: "+this.repr()+" is atomic"}if(this.is_vec()){var b=this.repr()[0],c=this.array_size();if(a<0||a>=c)throw"invalid call: "+this.repr()+" has no element "+a;if(b==="v")return Shade.Types.float_t;if(b==="b")return Shade.Types.bool_t;if(b==="i")return Shade.Types.int_t;throw"internal error"}throw"unimplemented for mats"},constant_equal:function(a,b){if(this.is_pod())return a===b;if(this.is_vec()||this.is_mat())return _.all(_.range(a.length),function(c){return a[c]===b[c]});throw"bad type for equality comparison: "+this.repr()}})},Shade.Types.array=function(a,b){return Shade._create(Shade.Types.base_t,{is_array:function(){return!0},declare:function(c){return a.declare(c)+"["+b+"]"},repr:function(){return a.repr()+"["+b+"]"},array_size:function(){return b},array_base:function(){return a}})},Shade.Types.function_t=function(a,b){return Shade._create(Shade.Types.base_t,{repr:function(){return"("+a.repr()+")("+", ".join(b.map(function(a){return a.repr()}))},is_function:function(){return!0},function_return_type:function(){return a},function_parameter:function(a){return b[a]},function_parameter_count:function(){return b.length}})},function(){var a=["mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4"];for(var b=0;b<a.length;++b)Shade.Types[a[b]]=Shade.basic(a[b]);Shade.Types.float_t=Shade.basic("float"),Shade.Types.bool_t=Shade.basic("bool"),Shade.Types.int_t=Shade.basic("int"),Shade.Types.sampler2D=Shade.basic("sampler2D"),Shade.Types.int_t.zero="0",Shade.Types.float_t.zero="0.0",Shade.Types.vec2.zero="vec2(0,0)",Shade.Types.vec3.zero="vec3(0,0,0)",Shade.Types.vec4.zero="vec4(0,0,0,0)",Shade.Types.mat2.zero="mat2(0,0,0,0)",Shade.Types.mat3.zero="mat3(0,0,0,0,0,0,0,0,0)",Shade.Types.mat4.zero="mat4(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)"}(),Shade.VERTEX_PROGRAM_COMPILE=1,Shade.FRAGMENT_PROGRAM_COMPILE=2,Shade.UNSET_PROGRAM_COMPILE=3,Shade.CompilationContext=function(a){return{freshest_glsl_name:0,compile_type:a||Shade.UNSET_PROGRAM_COMPILE,float_precision:"highp",strings:[],initialization_exprs:[],declarations:{uniform:{},attribute:{},varying:{}},source:function(){return this.strings.join(" ")},request_fresh_glsl_name:function(){var a=this.freshest_glsl_name++;return"glsl_name_"+a},declare:function(a,b,c,d){if(_.isUndefined(c))throw"must define type";if(b in d){var e=d[b];if(!e.equals(c))throw"compile error: different expressions use conflicting types for '"+a+" "+b+"': '"+e.repr()+"', '"+c.repr()+"'"}else d[b]=c,this.strings.push(a+" "+c.declare(b)+";\n")},declare_uniform:function(a,b){this.declare("uniform",a,b,this.declarations.uniform)},declare_varying:function(a,b){this.declare("varying",a,b,this.declarations.varying)},declare_attribute:function(a,b){this.declare("attribute",a,b,this.declarations.attribute)},compile:function(a){var b=a.sorted_sub_expressions(),c,d=this;_.each(b,function(a){a.children_count=0,a.is_unconditional=!1,a.glsl_name=d.request_fresh_glsl_name(),a.set_requirements(this);for(var b=0;b<a.parents.length;++b)a.parents[b].children_count++}),b[b.length-1].is_unconditional=!0,c=b.length;while(c--){var e=b[c];e.propagate_conditions()}this.strings.push("precision",this.float_precision,"float;\n");for(c=0;c<b.length;++c)b[c].compile(this);this.strings.push("void main() {\n");for(c=0;c<this.initialization_exprs.length;++c)this.strings.push("    ",this.initialization_exprs[c],";\n");this.strings.push("    ",a.evaluate(),";\n","}\n")},add_initialization:function(a){this.initialization_exprs.push(a)},value_function:function(){this.strings.push(arguments[0].type.repr(),arguments[0].glsl_name,"(void) {\n","    return ");for(var a=1;a<arguments.length;++a)this.strings.push(arguments[a]);this.strings.push(";\n}\n")},void_function:function(){this.strings.push("void",arguments[0].glsl_name,"(void) {\n","    ");for(var a=1;a<arguments.length;++a)this.strings.push(arguments[a]);this.strings.push(";\n}\n")}}},Shade.Exp={debug_print:function(a){function d(a,e){var f,g=Array(e+2).join(" ");if(a.parents.length===0)b.push(g+"["+a.expression_type+":"+a.guid+"]"+" ()");else{b.push(g+"["+a.expression_type+":"+a.guid+"]"+" (");for(f=0;f<a.parents.length;++f)c[a.parents[f].guid]?b.push(g+"  {{"+a.parents[f].guid+"}}"):(d(a.parents[f],e+2),c[a.parents[f].guid]=1);b.push(g+")")}}var b=[],c={};d(this,0),a=a||function(a){var b=a.join("\n");console.log(b)},a(b)},evaluate:function(){return this.glsl_name+"()"},parent_is_unconditional:function(a){return!0},propagate_conditions:function(){for(var a=0;a<this.parents.length;++a)this.parents[a].is_unconditional=this.parents[a].is_unconditional||this.is_unconditional&&this.parent_is_unconditional(a)},set_requirements:function(){},stage:null,sorted_sub_expressions:function(){var a=[],b=function(c){if(a.indexOf(c)==-1){var d=c.parents;if(_.isUndefined(d))throw"Internal error: expression "+c.evaluate()+" has undefined parents.";for(var e=0;e<d.length;++e)b(d[e]);a.push(c)}};b(this);return a},is_constant:function(){return!1},constant_value:function(){throw"invalid call: this.is_constant() == false"},element_is_constant:function(a){return!1},element_constant_value:function(a){throw"invalid call: no constant elements"},element:function(a){throw"invalid call: atomic expression"},add:function(a){return Shade.add(this,a)},mul:function(a){return Shade.mul(this,a)},div:function(a){return Shade.div(this,a)},mod:function(a){return Shade.mod(this,a)},sub:function(a){return Shade.sub(this,a)},norm:function(){return Shade.norm(this)},distance:function(a){return Shade.distance(this,a)},dot:function(a){return Shade.dot(this,a)},cross:function(a){return Shade.cross(this,a)},normalize:function(){return Shade.normalize(this)},reflect:function(a){return Shade.reflect(this,a)},refract:function(a,b){return Shade.refract(this,a,b)},texture2D:function(a){return Shade.texture2D(this,a)},clamp:function(a,b){return Shade.clamp(this,a,b)},min:function(a){return Shade.min(this,a)},max:function(a){return Shade.max(this,a)},per_vertex:function(){return Shade.per_vertex(this)},discard_if:function(a){return Shade.discard_if(this,a)},call_operator:function(){return this.mul.apply(this,arguments)},as_int:function(){if(this.type.equals(Shade.Types.int_t))return this;var a=this;return Shade._create_concrete_value_exp({parents:[a],type:Shade.Types.int_t,value:function(){return"int("+this.parents[0].evaluate()+")"},is_constant:function(){return a.is_constant()},constant_value:function(){var b=a.constant_value();return Math.floor(b)},expression_type:"cast(int)"})},as_bool:function(){if(this.type.equals(Shade.Types.bool_t))return this;var a=this;return Shade._create_concrete_value_exp({parents:[a],type:Shade.Types.bool_t,value:function(){return"bool("+this.parents[0].evaluate()+")"},is_constant:function(){return a.is_constant()},constant_value:function(){var b=a.constant_value();return~~b},expression_type:"cast(bool)"})},as_float:function(){if(this.type.equals(Shade.Types.float_t))return this;var a=this;return Shade._create_concrete_value_exp({parents:[a],type:Shade.Types.float_t,value:function(){return"float("+this.parents[0].evaluate()+")"},is_constant:function(){return a.is_constant()},constant_value:function(){var b=a.constant_value();return Number(b)},expression_type:"cast(float)"})},swizzle:function(a){function b(a){function b(a){switch(a.toLowerCase()){case"r":return 0;case"g":return 1;case"b":return 2;case"a":return 3;case"x":return 0;case"y":return 1;case"z":return 2;case"w":return 3;case"s":return 0;case"t":return 1;case"p":return 2;case"q":return 3;default:throw"invalid swizzle pattern"}}var c=[];for(var d=0;d<a.length;++d)c.push(b(a[d]));return c}var c=this,d=b(a);return Shade._create_concrete_exp({parents:[c],type:c.type.swizzle(a),expression_type:"swizzle{"+a+"}",evaluate:function(){return this._must_be_function_call?this.glsl_name+"()":this.parents[0].evaluate()+"."+a},is_constant:Shade.memoize_on_field("_is_constant",function(){var a=this;return _.all(d,function(b){return a.parents[0].element_is_constant(b)})}),constant_value:Shade.memoize_on_field("_constant_value",function(){if(this.type.is_pod())return this.parents[0].element_constant_value(d[0]);var a=this,b=_.map(d,function(b){return a.parents[0].element_constant_value(b)}),c=this.type.vec_dimension();switch(c){case 2:return vec2.make(b);case 3:return vec3.make(b);case 4:return vec4.make(b);default:throw"bad vec dimension "+c}}),element:function(a){return this.parents[0].element(d[a])},element_is_constant:Shade.memoize_on_field("_element_is_constant",function(a){return this.parents[0].element_is_constant(d[a])}),element_constant_value:Shade.memoize_on_field("_element_constant_value",function(a){return this.parents[0].element_constant_value(d[a])}),compile:function(b){this._must_be_function_call&&(this.precomputed_value_glsl_name=b.request_fresh_glsl_name(),b.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),b.add_initialization(this.precomputed_value_glsl_name+" = "+this.parents[0].evaluate()+"."+a),b.value_function(this,this.precomputed_value_glsl_name))}})},at:function(a){var b=this;a=Shade.make(a),a._must_be_function_call=!0;if(!a.type.equals(Shade.Types.float_t)&&!a.type.equals(Shade.Types.int_t))throw"at expects int or float, got '"+a.type.repr()+"' instead";return Shade._create_concrete_exp({parents:[b,a],type:b.type.array_base(),expression_type:"index",evaluate:function(){return this.parents[1].type.is_integral()?this.parents[0].evaluate()+"["+this.parents[1].evaluate()+"]":this.parents[0].evaluate()+"[int("+this.parents[1].evaluate()+")]"},is_constant:function(){if(!this.parents[1].is_constant())return!1;var a=Math.floor(this.parents[1].constant_value());return this.parents[1].is_constant()&&this.parents[0].element_is_constant(a)},constant_value:Shade.memoize_on_field("_constant_value",function(){var a=Math.floor(this.parents[1].constant_value());return this.parents[0].element_constant_value(a)}),element:Shade.memoize_on_field("_element",function(a){var b=this.parents[0],c=this.parents[1];if(!c.is_constant()){var d=_.map(b.parents,function(b){return b.element(a)});return Shade.array(d).at(c)}var e=this.parents[1].constant_value(),f=this.parents[0].element(e);return f===this?f.at(a):f.element(a)}),element_is_constant:Shade.memoize_on_field("_element_is_constant",function(a){if(!this.parents[1].is_constant())return!1;var b=this.parents[1].constant_value(),c=this.parents[0].element(b);return c===this?!1:c.element_is_constant(a)}),element_constant_value:Shade.memoize_on_field("_element_constant_value",function(a){var b=this.parents[1].constant_value(),c=this.parents[0].element(b);if(c===this)throw"internal error: would have gone into an infinite loop here.";return c.element_constant_value(a)}),compile:function(){}})},_facet_expression:!0,expression_type:"other",_type:"shade_expression",_attribute_buffers:[],_uniforms:[],attribute_buffers:function(){return _.flatten(this.sorted_sub_expressions().map(function(a){return a._attribute_buffers}))},uniforms:function(){return _.flatten(this.sorted_sub_expressions().map(function(a){return a._uniforms}))},find_if:function(a){return _.select(this.sorted_sub_expressions(),a)},replace_if:function(a,b){function f(a){var b=_.select(d,function(b){return a.guid===b[0].guid&&b[0].guid!==b[1].guid});return b.length===0?a:b[0][1]}function e(a){return _.some(d,function(b){return a.guid===b[0].guid&&b[0].guid!==b[1].guid})}var c=this.sorted_sub_expressions(),d=[];for(var g=0;g<c.length;++g){var h=c[g];if(a(h))d.push([h,b(h)]);else if(_.some(h.parents,e)){var i=[h,Shade._create(h,{parents:_.map(h.parents,f)})];d.push(i)}else d.push([h,h])}var j=d[d.length-1][1];return j}},_.each(["r","g","b","a","x","y","z","w","s","t","p","q"],function(a){Shade.Exp[a]=function(){return this.swizzle(a)}}),Shade._create_concrete_exp=Shade._create_concrete(Shade.Exp,["parents","compile","type"]),Shade.ValueExp=Shade._create(Shade.Exp,{is_constant:Shade.memoize_on_field("_is_constant",function(){return _.all(this.parents,function(a){return a.is_constant()})}),element_is_constant:Shade.memoize_on_field("_element_is_constant",function(a){return this.is_constant()}),element_constant_value:Shade.memoize_on_field("_element_constant_value",function(a){return this.element(a).constant_value()}),_must_be_function_call:!1,evaluate:function(){var a=!0;return this._must_be_function_call?this.glsl_name+"()":this.children_count<=1?this.value():a?this.precomputed_value_glsl_name:this.glsl_name+"()"},element:function(a){if(this.type.is_pod()){if(a===0)return this;throw this.type.repr()+" is an atomic type, got this: "+a}this.debug_print();throw"Internal error; this should have been overriden."},compile:function(a){var b=!0;this._must_be_function_call?b?this.children_count>1?(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),a.add_initialization(this.precomputed_value_glsl_name+" = "+this.value()),a.value_function(this,this.precomputed_value_glsl_name)):a.value_function(this,this.value()):this.children_count>1?(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),this.has_precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(Shade.Types.bool_t.declare(this.has_precomputed_value_glsl_name),";\n"),a.add_initialization(this.has_precomputed_value_glsl_name+" = false"),a.value_function(this,"("+this.has_precomputed_value_glsl_name+"?"+this.precomputed_value_glsl_name+": (("+this.has_precomputed_value_glsl_name+"=true),("+this.precomputed_value_glsl_name+"="+this.value()+")))")):a.value_function(this,this.value()):b?this.children_count>1&&(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),a.add_initialization(this.precomputed_value_glsl_name+" = "+this.value())):this.children_count>1&&(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),this.has_precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(Shade.Types.bool_t.declare(this.has_precomputed_value_glsl_name),";\n"),a.add_initialization(this.has_precomputed_value_glsl_name+" = false"),a.value_function(this,"("+this.has_precomputed_value_glsl_name+"?"+this.precomputed_value_glsl_name+": (("+this.has_precomputed_value_glsl_name+"=true),("+this.precomputed_value_glsl_name+"="+this.value()+")))"))},call_operator:function(a){return this.mul(a)}}),Shade._create_concrete_value_exp=Shade._create_concrete(Shade.ValueExp,["parents","type","value"]),Shade.swizzle=function(a,b){return Shade(a).swizzle(b)},Shade.constant=function(a,b){var c={16:4,9:3,4:2,1:1},d=function(a,b){function e(c){var d=a.array_size(),e=[];for(var f=0;f<d;++f)e.push(b[c+f*d]);return e}function d(a,b){var c=_.map(b,function(a){var b=String(a);return facet_typeOf(a)==="number"&&b.indexOf(".")===-1?b+".0":b});return a+"("+_.toArray(c).join(", ")+")"}return Shade._create_concrete_exp({evaluate:function(a){return d(this.type.repr(),b)},expression_type:"constant{"+b+"}",is_constant:function(){return!0},element:Shade.memoize_on_field("_element",function(a){if(this.type.is_pod()){if(a===0)return this;throw this.type.repr()+" is an atomic type, got this: "+a}return this.type.is_vec()?Shade.constant(b[a]):Shade.vec.apply(e(a))}),element_is_constant:function(a){return!0},element_constant_value:Shade.memoize_on_field("_element_constant_value",function(a){if(this.type.equals(Shade.Types.float_t)){if(a===0)return b[0];throw"float is an atomic type"}return this.type.is_vec()?b[a]:vec[this.type.array_size()].make(e(a))}),constant_value:Shade.memoize_on_field("_constant_value",function(){if(this.type.is_pod())return b[0];if(this.type.equals(Shade.Types.vec2)||this.type.equals(Shade.Types.vec3)||this.type.equals(Shade.Types.vec4))return vec[b.length].make(b);if(this.type.equals(Shade.Types.mat2)||this.type.equals(Shade.Types
.mat3)||this.type.equals(Shade.Types.mat4))return mat[c[b.length]].make(b);throw"internal error: constant of unknown type"}),compile:function(a){},parents:[],type:a})},e=facet_constant_type(a),f,g;if(e==="number"){if(b&&!b.equals(Shade.Types.float_t)&&!b.equals(Shade.Types.int_t))throw"expected specified type for numbers to be float or int, got "+b.repr()+" instead.";return d(b||Shade.Types.float_t,[a])}if(e==="boolean"){if(b&&!b.equals(Shade.Types.bool_t))throw"boolean constants cannot be interpreted as "+b.repr();return d(Shade.Types.bool_t,[a])}if(e==="vector"){f=a.length;if(f<2&&f>4)throw"invalid length for constant vector: "+a;var h=_.map(a,function(a){return facet_typeOf(a)});if(!_.all(h,function(a){return a===h[0]}))throw"not all constant params have the same types";if(h[0]==="number"){g=Shade.basic("vec"+f);if(b&&!g.equals(b))throw"passed constant must have type "+g.repr()+", but was request to have incompatible type "+b.repr();return d(g,a)}throw"bad datatype for constant: "+h[0]}if(e==="matrix"){f=c[a.length],g=Shade.basic("mat"+f);if(b&&!g.equals(b))throw"passed constant must have type "+g.repr()+", but was request to have incompatible type "+b.repr();return d(g,a)}throw"type error: constant should be bool, number, vector, matrix or array. got "+e+" instead"},Shade.as_int=function(a){return Shade.make(a).as_int()},Shade.as_bool=function(a){return Shade.make(a).as_bool()},Shade.as_float=function(a){return Shade.make(a).as_float()},Shade.array=function(a){var b=facet_typeOf(a);if(b==="array"){var c=a.map(Shade.make),d=c.length;if(d===0)throw"array constant must be non-empty";var e=c.map(function(a){return a.type}),f=Shade.Types.array(e[0],d);if(_.any(e,function(a){return!a.equals(e[0])}))throw"array elements must have identical types";return Shade._create_concrete_exp({parents:c,type:f,expression_type:"constant",evaluate:function(){return this.glsl_name},compile:function(a){this.array_initializer_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.glsl_name),";\n"),a.strings.push("void",this.array_initializer_glsl_name,"(void) {\n");for(var b=0;b<this.parents.length;++b)a.strings.push("    ",this.glsl_name,"[",b,"] =",this.parents[b].evaluate(),";\n");a.strings.push("}\n"),a.add_initialization(this.array_initializer_glsl_name+"()")},is_constant:function(){return!1},element:function(a){return this.parents[a]},element_is_constant:function(a){return this.parents[a].is_constant()},element_constant_value:function(a){return this.parents[a].constant_value()}})}throw"type error: need array"},Shade.set=function(a,b){a=Shade(a);var c=a.type;return Shade._create_concrete_exp({expression_type:"set",compile:function(a){if((b==="gl_FragColor"||b.substring(0,11)==="gl_FragData")&&a.compile_type!==Shade.FRAGMENT_PROGRAM_COMPILE)throw"gl_FragColor and gl_FragData assignment only allowed on fragment shaders";if((b==="gl_Position"||b==="gl_PointSize")&&a.compile_type!==Shade.VERTEX_PROGRAM_COMPILE)throw"gl_Position and gl_PointSize assignment only allowed on vertex shaders";if(a.compile_type!==Shade.VERTEX_PROGRAM_COMPILE&&b!=="gl_FragColor"&&b.substring(0,11)!=="gl_FragData")throw"the only allowed output variables on a fragment shader are gl_FragColor and gl_FragData[]";b!=="gl_FragColor"&&b!=="gl_Position"&&b!=="gl_PointSize"&&b.substring(0,11)!=="gl_FragData"&&a.declare_varying(b,c),a.void_function(this,"(",b,"=",this.parents[0].evaluate(),")")},type:Shade.basic("void"),parents:[a]})},Shade.parameter=function(a,b){var c=[[Shade.Types.float_t,"uniform1f"],[Shade.Types.int_t,"uniform1i"],[Shade.Types.bool_t,"uniform1i"],[Shade.Types.sampler2D,"uniform1i"],[Shade.Types.vec2,"uniform2fv"],[Shade.Types.vec3,"uniform3fv"],[Shade.Types.vec4,"uniform4fv"],[Shade.Types.mat2,"uniformMatrix2fv"],[Shade.Types.mat3,"uniformMatrix3fv"],[Shade.Types.mat4,"uniformMatrix4fv"]],d=Shade.unique_name();if(_.isUndefined(a))throw"parameter requires type";typeof a=="string"&&(a=Shade.basic(a));var e,f=_.detect(c,function(b){return a.equals(b[0])});if(!_.isUndefined(f))f=f[1];else throw"Unsupported type "+a.repr()+" for parameter.";var g=Shade._create_concrete_exp({parents:[],type:a,expression_type:"uniform",evaluate:function(){return this._must_be_function_call?this.glsl_name+"()":d},element:Shade.memoize_on_field("_element",function(a){if(this.type.is_pod()){if(a===0)return this;throw this.type.repr()+" is an atomic type"}return this.at(a)}),compile:function(a){a.declare_uniform(d,this.type),this._must_be_function_call&&(this.precomputed_value_glsl_name=a.request_fresh_glsl_name(),a.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),a.add_initialization(this.precomputed_value_glsl_name+" = "+d),a.value_function(this,this.precomputed_value_glsl_name))},set:function(a){var b=facet_constant_type(a);b==="shade_expression"&&(a=a.constant_value()),e=a,this._facet_active_uniform&&this._facet_active_uniform(a)},get:function(a){return e},uniform_call:f,uniform_name:d});g._uniforms=[g],g.set(b);return g},Shade.sampler2D_from_texture=function(a){return a._shade_expression||function(){var b=Shade.parameter("sampler2D");b.set(a),a._shade_expression=b;return b}()},Shade.attribute_from_buffer=function(a){return a._shade_expression||function(){var b=[undefined,Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec3,Shade.Types.vec4],c=b[a.itemSize],d;_.isUndefined(a._shade_name)?(d=Shade.unique_name(),a._shade_name=d):d=a._shade_name;var e=Shade.attribute(d,c);e._attribute_buffers=[a],a._shade_expression=e;return e}()},Shade.attribute=function(a,b){if(_.isUndefined(b))throw"attribute requires type";typeof b=="string"&&(b=Shade.basic(b));return Shade._create_concrete_exp({parents:[],type:b,expression_type:"attribute",element:Shade.memoize_on_field("_element",function(a){if(this.type.equals(Shade.Types.float_t)){if(a===0)return this;throw"float is an atomic type"}return this.at(a)}),evaluate:function(){return this._must_be_function_call?this.glsl_name+"()":a},compile:function(b){b.declare_attribute(a,this.type),this._must_be_function_call&&(this.precomputed_value_glsl_name=b.request_fresh_glsl_name(),b.strings.push(this.type.declare(this.precomputed_value_glsl_name),";\n"),b.add_initialization(this.precomputed_value_glsl_name+" = "+a),b.value_function(this,this.precomputed_value_glsl_name))}})},Shade.varying=function(a,b){if(_.isUndefined(b))throw"varying requires type";facet_typeOf(b)==="string"&&(b=Shade.basic(b));var c=[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec3,Shade.Types.vec4,Shade.Types.mat2,Shade.Types.mat3,Shade.Types.mat4];if(!_.any(c,function(a){return a.equals(b)}))throw"varying does not support type '"+b.repr()+"'";return Shade._create_concrete_exp({parents:[],type:b,expression_type:"varying",element:Shade.memoize_on_field("_element",function(a){if(this.type.is_pod()){if(a===0)return this;throw this.type.repr()+" is an atomic type"}return this.at(a)}),evaluate:function(){return a},compile:function(b){b.declare_varying(a,this.type)}})},Shade.fragCoord=function(){return Shade._create_concrete_exp({expression_type:"builtin_input{gl_FragCoord}",parents:[],type:Shade.Types.vec4,evaluate:function(){return"gl_FragCoord"},compile:function(a){}})},Shade.pointCoord=function(){return Shade._create_concrete_exp({expression_type:"builtin_input{gl_PointCoord}",parents:[],type:Shade.Types.vec2,evaluate:function(){return"gl_PointCoord"},compile:function(a){}})},Shade.round_dot=function(a){var b=Shade.pointCoord().sub(Shade.vec(.5,.5)).norm().gt(.25);return Shade.make(a).discard_if(b)},function(){var a=function(a,b,c,d,e,f){var g=d(a.type,b.type);return Shade._create_concrete_value_exp({parents:[a,b],type:g,expression_type:"operator"+c,value:function(){return"("+this.parents[0].evaluate()+" "+c+" "+this.parents[1].evaluate()+")"},constant_value:Shade.memoize_on_field("_constant_value",function(){return e(this)}),element:Shade.memoize_on_field("_element",function(a){return f(this,a)}),element_constant_value:Shade.memoize_on_field("_element_constant_value",function(a){return this.element(a).constant_value()}),element_is_constant:Shade.memoize_on_field("_element_is_constant",function(a){return this.element(a).is_constant()})})};Shade.add=function(){function e(c,f){var g=c.parents[0],h=c.parents[1],i,j,k=g.type,l=h.type;if(k.is_pod()&&l.is_pod()){if(f===0)return c;throw"i > 0 in pod element"}g.type.is_vec()||g.type.is_mat()?i=g.element(f):i=g,h.type.is_vec()||h.type.is_vec()?j=h.element(f):j=h;return a(i,j,"+",b,d,e)}function d(a){var b=a.parents[0],c=a.parents[1],d;b.type.is_vec()?d=vec[b.type.vec_dimension()]:c.type.is_vec()&&(d=vec[c.type.vec_dimension()]);var e=b.constant_value(),f=c.constant_value();return b.type.equals(Shade.Types.int_t)&&c.type.equals(Shade.Types.int_t)?e+f:b.type.equals(Shade.Types.float_t)&&c.type.equals(Shade.Types.float_t)?e+f:c.type.equals(Shade.Types.float_t)?d.map(e,function(a){return a+f}):b.type.equals(Shade.Types.float_t)?d.map(f,function(a){return e+a}):d.plus(e,f)}function b(a,b){var c=[[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.float_t,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.float_t,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.float_t,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.int_t,Shade.Types.int_t,Shade.Types.int_t]];for(var d=0;d<c.length;++d)if(a.equals(c[d][0])&&b.equals(c[d][1]))return c[d][2];throw"type mismatch on add: unexpected types  '"+a.repr()+"' and '"+b.repr()+"'."}if(arguments.length===0)throw"add needs at least one argument";if(arguments.length===1)return arguments[0];var c=Shade.make(arguments[0]);for(var f=1;f<arguments.length;++f)c=a(c,Shade.make(arguments[f]),"+",b,d,e);return c},Shade.sub=function(){function d(e,f){var g=e.parents[0],h=e.parents[1],i,j,k=g.type,l=h.type;if(k.is_pod()&&l.is_pod()){if(f===0)return e;throw"i > 0 in pod element"}g.type.is_vec()||g.type.is_mat()?i=g.element(f):i=g,h.type.is_vec()||h.type.is_vec()?j=h.element(f):j=h;return a(i,j,"-",b,c,d)}function c(a){var b=a.parents[0],c=a.parents[1],d;b.type.is_vec()?d=vec[b.type.vec_dimension()]:c.type.is_vec()&&(d=vec[c.type.vec_dimension()]);var e=b.constant_value(),f=c.constant_value();return b.type.equals(Shade.Types.int_t)&&c.type.equals(Shade.Types.int_t)?e-f:b.type.equals(Shade.Types.float_t)&&c.type.equals(Shade.Types.float_t)?e-f:c.type.equals(Shade.Types.float_t)?d.map(e,function(a){return a-f}):b.type.equals(Shade.Types.float_t)?d.map(f,function(a){return e-a}):d.minus(e,f)}function b(a,b){var c=[[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.float_t,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.float_t,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.float_t,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.int_t,Shade.Types.int_t,Shade.Types.int_t]];for(var d=0;d<c.length;++d)if(a.equals(c[d][0])&&b.equals(c[d][1]))return c[d][2];throw"type mismatch on sub: unexpected types  '"+a.repr()+"' and '"+b.repr()+"'."}if(arguments.length===0)throw"sub needs at least two arguments";if(arguments.length===1)throw"unary minus unimplemented";var e=Shade.make(arguments[0]);for(var f=1;f<arguments.length;++f)e=a(e,Shade.make(arguments[f]),"-",b,c,d);return e},Shade.div=function(){function d(e,f){var g=e.parents[0],h=e.parents[1],i,j,k=g.type,l=h.type;if(k.is_pod()&&l.is_pod()){if(f===0)return e;throw"i > 0 in pod element"}g.type.is_vec()||g.type.is_mat()?i=g.element(f):i=g,h.type.is_vec()||h.type.is_vec()?j=h.element(f):j=h;return a(i,j,"/",b,c,d)}function c(a){var b=a.parents[0],c=a.parents[1],d=b.constant_value(),e=c.constant_value(),f,g;b.type.is_array()?(f=vec[b.type.array_size()],g=mat[b.type.array_size()]):c.type.is_array()&&(f=vec[c.type.array_size()],g=mat[c.type.array_size()]);var h=facet_constant_type(d),i=facet_constant_type(e),j={number:{number:function(a,b){return a/b},vector:function(a,b){return f.map(b,function(b){return a/b})},matrix:function(a,b){return g.map(b,function(b){return a/b})}},vector:{number:function(a,b){return f.scaling(a,1/b)},vector:function(a,b){return f.map(b,function(b,c){return a[c]/b})},matrix:function(a,b){throw"internal error, can't evaluate vector/matrix"}},matrix:{number:function(a,b){return g.scaling(a,1/b)},vector:function(a,b){throw"internal error, can't evaluate matrix/vector"},matrix:function(a,b){throw"internal error, can't evaluate matrix/matrix"}}};return j[h][i](d,e)}function b(a,b){if(_.isUndefined(a))throw"internal error: t1 multiplication with undefined type";if(_.isUndefined(b))throw"internal error: t2 multiplication with undefined type";var c=[[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.float_t,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.float_t,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.float_t,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.mat2,Shade.Types.mat2]];for(var d=0;d<c.length;++d)if(a.equals(c[d][0])&&b.equals(c[d][1]))return c[d][2];throw"type mismatch on div: unexpected types '"+a.repr()+"' and '"+b.repr()+"'"}if(arguments.length===0)throw"div needs at least two arguments";var e=Shade.make(arguments[0]);for(var f=1;f<arguments.length;++f)e=a(e,Shade.make(arguments[f]),"/",b,c,d);return e},Shade.mul=function(){function d(e,f){function m(a){if(a.is_pod())return"pod";if(a.is_vec())return"vec";if(a.is_mat())return"mat";throw"internal error: not pod, vec or mat"}var g=e.parents[0],h=e.parents[1],i,j,k=g.type,l=h.type;if(k.is_pod()&&l.is_pod()){if(f===0)return e;throw"i > 0 in pod element"}var n=m(k),o=m(l),p={pod:{pod:function(){throw"internal error, pod pod"},vec:function(){i=g,j=h.element(f);return a(i,j,"*",b,c,d)},mat:function(){i=g,j=h.element(f);return a(i,j,"*",b,c,d)}},vec:{pod:function(){i=g.element(f),j=h;return a(i,j,"*",b,c,d)},vec:function(){i=g.element(f),j=h.element(f);return a(i,j,"*",b,c,d)},mat:function(){return Shade.dot(g,h.element(f))}},mat:{pod:function(){i=g.element(f),j=h;return a(i,j,"*",b,c,d)},vec:function(){var a=k.array_size(),b;if(a===2)b=Shade.vec(g.element(0).element(f),g.element(1).element(f));else if(a===3)b=Shade.vec(g.element(0).element(f),g.element(1).element(f),g.element(2).element(f));else if(a===4)b=Shade.vec(g.element(0).element(f),g.element(1).element(f),g.element(2).element(f),g.element(3).element(f));else throw"bad dimension for mat "+a;return Shade.dot(b,h)},mat:function(){var e=h.element(f);return a(g,e,"*",b,c,d)}}};return p[n][o]()}function c(a){var b=a.parents[0],c=a.parents[1],d=b.constant_value(),e=c.constant_value(),f,g;b.type.is_array()?(f=vec[b.type.array_size()],g=mat[b.type.array_size()]):c.type.is_array()&&(f=vec[c.type.array_size()],g=mat[c.type.array_size()]);var h=facet_constant_type(d),i=facet_constant_type(e),j={number:{number:function(a,b){return a*b},vector:function(a,b){return f.scaling(b,a)},matrix:function(a,b){return g.scaling(b,a)}},vector:{number:function(a,b){return f.scaling(a,b)},vector:function(a,b){return f.schur_product(a,b)},matrix:function(a,b){return g.product_vec(g.transpose(b),a)}},matrix:{number:function(a,b){return g.scaling(a,b)},vector:function(a,b){return g.product_vec(a,b)},matrix:function(a,b){return g.product(a,b)}}};return j[h][i](d,e)}function b(a,b){if(_.isUndefined(a))throw"t1 multiplication with undefined type?";if(_.isUndefined(b))throw"t2 multiplication with undefined type?";var c=[[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.mat4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.vec4,Shade.Types.mat4,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.mat4,Shade.Types.float_t,Shade.Types.mat4],[Shade.Types.float_t,Shade.Types.mat4,Shade.Types.mat4],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.mat3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec3,Shade.Types.mat3,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.mat3,Shade.Types.float_t,Shade.Types.mat3],[Shade.Types.float_t,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.mat2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec2,Shade.Types.mat2,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.mat2,Shade.Types.float_t,Shade.Types.mat2],[Shade.Types.float_t,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.int_t,Shade.Types.int_t,Shade.Types.int_t]];for(var d=0;d<c.length;++d)if(a.equals(c[d][0])&&b.equals(c[d][1]))return c[d][2];throw"type mismatch on mul: unexpected types  '"+a.repr()+"' and '"+b.repr()+"'."}if(arguments.length===0)throw"mul needs at least one argument";if(arguments.length===1)return arguments[0];var e=Shade.make(arguments[0]);for(var f=1;f<arguments.length;++f)e.type.equals(Shade.Types.mat4)&&(arguments[f].type.equals(Shade.Types.vec2)?arguments[f]=Shade.vec(arguments[f],0,1):arguments[f].type.equals(Shade.Types.vec3)&&(arguments[f]=Shade.vec(arguments[f],1))),e=a(e,Shade.make(arguments[f]),"*",b,c,d);return e}}(),Shade.neg=function(a){return Shade.sub(0,a)},Shade.Exp.neg=function(){return Shade.neg(this)},Shade.vec=function(){var a=[],b=[],c=0,d;for(var e=0;e<arguments.length;++e){var f=Shade.make(arguments[e]);a.push(f),b.push(c);if(_.isUndefined(d))d=f.type.element_type(0);else if(!d.equals(f.type.element_type(0)))throw"vec requires equal types";c+=f.type.size_for_vec_constructor()}b.push(c);if(c<1||c>4)throw"vec constructor requires resulting width to be between 1 and 4, got "+c+" instead";var g;if(d.equals(Shade.Types.float_t))g=Shade.basic("vec"+c);else if(d.equals(Shade.Types.int_t))g=Shade.basic("ivec"+c);else if(d.equals(Shade.Types.bool_t))g=Shade.basic("bvec"+c);else throw"vec type must be bool, int, or float";return Shade._create_concrete_value_exp({parents:a,parent_offsets:b,type:g,expression_type:"vec",size:c,element:function(a){var b=a;for(var d=0;d<this.parents.length;++d){var e=this.parent_offsets[d+1]-this.parent_offsets[d];if(a<e)return this.parents[d].element(a);a=a-e}throw"element "+b+" out of bounds (size="+c+")"},element_is_constant:function(a){var b=a;for(var d=0;d<this.parents.length;++d){var e=this.parent_offsets[d+1]-this.parent_offsets[d];if(a<e)return this.parents[d].element_is_constant(a);a=a-e}throw"element "+b+" out of bounds (size="+c+")"},element_constant_value:function(a){var b=a;for(var d=0;d<this.parents.length;++d){var e=this.parent_offsets[d+1]-this.parent_offsets[d];if(a<e)return this.parents[d].element_constant_value(a);a=a-e}throw"element "+b+" out of bounds (size="+c+")"},constant_value:Shade.memoize_on_field("_constant_value",function(){var a=[],b=_.each(this.parents,function(b){var c=b.constant_value();if(facet_typeOf(c)==="number")a.push(c);else for(var d=0;d<c.length;++d)a.push(c[d])});return vec[a.length].make(a)}),value:function(){return this.type.repr()+"("+this.parents.map(function(a){return a.evaluate()}).join(", ")+")"}})},Shade.mat=function(){var a=[],b=arguments.length,c;for(var d=0;d<arguments.length;++d){var e=arguments[d];a.push(e);if(d===0)c=e.type.size_for_vec_constructor();else if(c!==e.type.size_for_vec_constructor())throw"mat: all vecs must have same dimension"}if(c!==b)throw"non-square matrices currently not supported";if(b<1||b>4)throw"mat constructor requires resulting dimension to be between 2 and 4";var f=Shade.basic("mat"+b);return Shade._create_concrete_value_exp({parents:a,type:f,expression_type:"mat",size:b,element:function(a){return this.parents[a]},element_is_constant:function(a){return this.parents[a].is_constant()},element_constant_value:function(a){return this.parents[a].constant_value()},constant_value:Shade.memoize_on_field("_constant_value",function(){var a=[],b=_.each(this.parents,function(b){b=b.constant_value();for(var c=0;c<b.length;++c)a.push(b[c])});return mat[this.type.array_size()].make(a)}),value:function(){return this.type.repr()+"("+this.parents.map(function(a){return a.evaluate()}).join(", ")+")"}})},Shade.mat3=function(a){var b=a.type;if(b.equals(Shade.Types.mat2))return Shade.mat(Shade.vec(a.at(0),0),Shade.vec(a.at(1),0),Shade.vec(0,0,1));if(b.equals(Shade.Types.mat3))return a;if(b.equals(Shade.Types.mat4))return Shade.mat(a.element(0).swizzle("xyz"),a.element(1).swizzle("xyz"),a.element(2).swizzle("xyz"));throw"need matrix to convert to mat3"},Shade.per_vertex=function(a){a=Shade.make(a);return Shade._create_concrete_exp({expression_name:"per_vertex",parents:[a],type:a.type,stage:"vertex",evaluate:function(){return this.parents[0].evaluate()},compile:function(){}})},function(){function o(c){function d(a,b,c){return(1-c)*a+c*b}var e=c.parents[0],f=c.parents[1],g=c.parents[2],h=e.constant_value(),i=f.constant_value(),j=g.constant_value();return e.type.equals(Shade.Types.float_t)?d(h,i,j):f.type.equals(g.type)?vec.make(b(d,h,i,j)):vec.make(a(function(a,b){return d(a,b,j)},h,i))}function m(a){function c(a,b,c){return Math.max(b,Math.min(c,a))}var d=a.parents[0],e=a.parents[1],f=a.parents[2],g=d.constant_value(),h=e.constant_value(),i=f.constant_value();return d.type.equals(Shade.Types.float_t)?c(g,h,i):d.type.equals(e.type)?vec.make(b(c,g,h,i)):vec.map(g,function(a){return c(a,h,i)})}function l(b){return function(c){var d=_.map(c.parents,function(a){return a.constant_value()});return c.parents[0].type.equals(Shade.Types.float_t)?b.apply(b,d):c.parents[0].type.equals(Shade.Types.int_t)?b.apply(b,d):c.parents[0].type.equals(c.parents[1].type)?vec.make(a(b,d[0],d[1])):vec.map(d[0],function(a){return b(a,d[1])})}}function k(a,b){return _.map(a.parents,function(a){return a.type.is_vec()?a.element(b):a})}function j(){if(arguments.length==1)return e("atan",h)(arguments[0]);if(arguments.length==2){var a=i(Math.atan2);return f("atan",a)(arguments[0],arguments[1])}throw"atan expects 1 or 2 parameters, got "+arguments.length+" instead."}function i(a){return function(b){var c=b.parents[0].constant_value(),d=b.parents[1].constant_value();if(b.type.equals(Shade.Types.float_t))return a(c,d);var e=[];for(var f=0;f<c.length;++f)e.push(a(c[f],d[f]));return vec.make(e)}}function h(a){var b=a.parents[0].constant_value();return a.type.equals(Shade.Types.float_t)?Math.atan(b):vec.map(c,Math.atan)}function f(a,b){var c=d({name:a,type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4]],constant_evaluator:b,element_evaluator:function(a,b){return c(a.parents[0].element(b),a.parents[1].element(b))}});return c}function e(a,b){var c=d({name:a,type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4]],constant_evaluator:b,element_evaluator:function(a,b){return c(a.parents[0].element(b))}});return c}function d(a){function j(a){var b=a[0].length-1;return function(){if(arguments.length!=b)throw"expected "+b+" arguments, got "+arguments.length+" instead.";for(var c=0;c<a.length;++c){var d=a[c],e=!0;for(var f=0;f<b;++f)if(!d[f].equals(arguments[f].type)){e=!1;break}if(e)return d[b]}var g=_.map(_.toArray(arguments).slice(0,arguments.length),function(a){return a.type.repr()}).join(", ");throw"could not find appropriate type match for ("+g+")"}}var b=a.name,c=a.type_resolving_list,d=a.constant_evaluator,e=a.element_evaluator,f=a.element_constant_evaluator;for(var g=0;g<c.length;++g)for(var h=0;h<c[g].length;++h){var i=c[g][h];if(_.isUndefined(i))throw"undefined type in type_resolver"}return function(){var a=j(c),h,i=[];for(g=0;g<arguments.length;++g)i.push(Shade.make(arguments[g]));try{h=a.apply(this,i)}catch(k){throw"type error on "+b+": "+k}var l={parents:i,expression_type:"builtin_function{"+b+"}",type:h,value:function(){return[b,"(",this.parents.map(function(a){return a.evaluate()}).join(", "),")"].join(" ")}};d?l.constant_value=Shade.memoize_on_field("_constant_value",function(){return d(this)}):l.is_constant=function(){return!1},e&&(l.element=function(a){return e(this,a)},l.element_is_constant=function(a){return this.element(a).is_constant()}),f&&(l.element_is_constant=function(a){return f(this,a)});return Shade._create_concrete_value_exp(l)}}function b(a,b,c,d){return _.map(_.zip(b,c,d),function(b){return a(b[0],b[1],b[2])})}function a(a,b,c){return _.map(_.zip(b,c),function(b){return a(b[0],b[1])})}var g={radians:function(a){return a*Math.PI/180},degrees:function(a){return a/Math.PI*180},sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,abs:Math.abs,sign:function(a){return a<0?-1:a===0?0:1},floor:Math.floor,ceil:Math.ceil,fract:function(a){return a-Math.floor(a)},exp:Math.exp,log:Math.log,exp2:function(a){return Math.exp(a*Math.log(2))},log2:function(a){return Math.log(a)/Math.log(2)},sqrt:Math.sqrt,inversesqrt:function(a){return 1/Math.sqrt(a)}};_.each(g,function(a,b){function c(b){if(b.type.equals(Shade.Types.float_t))return a(b.parents[0].constant_value());var c=b.parents[0].constant_value();return vec.map(c,a)}Shade[b]=e(b,c),Shade.Exp[b]=function(a){return function(){return a(this)}}(Shade[b])}),Shade.atan=j,Shade.Exp.atan=function(){return Shade.atan(this)},Shade.pow=f("pow",i(Math.pow)),Shade.Exp.pow=function(a){return Shade.pow(this,a)},_.each({mod:function(a,b){return a%b},min:Math.min,max:Math.max},function(a,b){var c=d({name:b,type_resolving_list:[[Shade.Types.int_t,Shade.Types.int_t,Shade.Types.int_t],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4]],constant_evaluator:l(a),element_evaluator:function(a,b){return c.apply(this,k(a,b))}});Shade[b]=c});var n=d({name:"clamp",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.vec2,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec4]],constant_evaluator:m,element_evaluator:function(a,b){return Shade.clamp.apply(this,k(a,b))}});Shade.clamp=n;var p=d({name:"mix",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4]],constant_evaluator:o,element_evaluator:function(a,b){return Shade.mix.apply(this,k(a,b))}});Shade.mix=p;var q=d({name:"step",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4]],constant_evaluator:function(b){function c(a,b){return b<a?0:1}var d=b.parents[0],e=b.parents[1],f=d.constant_value(),g=e.constant_value();return e.type.equals(Shade.Types.float_t)?c(f,g):d.type.equals(e.type)?vec.make(a(c,f,g)):vec.map(g,function(a){return c(f,a)})},element_evaluator:function(a,b){return Shade.step.apply(this,k(a,b))}});Shade.step=q;var r=d({name:"smoothstep",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.vec4,Shade.Types.vec4]],constant_evaluator:function(a){var b=a.parents[0],c=a.parents[1],d=a.parents[2],e=Shade.clamp(d.sub(b).div(c.sub(b)),0,1);return e.mul(e).mul(Shade.sub(3,e.mul(2))).constant_value()},element_evaluator:function(a,b){return Shade.smoothstep.apply(this,k(a,b))}});Shade.smoothstep=r;var s=d({name:"length",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.float_t]],constant_evaluator:function(a){var b=a.parents[0].constant_value();return a.parents[0].type.equals(Shade.Types.float_t)?Math.abs(b):vec.length(b)}});Shade.norm=s;var t=d({name:"distance",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.float_t],[Shade.Types.vec4
,Shade.Types.vec4,Shade.Types.float_t]],constant_evaluator:function(a){return a.parents[0].sub(a.parents[1]).norm().constant_value()}});Shade.distance=t;var u=d({name:"dot",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.float_t],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.float_t],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.float_t]],constant_evaluator:function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return a.parents[0].type.equals(Shade.Types.float_t)?b*c:vec.dot(b,c)}});Shade.dot=u;var v=d({name:"cross",type_resolving_list:[[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3]],constant_evaluator:function(a){return vec3.cross(a.parents[0].constant_value(),a.parents[1].constant_value())},element_evaluator:function(a,b){var c=a.parents[0].length,d=a.parents[1].length;if(b===0)return c.at(1).mul(d.at(2)).sub(c.at(2).mul(d.at(1)));if(b===1)return c.at(2).mul(d.at(0)).sub(c.at(0).mul(d.at(2)));if(b===2)return c.at(0).mul(d.at(1)).sub(c.at(1).mul(d.at(0)));throw"invalid element "+b+" for cross"}});Shade.cross=v;var w=d({name:"normalize",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4]],constant_evaluator:function(a){return a.parents[0].div(a.parents[0].norm()).constant_value()},element_evaluator:function(a,b){return a.parents[0].div(a.parents[0].norm()).element(b)}});Shade.normalize=w;var x=d({name:"faceforward",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4]],constant_evaluator:function(a){var b=a.parents[0],c=a.parents[1],d=a.parents[2];return d.dot(c).constant_value()<0?b.constant_value():Shade.sub(0,b).constant_value()},element_evaluator:function(a,b){var c=a.parents[0],d=a.parents[1],e=a.parents[2];return Shade.ifelse(e.dot(d).lt(0),c,Shade.neg(c)).element(b)}});Shade.faceforward=x;var y=d({name:"reflect",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.vec4]],constant_evaluator:function(a){var b=a.parents[0],c=a.parents[1];return b.sub(Shade.mul(2,c.dot(b),c)).constant_value()},element_evaluator:function(a,b){var c=a.parents[0],d=a.parents[1];return c.sub(Shade.mul(2,d.dot(c),d)).element_constant_value(b)}});Shade.reflect=y;var z=d({name:"refract",type_resolving_list:[[Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t,Shade.Types.float_t],[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.float_t,Shade.Types.vec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.float_t,Shade.Types.vec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.float_t,Shade.Types.vec4]],constant_evaluator:function(a){var b=a.parents[0],c=a.parents[1],d=a.parents[2],e=Shade.sub(1,Shade.mul(d,d,Shade.sub(1,c.dot(b).mul(c.dot(b)))));return e.constant_value()<0?vec[b.type.array_size()].create():d.mul(b).sub(d.mul(c.dot(b)).add(e.sqrt()).mul(c)).constant_value()},element_evaluator:function(a,b){var c=a.parents[0],d=a.parents[1],e=a.parents[2],f=Shade.sub(1,Shade.mul(e,e,Shade.sub(1,d.dot(c).mul(d.dot(c))))),g=e.mul(c).sub(e.mul(d.dot(c)).add(f.sqrt()).mul(d)),h;switch(c.type.array_size()){case 2:h=Shade.vec(0,0);break;case 3:h=Shade.vec(0,0,0);break;case 4:h=Shade.vec(0,0,0,0);break;default:throw"internal error"}return Shade.ifelse(f.lt(0),h,g).element(b)}});Shade.refract=z;var A=d({name:"texture2D",type_resolving_list:[[Shade.Types.sampler2D,Shade.Types.vec2,Shade.Types.vec4]],element_evaluator:function(a,b){return a.at(b)},element_constant_evaluator:function(a,b){return!1}});Shade.texture2D=A,Shade.equal=d({name:"equal",type_resolving_list:[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bool_t],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bool_t],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bool_t],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bool_t],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bool_t],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bool_t],[Shade.Types.bvec2,Shade.Types.bvec2,Shade.Types.bool_t],[Shade.Types.bvec3,Shade.Types.bvec3,Shade.Types.bool_t],[Shade.Types.bvec4,Shade.Types.bvec4,Shade.Types.bool_t]],constant_evaluator:function(b){var c=b.parents[0].constant_value(),d=b.parents[1].constant_value();return _.all(a(function(a,b){return a===b}),c,d)}}),Shade.Exp.equal=function(a){return Shade.equal(this,a)},Shade.notEqual=d({name:"notEqual",type_resolving_list:[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bool_t],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bool_t],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bool_t],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bool_t],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bool_t],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bool_t],[Shade.Types.bvec2,Shade.Types.bvec2,Shade.Types.bool_t],[Shade.Types.bvec3,Shade.Types.bvec3,Shade.Types.bool_t],[Shade.Types.bvec4,Shade.Types.bvec4,Shade.Types.bool_t]],constant_evaluator:function(b){var c=b.parents[0].constant_value(),d=b.parents[1].constant_value();return!_.all(a(function(a,b){return a===b}),c,d)}}),Shade.Exp.notEqual=function(a){return Shade.notEqual(this,a)},Shade.lessThan=d({name:"lessThan",type_resolving_list:[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bvec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bvec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bvec4],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bvec2],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bvec3],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bvec4]],constant_evaluator:function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return _.map(b,function(a,b){return a<c[b]})},element_evaluator:function(a,b){return Shade.lt.apply(this,k(a,b))}}),Shade.Exp.lessThan=function(a){return Shade.lessThan(this,a)},Shade.lessThanEqual=d({name:"lessThanEqual",type_resolving_list:[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bvec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bvec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bvec4],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bvec2],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bvec3],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bvec4]],constant_evaluator:function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return _.map(b,function(a,b){return a<=c[b]})},element_evaluator:function(a,b){return Shade.le.apply(this,k(a,b))}}),Shade.Exp.lessThanEqual=function(a){return Shade.lessThanEqual(this,a)},Shade.greaterThan=d({name:"greaterThan",type_resolving_list:[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bvec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bvec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bvec4],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bvec2],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bvec3],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bvec4]],constant_evaluator:function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return _.map(b,function(a,b){return a>c[b]})},element_evaluator:function(a,b){return Shade.gt.apply(this,k(a,b))}}),Shade.Exp.greaterThan=function(a){return Shade.greaterThan(this,a)},Shade.greaterThanEqual=d({name:"greaterThanEqual",type_resolving_list:[[Shade.Types.vec2,Shade.Types.vec2,Shade.Types.bvec2],[Shade.Types.vec3,Shade.Types.vec3,Shade.Types.bvec3],[Shade.Types.vec4,Shade.Types.vec4,Shade.Types.bvec4],[Shade.Types.ivec2,Shade.Types.ivec2,Shade.Types.bvec2],[Shade.Types.ivec3,Shade.Types.ivec3,Shade.Types.bvec3],[Shade.Types.ivec4,Shade.Types.ivec4,Shade.Types.bvec4]],constant_evaluator:function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return _.map(b,function(a,b){return a>=c[b]})},element_evaluator:function(a,b){return Shade.ge.apply(this,k(a,b))}}),Shade.Exp.greaterThanEqual=function(a){return Shade.greaterThanEqual(this,a)},Shade.all=d({name:"all",type_resolving_list:[[Shade.Types.bvec2,Shade.Types.bool_t],[Shade.Types.bvec3,Shade.Types.bool_t],[Shade.Types.bvec4,Shade.Types.bool_t]],constant_evaluator:function(a){var b=a.parents[0].constant_value();return _.all(b,function(a){return a})}}),Shade.Exp.all=function(){return Shade.all(this)},Shade.any=d({name:"any",type_resolving_list:[[Shade.Types.bvec2,Shade.Types.bool_t],[Shade.Types.bvec3,Shade.Types.bool_t],[Shade.Types.bvec4,Shade.Types.bool_t]],constant_evaluator:function(a){var b=a.parents[0].constant_value();return _.any(b,function(a){return a})}}),Shade.Exp.any=function(){return Shade.any(this)},Shade.matrixCompMult=d({name:"matrixCompMult",type_resolving_list:[[Shade.Types.mat2,Shade.Types.mat2,Shade.Types.mat2],[Shade.Types.mat3,Shade.Types.mat3,Shade.Types.mat3],[Shade.Types.mat4,Shade.Types.mat4,Shade.Types.mat4]],constant_evaluator:function(a){var b=a.parents[0].constant_value(),c=a.parents[1].constant_value();return mat.map(b,function(a,b){return a*c[b]})},element_evaluator:function(a,b){var c=a.parents[0],d=a.parents[1];return c.element(b).mul(d.element(b))}}),Shade.Exp.matrixCompMult=function(a){return Shade.matrixCompMult(this,a)}}(),Shade.seq=function(a){return a.length==1?a[0]:Shade._create_concrete_exp({expression_name:"seq",parents:a,evaluate:function(a){return this.parents.map(function(a){return a.evaluate()}).join("; ")},type:Shade.basic("void"),compile:function(a){}})},Shade.Optimizer={},Shade.Optimizer.debug=!1,Shade.Optimizer._debug_passes=!1,Shade.Optimizer.transform_expression=function(a){return function(b){var c;for(var d=0;d<a.length;++d){Shade.debug&&Shade.Optimizer._debug_passes&&(c=b);var e=a[d][0],f=a[d][1],g=b.guid;if(a[d][3]){var h;do h=b.guid,b=b.replace_if(e,f);while(b.guid!==h)}else b=b.replace_if(e,f);var i=b.guid;Shade.debug&&Shade.Optimizer._debug_passes&&g!=i&&(console.log("Pass",a[d][2],"succeeded"),console.log("Before: "),c.debug_print(),console.log("After: "),b.debug_print())}return b}},Shade.Optimizer.is_constant=function(a){return a.is_constant()},Shade.Optimizer.replace_with_constant=function(a){var b=a.constant_value(),c=Shade.constant(b,a.type);return c},Shade.Optimizer.is_zero=function(a){if(!a.is_constant())return!1;var b=a.constant_value(),c=facet_constant_type(b);return c==="number"?b===0:c==="vector"?_.all(b,function(a){return a===0}):facet_typeOf(b)==="matrix"?_.all(b,function(a){return a===0}):!1},Shade.Optimizer.is_mul_identity=function(a){if(!a.is_constant())return!1;var b=a.constant_value(),c=facet_constant_type(b);if(c==="number")return b===1;if(c==="vector")switch(b.length){case 2:return vec.equal(b,vec.make([1,1]));case 3:return vec.equal(b,vec.make([1,1,1]));case 4:return vec.equal(b,vec.make([1,1,1,1]));default:throw"bad vec length: "+b.length}return c==="matrix"?mat.equal(b,mat[Math.sqrt(b.length)].identity()):!1},Shade.Optimizer.is_times_zero=function(a){return a.expression_type==="operator*"&&(Shade.Optimizer.is_zero(a.parents[0])||Shade.Optimizer.is_zero(a.parents[1]))},Shade.Optimizer.is_plus_zero=function(a){return a.expression_type==="operator+"&&(Shade.Optimizer.is_zero(a.parents[0])||Shade.Optimizer.is_zero(a.parents[1]))},Shade.Optimizer.replace_with_nonzero=function(a){if(Shade.Optimizer.is_zero(a.parents[0]))return a.parents[1];if(Shade.Optimizer.is_zero(a.parents[1]))return a.parents[0];throw"internal error: no zero value on input to replace_with_nonzero"},Shade.Optimizer.is_times_one=function(a){if(a.expression_type!=="operator*")return!1;var b=a.parents[0].type,c=a.parents[1].type,d=Shade.Types.float_t;if(b.equals(c))return Shade.Optimizer.is_mul_identity(a.parents[0])||Shade.Optimizer.is_mul_identity(a.parents[1]);if(!b.equals(d)&&c.equals(d))return Shade.Optimizer.is_mul_identity(a.parents[1]);if(b.equals(d)&&!c.equals(d))return Shade.Optimizer.is_mul_identity(a.parents[0]);if(b.is_vec()&&c.is_mat())return Shade.Optimizer.is_mul_identity(a.parents[1]);if(b.is_mat()&&c.is_vec())return Shade.Optimizer.is_mul_identity(a.parents[0]);throw"internal error on Shade.Optimizer.is_times_one"},Shade.Optimizer.replace_with_notone=function(a){var b=a.parents[0].type,c=a.parents[1].type,d=Shade.Types.float_t;if(b.equals(c)){if(Shade.Optimizer.is_mul_identity(a.parents[0]))return a.parents[1];if(Shade.Optimizer.is_mul_identity(a.parents[1]))return a.parents[0];throw"internal error on Shade.Optimizer.replace_with_notone"}if(!b.equals(d)&&c.equals(d))return a.parents[0];if(b.equals(d)&&!c.equals(d))return a.parents[1];if(b.is_vec()&&c.is_mat())return a.parents[0];if(b.is_mat()&&c.is_vec())return a.parents[1];throw"internal error: no is_mul_identity value on input to replace_with_notone"},Shade.Optimizer.replace_with_zero=function(a){if(a.type.equals(Shade.Types.float_t))return Shade.constant(0);if(a.type.equals(Shade.Types.int_t))return Shade.as_int(0);if(a.type.equals(Shade.Types.vec2))return Shade.constant(vec2.create());if(a.type.equals(Shade.Types.vec3))return Shade.constant(vec3.create());if(a.type.equals(Shade.Types.vec4))return Shade.constant(vec4.create());if(a.type.equals(Shade.Types.mat2))return Shade.constant(mat2.create());if(a.type.equals(Shade.Types.mat3))return Shade.constant(mat3.create());if(a.type.equals(Shade.Types.mat4))return Shade.constant(mat4.create());throw"internal error: not a type replaceable with zero"},Shade.Optimizer.vec_at_constant_index=function(a){if(a.expression_type!=="index")return!1;if(!a.parents[1].is_constant())return!1;var b=a.parents[1].constant_value();if(facet_typeOf(b)!=="number")return!1;var c=a.parents[0].type;return c.equals(Shade.Types.vec2)&&b>=0&&b<=1?!0:c.equals(Shade.Types.vec3)&&b>=0&&b<=2?!0:c.equals(Shade.Types.vec4)&&b>=0&&b<=3?!0:!1},Shade.Optimizer.replace_vec_at_constant_with_swizzle=function(a){var b=a.parents[1].constant_value();if(b===0)return a.parents[0].swizzle("x");if(b===1)return a.parents[0].swizzle("y");if(b===2)return a.parents[0].swizzle("z");if(b===3)return a.parents[0].swizzle("w");throw"internal error on Shade.Optimizer.replace_vec_at_constant_with_swizzle"},Shade.Optimizer.is_logical_and_with_constant=function(a){return a.expression_type==="operator&&"&&a.parents[0].is_constant()},Shade.Optimizer.replace_logical_and_with_constant=function(a){return a.parents[0].constant_value()?a.parents[1]:Shade.make(!1)},Shade.Optimizer.is_logical_or_with_constant=function(a){return a.expression_type==="operator||"&&a.parents[0].is_constant()},Shade.Optimizer.replace_logical_or_with_constant=function(a){return a.parents[0].constant_value()?Shade.make(!0):a.parents[1]},Shade.Optimizer.is_never_discarding=function(a){return a.expression_type==="discard_if"&&a.parents[0].is_constant()&&!a.parents[0].constant_value()},Shade.Optimizer.remove_discard=function(a){return a.parents[1]},Shade.Optimizer.is_known_branch=function(a){var b=a.expression_type==="ifelse"&&a.parents[0].is_constant();return b},Shade.Optimizer.prune_ifelse_branch=function(a){return a.parents[0].constant_value()?a.parents[1]:a.parents[2]},Shade.canonicalize_program_object=function(a){var b={},c={color:"gl_FragColor",position:"gl_Position",point_size:"gl_PointSize"};_.each(a,function(a,d){var e=d in c?c[d]:d;b[e]=a});return b},Shade.program=function(a){function l(a){var c=Shade.unique_name();b[c]=a,k.push(c);return Shade.varying(c,a.type)}function j(a){return a.stage==="vertex"}function i(a){return a.expression_type==="varying"}function h(a){return a.expression_type==="attribute"}a=Shade.canonicalize_program_object(a);var b={},c={};_.each(a,function(a,d){a=Shade.make(a);if(d==="gl_FragColor"){if(!a.type.equals(Shade.Types.vec4))throw"color attribute must be of type vec4, got "+a.type.repr()+" instead";c.gl_FragColor=a}else if(d==="gl_Position"){if(!a.type.equals(Shade.Types.vec4))throw"position attribute must be of type vec4, got "+a.type.repr()+" instead";b.gl_Position=a}else if(d==="gl_PointSize"){if(!a.type.equals(Shade.Types.float_t))throw"color attribute must be of type float, got "+a.type.repr()+" instead";b.gl_PointSize=a}else{if(d.substr(0,3)==="gl_")throw"gl_* are reserved GLSL names";b[d]=a}});var d=Shade.CompilationContext(Shade.VERTEX_PROGRAM_COMPILE),e=Shade.CompilationContext(Shade.FRAGMENT_PROGRAM_COMPILE),f=[],g=[],k=[],m=[[Shade.Optimizer.is_times_zero,Shade.Optimizer.replace_with_zero,"v * 0",!0],[Shade.Optimizer.is_times_one,Shade.Optimizer.replace_with_notone,"v * 1",!0],[Shade.Optimizer.is_plus_zero,Shade.Optimizer.replace_with_nonzero,"v + 0",!0],[Shade.Optimizer.is_never_discarding,Shade.Optimizer.remove_discard,"discard_if(false)"],[Shade.Optimizer.is_known_branch,Shade.Optimizer.prune_ifelse_branch,"constant?a:b",!0],[Shade.Optimizer.vec_at_constant_index,Shade.Optimizer.replace_vec_at_constant_with_swizzle,"vec[constant_ix]"],[Shade.Optimizer.is_constant,Shade.Optimizer.replace_with_constant,"constant folding"],[Shade.Optimizer.is_logical_or_with_constant,Shade.Optimizer.replace_logical_or_with_constant,"constant||v",!0],[Shade.Optimizer.is_logical_and_with_constant,Shade.Optimizer.replace_logical_and_with_constant,"constant&&v",!0]],n=[[j,l,"per-vertex hoisting"],[h,l,"attribute hoisting"]];n.push.apply(n,m);var o=m,p=Shade.Optimizer.transform_expression(n),q=Shade.Optimizer.transform_expression(o),r=[];_.each(c,function(a,b){a=p(a),r.push.apply(r,_.map(a.find_if(i),function(a){return a.evaluate()})),g.push(Shade.set(a,b))}),_.each(b,function(a,b){(k.indexOf(b)===-1||r.indexOf(b)!==-1)&&f.push(Shade.set(q(a),b))});var s=Shade.seq(f),t=Shade.seq(g);d.compile(s),e.compile(t);var u=d.source(),v=e.source();Shade.debug&&(Shade.debug&&Shade.Optimizer._debug_passes&&(console.log("Vertex program final AST:"),s.debug_print()),console.log("Vertex program source:"),console.log(u),Shade.debug&&Shade.Optimizer._debug_passes&&(console.log("Fragment program final AST:"),t.debug_print()),console.log("Fragment program source:"),console.log(v));var w=Facet.program(u,v);w.attribute_buffers=s.attribute_buffers(),w.uniforms=_.union(s.uniforms(),t.uniforms());return w},Shade.is_program_parameter=function(a){return["color","position","point_size","gl_FragColor","gl_Position","gl_PointSize"].indexOf(a)!=-1},Shade.round=Shade.make(function(a){return a.add(.5).floor()}),Shade.Exp.round=function(){return Shade.round(this)},Shade.Utils={},Shade.Utils.lerp=function(a){var b=_.toArray(a);b.push(b[b.length-1]);return function(a){var c=Shade.array(b);a=Shade.clamp(a,0,1).mul(b.length-2);var d=a.fract(),e=a.floor();return Shade.mix(c.at(e),c.at(e.add(1)),d)}},Shade.Utils.choose=function(a){var b=_.toArray(a);return function(a){var c=Shade.array(b);a=Shade.clamp(a,0,b.length-1).floor().as_int();return c.at(a)}},Shade.Utils.linear=function(a,b,c,d){var e=Shade.sub(b,a),f=Shade.sub(d,c);return function(b){return Shade.make(b).sub(a).mul(f.div(e)).add(c)}},Shade.Utils.fit=function(a){var b=a._shade_type;if(b==="attribute_buffer"){if(a.itemSize!==1)throw"only dimension-1 attribute buffers are supported";a=a.array}var c=_.min(a),d=_.max(a);return Shade.Utils.linear(c,d,0,1)},Shade.gl_light=function(a){function b(a){return a.type.equals(Shade.Types.vec4)?a.swizzle("xyz").div(a.at(3)):a}a=_.defaults(a||{},{light_ambient:Shade.vec(0,0,0,1),light_diffuse:Shade.vec(1,1,1,1),two_sided:!1,per_vertex:!1});var c=b(a.light_position),d=b(a.vertex),e=a.material_color,f=a.light_ambient,g=a.light_diffuse,h=a.per_vertex,i=(a.normal.type.equals(Shade.Types.vec4)?a.normal.swizzle("xyz"):a.normal).normalize(),j=i,k=c.sub(d).normalize(),l=Shade.max(Shade.ifelse(a.two_sided,k.dot(j).abs(),k.dot(j)),0);h&&(l=Shade.per_vertex(l));return Shade.add(f.mul(e),l.mul(g).mul(e))},function(){var a=Shade.vec(0,0,0,0);Shade.gl_fog=function(b){b=_.defaults(b,{mode:"exp",density:1,start:0,end:1,fog_color:a,per_vertex:!1});var c=b.mode||"exp",d=Shade.make(b.fog_color),e=b.color,f=Shade.make(b.z),g,h,i;if(b.mode==="exp")h=Shade.make(b.density),i=Shade.make(b.start),g=f.sub(i).mul(h).exp();else if(c==="exp2")h=Shade.make(b.density),i=Shade.make(b.start),g=f.sub(i).min(0).mul(h),g=g.mul(g),g=g.neg().exp();else if(c==="linear"){i=Shade.make(b.start);var j=Shade.make(b.end);j=Shade.make(j),i=Shade.make(i),g=j.sub(f).div(j.sub(i))}g=g.clamp(0,1),b.per_vertex&&(g=g.per_vertex());return Shade.mix(d,e,g)}}(),Shade.cosh=function(a){return Shade.exp(a).add(a.neg().exp()).div(2)},Shade.Exp.cosh=function(){return Shade.cosh(this)},Shade.sinh=function(a){return Shade.exp(a).sub(a.neg().exp()).div(2)},Shade.Exp.sinh=function(){return Shade.sinh(this)},Shade.tanh=Shade(function(a){return a.sinh().div(a.cosh())}),Shade.Exp.tanh=function(){return Shade.tanh(this)},function(){var a=function(a,b,c,d,e){e=e||function(a){return!0};return Shade._create_concrete_value_exp({parents:[a,b],type:Shade.Types.bool_t,expression_type:"operator"+c,value:function(){return"("+this.parents[0].evaluate()+" "+c+" "+this.parents[1].evaluate()+")"},constant_value:Shade.memoize_on_field("_constant_value",function(){return d(this)}),parent_is_unconditional:e})},b=function(a){return function(b){var c=b.parents[0],d=b.parents[1];return a(c.constant_value(),d.constant_value())}},c=function(b,c,d){return function(){if(arguments.length===0)throw"operator "+b+" requires at least 1 parameter";if(arguments.length===1)return Shade(arguments[0]).as_bool();var e=Shade(arguments[0]);if(!e.type.equals(Shade.Types.bool_t))throw"operator "+b+" requires booleans, got argument 1 as "+arguments[0].type.repr()+" instead.";var f=e;for(var g=1;g<arguments.length;++g){var h=Shade(arguments[g]);if(!h.type.equals(Shade.Types.bool_t))throw"operator "+b+" requires booleans, got argument "+(g+1)+" as "+h.type.repr()+" instead.";f=a(f,h,b,c,d)}return f}};Shade.or=c("||",b(function(a,b){return a||b}),function(a){return a===0}),Shade.Exp.or=function(a){return Shade.or(this,a)},Shade.and=c("&&",b(function(a,b){return a&&b}),function(a){return a===0}),Shade.Exp.and=function(a){return Shade.and(this,a)},Shade.xor=c("^^",b(function(a,b){return~~(a^b)})),Shade.Exp.xor=function(a){return Shade.xor(this,a)},Shade.not=Shade(function(a){if(!a.type.equals(Shade.Types.bool_t))throw"logical_not requires bool expression";return Shade._create_concrete_value_exp({parents:[a],type:Shade.Types.bool_t,expression_type:"operator!",value:function(){return"(!"+this.parents[0].evaluate()+")"},constant_value:Shade.memoize_on_field("_constant_value",function(){return!this.parents[0].constant_value()})})}),Shade.Exp.not=function(){return Shade.not(this)};var d=function(b,c,d){return Shade(function(e,f){c(e.type,f.type);return a(e,f,b,d)})},e=function(a){return function(b,c){if((!b.equals(Shade.Types.float_t)||!c.equals(Shade.Types.float_t))&&(!b.equals(Shade.Types.int_t)||!c.equals(Shade.Types.int_t)))throw"operator"+a+" requires two ints or two floats, got "+b.repr()+" and "+c.repr()+" instead."}},f=function(a){return function(b,c){if(!b.equals(c))throw"operator"+a+" requires same types, got "+b.repr()+" and "+c.repr()+" instead.";if(b.is_array()&&!b.is_vec()&&!b.is_mat())throw"operator"+a+" does not support arrays"}};Shade.lt=d("<",e("<"),b(function(a,b){return a<b})),Shade.Exp.lt=function(a){return Shade.lt(this,a)},Shade.le=d("<=",e("<="),b(function(a,b){return a<=b})),Shade.Exp.le=function(a){return Shade.le(this,a)},Shade.gt=d(">",e(">"),b(function(a,b){return a>b})),Shade.Exp.gt=function(a){return Shade.gt(this,a)},Shade.ge=d(">=",e(">="),b(function(a,b){return a>=b})),Shade.Exp.ge=function(a){return Shade.ge(this,a)},Shade.eq=d("==",f("=="),b(function(a,b){if(facet_typeOf(a)==="number"||facet_typeOf(a)==="boolean")return a===b;if(facet_typeOf(a)==="array")return _.all(_.map(_.zip(a,b),function(a){return a[0]===a[1]}),function(a){return a});if(facet_constant_type(a)==="vector")return vec.equal(a,b);if(facet_constant_type(a)==="matrix")return mat.equal(a,b);throw"internal error: unrecognized type "+facet_typeOf(a)+" "+facet_constant_type(a)})),Shade.Exp.eq=function(a){return Shade.eq(this,a)},Shade.ne=d("!=",f("!="),b(function(a,b){if(facet_typeOf(a)==="number"||facet_typeOf(a)==="boolean")return a!==b;if(facet_typeOf(a)==="array")return _.any(_.map(_.zip(a,b),function(a){return a[0]!==a[1]}),function(a){return a});throw"internal error: unrecognized type "+facet_typeOf(a)+" "+facet_constant_type(a)})),Shade.Exp.ne=function(a){return Shade.ne(this,a)}}(),Shade.ifelse=function(a,b,c){a=Shade.make(a),b=Shade.make(b),c=Shade.make(c);if(!b.type.equals(c.type))throw"ifelse return expressions must have same types";if(!a.type.equals(a.type))throw"ifelse condition must be of type bool";return Shade._create_concrete_value_exp({parents:[a,b,c],type:b.type,expression_type:"ifelse",_must_be_function_call:!0,value:function(){return"("+this.parents[0].evaluate()+"?"+this.parents[1].evaluate()+":"+this.parents[2].evaluate()+")"},constant_value:function(){return this.parents[0].is_constant()?this.parents[0].constant_value()?this.parents[1].constant_value():this.parents[2].constant_value():this.parents[1].constant_value()},is_constant:function(){if(!this.parents[0].is_constant()){if(this.parents[1].is_constant()&&this.parents[2].is_constant()){var a=this.parents[1].constant_value(),b=this.parents[2].constant_value();return this.type.constant_equal(a,b)}return!1}return this.parents[0].constant_value()?this.parents[1].is_constant():this.parents[2].is_constant()},element:function(a){return Shade.ifelse(this.parents[0],this.parents[1].element(a),this.parents[2].element(a))},element_constant_value:function(a){return this.parents[0].is_constant()?this.parents[0].constant_value()?this.parents[1].element_constant_value(a):this.parents[2].element_constant_value(a):this.parents[1].element_constant_value(a)},element_is_constant:function(a){if(!this.parents[0].is_constant()){if(this.parents[1].element_is_constant(a)&&this.parents[2].element_is_constant(a)){var b=this.parents[1].element_constant_value(a),c=this.parents[2].element_constant_value(a);return this.type.element_type(a).constant_equal(b,c)}return!1}return this.parents[0].constant_value()?this.parents[1].element_is_constant(a):this.parents[2].element_is_constant(a)},parent_is_unconditional:function(a){return a===0}})},Shade.Exp.ifelse=function(a,b){return Shade.ifelse(this,a,b)},Shade.rotation=Shade(function(a,b){b=b.normalize();var c=a.sin(),d=a.cos(),e=Shade.sub(1,d),f=b.at(0),g=b.at(1),h=b.at(2);return Shade.mat(Shade.vec(f.mul(f).mul(e).add(d),g.mul(f).mul(e).add(h.mul(c)),h.mul(f).mul(e).sub(g.mul(c)),0),Shade.vec(f.mul(g).mul(e).sub(h.mul(c)),g.mul(g).mul(e).add(d),h.mul(g).mul(e).add(f.mul(c)),0),Shade.vec(f.mul(h).mul(e).add(g.mul(c)),g.mul(h).mul(e).sub(f.mul(c)),h.mul(h).mul(e).add(d),0),Shade.vec(0,0,0,1))}),Shade.translation=Shade(function(){function a(a){return Shade.mat(Shade.vec(1,0,0,0),Shade.vec(0,1,0,0),Shade.vec(0,0,1,0),Shade.vec(a,1))}if(arguments.length===1){var b=arguments[0];if(!b.type.equals(Shade.Types.vec3))throw"expected vec3, got "+b.type.repr()+"instead";return a(b)}if(arguments.length===2){var c=arguments[0],d=arguments[1];if(!c.type.equals(Shade.Types.float_t))throw"expected float, got "+c.type.repr()+"instead";if(!d.type.equals(Shade.Types.float_t))throw"expected float, got "+d.type.repr()+"instead";return a(Shade.vec(c,d,0))}if(arguments.length===3){var c=arguments[0],d=arguments[1],e=arguments[2];if(!c.type.equals(Shade.Types.float_t))throw"expected float, got "+c.type.repr()+"instead";if(!d.type.equals(Shade.Types.float_t))throw"expected float, got "+d.type.repr()+"instead";if(!e.type.equals(Shade.Types.float_t))throw"expected float, got "+e.type.repr()+"instead";return a(Shade.vec(c,d,e))}throw"expected either 1, 2 or 3 parameters"}),Shade.ortho=Shade.make(function(a,b,c,d,e,f){var g=b.sub(a),h=d.sub(c),i=f.sub(e);return Shade.mat(Shade.vec(Shade.div(2,g),0,0,0),Shade.vec(0,Shade.div(2,h),0,0),Shade.vec(0,0,Shade.div(-2,i),0),Shade.vec(Shade.add(b,a).neg().div(g),Shade.add(d,c).neg().div(h),Shade.add(f,e).neg().div(i),1))}),Shade.look_at=function(a,b,c){a=Shade.make(a),b=Shade.make(b),c=Shade.make(c);var d=a.sub(b).normalize(),e=c.cross(d).normalize(),f=c.normalize();return Shade.mat(Shade.vec(e,0),Shade.vec(f,0),Shade.vec(d,0),Shade.vec(e.dot(a).neg(),f.dot(a).neg(),d.dot(a).neg(),1))},Shade.discard_if=function(a,b){a=Shade.make(a),b=Shade.make(b);var c=Shade._create_concrete_exp({is_constant:Shade.memoize_on_field("_is_constant",function(){var a=_.all(this.parents,function(a){return a.is_constant()});return a&&!this.parents[0].constant_value()}),_must_be_function_call:!0,type:a.type,expression_type:"discard_if",parents:[b,a],parent_is_unconditional:function(a){return a===0},compile:function(b){b.strings.push(a.type.repr(),this.glsl_name,"(void) {\n","    if (",this.parents[0].evaluate(),") discard;\n","    return ",this.parents[1].evaluate(),";\n}\n")},constant_value:function(){return a.constant_value()}});return c},Shade.id=function(a){var b=a&255,c=a>>8&255,d=a>>16&255,e=a>>24&255;return vec4.make([b/255,c/255,d/255,e/255])},Shade.shade_id=Shade(function(a){return a.div(Shade.vec(1,256,65536,16777216)).mod(256).floor().div(255)}),Shade.frustum=Shade.make(function(a,b,c,d,e,f){var g=b.sub(a),h=d.sub(c),i=f.sub(e);return Shade.mat(Shade.vec(e.mul(2).div(g),0,0,0),Shade.vec(0,e.mul(2).div(h),0,0),Shade.vec(b.add(a).div(g),d.add(c).div(h),f.add(e).neg().div(i),-1),Shade.vec(0,0,f.mul(e).mul(2).neg().div(i),0))}),Shade.perspective_matrix=Shade.make(function(a,b,c,d){var e=c.mul(Shade.tan(a.mul(Math.PI/360))),f=e.mul(b);return Shade.frustum(f.neg(),f,e.neg(),e,c,d)});return Shade})(),Shade.Colors={},Shade.Colors.alpha=function(a,b){a=Shade.make(a),b=Shade.make(b);if(!b.type.equals(Shade.Types.float_t))throw"alpha parameter must be float";if(a.type.equals(Shade.Types.vec4))return Shade.vec(a.swizzle("rgb"),b);if(a.type.equals(Shade.Types.vec3))return Shade.vec(a,b);throw"color parameter must be vec3 or vec4"},Shade.Exp.alpha=function(a){return Shade.Colors.alpha(this,a)},function(){function g(a,b){return a>.03928?Math.pow((a+.055)/1.055,b):a/12.92}function f(a,b){return a>.00304?1.055*Math.pow(a,1/b)-.055:12.92*a}function e(a,b,c){c>1&&(c-=1),c<0&&(c+=1);return c<1/6?a+(b-a)*c*6:c<.5?b:c<2/3?a+(b-a)*(2/3-c)*6:a}function d(a){var b,c,d;b=a.x+a.y+a.z,c=a.x/b,d=a.y/b;return[2*c/(6*d-c+1.5),4.5*d/(6*d-c+1.5)]}function a(a,b){if(_.isUndefined(b)||_.isUndefined(a))throw"Undefined!";return function(c){return a(b(c))}}var b={},c=["rgb","srgb","luv","hcl","hls","hsv","xyz"];_.each(c,function(a){b[a]={},b[a][a]=function(a){return a},b[a].create=function(d,e,f){var g=a.length,h=a[g-3],i=a[g-2],j=a[g-1],k={space:a,values:function(){return[this[h],this[i],this[j]]},as_shade:function(c){_.isUndefined(c)&&(c=1);var d=b[a].rgb(this);return Shade.vec(d.r,d.g,d.b,c)}};k[h]=d,k[i]=e,k[j]=f,_.each(c,function(c){k[c]=function(){return b[a][c](k)}});return k}}),b.rgb.hsv=function(a){var c=Math.min(a.r,a.g,a.b),d=Math.max(a.r,a.g,a.b);if(d!==c){var e=a.r===c?a.g-a.b:a.g===c?a.b-a.r:a.r-a.g,f=a.r===c?3:a.g===c?5:1;return b.hsv.create(Math.PI/3*(f-e/(d-c)),(d-c)/d,d)}return b.hsv.create(0,0,d)},b.rgb.hls=function(a){var c=Math.min(a.r,a.g,a.b),d=Math.max(a.r,a.g,a.b),e=(d+c)/2,f,g;d!==c?(e<.5?f=(d-c)/(d+c):f=(d-c)/(2-d-c),a.r===d?g=(a.g-a.b)/(d-c):a.g===d?g=2+(a.b-a.r)/(d-c):g=4+(a.r-a.g)/(d-c),g=g*Math.PI/3,g<0&&(g+=Math.PI*2),g>Math.PI*2&&(g-=Math.PI*2)):(f=0,g=0);return b.hls.create(g,e,f)},b.rgb.xyz=function(a){var c=h.y;return b.xyz.create(c*(.412453*a.r+.35758*a.g+.180423*a.b),c*(.212671*a.r+.71516*a.g+.072169*a.b),c*(.019334*a.r+.119193*a.g+.950227*a.b))},b.rgb.srgb=function(a){return b.srgb.create(f(a.r,2.4),f(a.g,2.4),f(a.b,2.4))},b.srgb.xyz=function(a){var c=h.y,d=g(a.r,2.4),e=g(a.g,2.4),f=g(a.b,2.4);return b.xyz.create(c*(.412453*d+.35758*e+.180423*f),c*(.212671*d+.71516*e+.072169*f),c*(.019334*d+.119193*e+.950227*f))},b.srgb.rgb=function(a){var c=b.rgb.create(g(a.r,2.4),g(a.g,2.4),g(a.b,2.4));return c},b.srgb.hls=a(b.rgb.hls,b.srgb.rgb),b.srgb.hsv=a(b.rgb.hsv,b.srgb.rgb),b.xyz.luv=function(a){var c,e=d(a);c=a.y/h.y;var f=c>.008856?116*Math.pow(c,1/3)-16:903.3*c;return b.luv.create(f,13*f*(e[0]-i[0]),13*f*(e[1]-i[1]))},b.rgb.luv=a(b.xyz.luv,b.rgb.xyz),b.srgb.luv=a(b.rgb.luv,b.srgb.rgb),b.xyz.rgb=function(a){var c=h.y;return b.rgb.create((3.240479*a.x-1.53715*a.y-.498535*a.z)/c,(-0.969256*a.x+1.875992*a.y+.041556*a.z)/c,(.055648*a.x-.204043*a.y+1.057311*a.z)/c)},b.xyz.hls=a(b.rgb.hls,b.xyz.rgb),b.xyz.hsv=a(b.rgb.hsv,b.xyz.rgb),b.xyz.srgb=function(a){var c=h.y;return b.srgb.create(f((3.240479*a.x-1.53715*a.y-.498535*a.z)/c,2.4),f((-0.969256*a.x+1.875992*a.y+.041556*a.z)/c,2.4),f((.055648*
a.x-.204043*a.y+1.057311*a.z)/c,2.4))},b.luv.hcl=function(a){var c=Math.sqrt(a.u*a.u+a.v*a.v),d=Math.atan2(a.v,a.u);while(d>Math.PI*2)d-=Math.PI*2;while(d<0)d+=Math.PI*2;return b.hcl.create(d,c,a.l)},b.rgb.hcl=a(b.luv.hcl,b.rgb.luv),b.srgb.hcl=a(b.luv.hcl,b.srgb.luv),b.xyz.hcl=a(b.rgb.hcl,b.xyz.rgb),b.luv.xyz=function(a){var c=0,d=0,e=0;if(!(a.l<=0&&a.u==0&&a.v==0)){d=h.y*(a.l>7.999592?Math.pow((a.l+16)/116,3):a.l/903.3);var f=a.u/(13*a.l)+i[0],g=a.v/(13*a.l)+i[1];c=9*d*f/(4*g),e=-c/3-5*d+3*d/g}return b.xyz.create(c,d,e)},b.luv.rgb=a(b.xyz.rgb,b.luv.xyz),b.luv.hls=a(b.rgb.hls,b.luv.rgb),b.luv.hsv=a(b.rgb.hsv,b.luv.rgb),b.luv.srgb=a(b.rgb.srgb,b.luv.rgb),b.hcl.luv=function(a){return b.luv.create(a.l,a.c*Math.cos(a.h),a.c*Math.sin(a.h))},b.hcl.rgb=a(b.luv.rgb,b.hcl.luv),b.hcl.srgb=a(b.luv.srgb,b.hcl.luv),b.hcl.hsv=a(b.luv.hsv,b.hcl.luv),b.hcl.hls=a(b.luv.hls,b.hcl.luv),b.hcl.xyz=a(b.luv.xyz,b.hcl.luv),b.hls.rgb=function(a){var c,d;a.l<=.5?d=a.l*(1+a.s):d=a.l+a.s-a.l*a.s,c=2*a.l-d;return a.s===0?b.rgb.create(a.l,a.l,a.l):b.rgb.create(e(c,d,(a.h+Math.PI*2/3)/(Math.PI*2)),e(c,d,a.h/(Math.PI*2)),e(c,d,(a.h-Math.PI*2/3)/(Math.PI*2)))},b.hls.srgb=a(b.rgb.srgb,b.hls.rgb),b.hls.hsv=a(b.rgb.hsv,b.hls.rgb),b.hls.xyz=a(b.rgb.xyz,b.hls.rgb),b.hls.luv=a(b.rgb.luv,b.hls.rgb),b.hls.hcl=a(b.rgb.hcl,b.hls.rgb),b.hsv.rgb=function(a){if(isNaN(a.h))return b.rgb.create(a.v,a.v,a.v);var c=a.v,d=a.h/Math.PI*3,e=Math.floor(d),f=d-e;e&1||(f=1-f);var g=c*(1-a.s),h=c*(1-a.s*f);switch(e){case 6:case 0:return b.rgb.create(c,h,g);case 1:return b.rgb.create(h,c,g);case 2:return b.rgb.create(g,c,h);case 3:return b.rgb.create(g,h,c);case 4:return b.rgb.create(h,g,c);case 5:return b.rgb.create(c,g,h);default:throw"internal error"}},b.hsv.srgb=a(b.rgb.srgb,b.hsv.rgb),b.hsv.hls=a(b.rgb.hls,b.hsv.rgb),b.hsv.xyz=a(b.rgb.xyz,b.hsv.rgb),b.hsv.luv=a(b.rgb.luv,b.hsv.rgb),b.hsv.hcl=a(b.rgb.hcl,b.hsv.rgb);var h=b.xyz.create(95.047,100,108.883),i=d(h);Shade.Colors.jstable=b}(),function(){function j(a){return Shade.max(a.r,Shade.max(a.g,a.b))}function i(a){return Shade.min(a.r,Shade.min(a.g,a.b))}function h(a,c){return b(a.gt(.03928),Shade.pow(a.add(.055).div(1.055),c),a.div(12.92))}function g(a,c){return b(a.gt(.00304),Shade.mul(1.055,Shade.pow(a,Shade.div(1,c))).sub(.055),a.mul(12.92))}function f(a,c,d){d=b(d.gt(1),d.sub(1),d),d=b(d.lt(0),d.add(1),d);return b(d.lt(1/6),a.add(c.sub(a).mul(d.mul(6))),b(d.lt(.5),c,b(d.lt(2/3),a.add(c.sub(a).mul(Shade.make(2/3).sub(d).mul(6))),a)))}function e(a){var b,c,d;b=a.x.add(a.y).add(a.z),c=a.x.div(b),d=a.y.div(b);return Shade.vec(c.mul(2).div(d.mul(6).sub(c).add(1.5)),d.mul(4.5).div(d.mul(6).sub(c).add(1.5)))}function a(a,b){if(_.isUndefined(b)||_.isUndefined(a))throw"Undefined!";return function(c){return a(b(c))}}var b=Shade.ifelse,c={},d=["rgb","srgb","luv","hcl","hls","hsv","xyz"];_.each(d,function(a){Shade.Colors[a]=function(b,c,d,e){_.isUndefined(e)&&(e=1);return Shade.Colors.shadetable[a].create(b,c,d).as_shade(e)},c[a]={},c[a][a]=function(a){return a},c[a].create=function(){var b;if(arguments.length===1){b=arguments[0];if(!b.type.equals(Shade.Types.vec3))throw"create with 1 parameter requires a vec3"}else{if(arguments.length!==3)throw"create requires either 1 vec3 or 3 floats";b=Shade.vec(arguments[0],arguments[1],arguments[2]);if(!b.type.equals(Shade.Types.vec3))throw"create with 3 parameter requires 3 floats"}var e=a.length,f=a[e-3],g=a[e-2],h=a[e-1],i={space:a,vec:b,values:function(){return[this[f].constant_value(),this[g].constant_value(),this[h].constant_value()]},as_shade:function(a){_.isUndefined(a)&&(a=Shade.make(1));var b=this.rgb().vec;return Shade.vec(this.rgb().vec,a)}};i[f]=b.swizzle("r"),i[g]=b.swizzle("g"),i[h]=b.swizzle("b"),_.each(d,function(b){i[b]=function(){return c[a][b](i)}});return i}}),c.rgb.hsv=function(a){var d=i(a),e=j(a),f=b(a.r.eq(d),a.g.sub(a.b),b(a.g.eq(d),a.b.sub(a.r),a.r.sub(a.g))),g=b(a.r.eq(d),3,b(a.g.eq(d),5,1));return c.hsv.create(b(e.eq(d),Shade.vec(0,0,e),Shade.vec(Shade.mul(Math.PI/3,g.sub(f.div(e.sub(d)))),e.sub(d).div(e),e)))},c.rgb.hls=function(a){var d=i(a),e=j(a),f=e.add(d).div(2),g,h,k=e.ne(d);g=b(k,b(f.lt(.5),e.sub(d).div(e.add(d)),e.sub(d).div(Shade.sub(2,e).sub(d))),0),h=b(k,b(a.r.eq(e),a.g.sub(a.b).div(e.sub(d)),b(a.g.eq(e),Shade.add(2,a.b.sub(a.r).div(e.sub(d))),Shade.add(4,a.r.sub(a.g).div(e.sub(d))))),0),h=h.mul(Math.PI/3),h=b(h.lt(0),h.add(Math.PI*2),b(h.gt(Math.PI*2),h.sub(Math.PI*2),h));return c.hls.create(h,f,g)},c.rgb.xyz=function(a){var b=k.y;return c.xyz.create(b.mul(a.r.mul(.412453).add(a.g.mul(.35758)).add(a.b.mul(.180423))),b.mul(a.r.mul(.212671).add(a.g.mul(.71516)).add(a.b.mul(.072169))),b.mul(a.r.mul(.019334).add(a.g.mul(.119193)).add(a.b.mul(.950227))))},c.rgb.srgb=function(a){return c.srgb.create(g(a.r,2.4),g(a.g,2.4),g(a.b,2.4))},c.srgb.xyz=function(a){var b=k.y,d=h(a.r,2.4),e=h(a.g,2.4),f=h(a.b,2.4);return c.xyz.create(b.mul(d.mul(.412453).add(e.mul(.35758)).add(f.mul(.180423))),b.mul(d.mul(.212671).add(e.mul(.71516)).add(f.mul(.072169))),b.mul(d.mul(.019334).add(e.mul(.119193)).add(f.mul(.950227))))},c.srgb.rgb=function(a){var b=c.rgb.create(h(a.r,2.4),h(a.g,2.4),h(a.b,2.4));return b},c.srgb.hls=a(c.rgb.hls,c.srgb.rgb),c.srgb.hsv=a(c.rgb.hsv,c.srgb.rgb),c.xyz.luv=function(a){var d,f=e(a);d=a.y.div(k.y);var g=b(d.gt(.008856),Shade.mul(116,Shade.pow(d,1/3)).sub(16),Shade.mul(903.3,d));return c.luv.create(Shade.vec(g,g.mul(f.sub(l)).mul(13)))},c.rgb.luv=a(c.xyz.luv,c.rgb.xyz),c.srgb.luv=a(c.rgb.luv,c.srgb.rgb),c.xyz.rgb=function(a){var b=k.y;return c.rgb.create(a.x.mul(3.240479).sub(a.y.mul(1.53715)).sub(a.z.mul(.498535)).div(b),a.x.mul(-0.969256).add(a.y.mul(1.875992)).add(a.z.mul(.041556)).div(b),a.x.mul(.055648).sub(a.y.mul(.204043)).add(a.z.mul(1.057311)).div(b))},c.xyz.hls=a(c.rgb.hls,c.xyz.rgb),c.xyz.hsv=a(c.rgb.hsv,c.xyz.rgb),c.xyz.srgb=function(a){var b=k.y;return c.srgb.create(g(a.x.mul(3.240479).sub(a.y.mul(1.53715)).sub(a.z.mul(.498535)).div(b),2.4),g(a.x.mul(-0.969256).add(a.y.mul(1.875992)).add(a.z.mul(.041556)).div(b),2.4),g(a.x.mul(.055648).sub(a.y.mul(.204043)).add(a.z.mul(1.057311)).div(b),2.4))},c.luv.hcl=function(a){var d=Shade.norm(a.vec.swizzle("gb")),e=Shade.atan(a.v,a.u);e=b(e.gt(Math.PI*2),e.sub(Math.PI*2),b(e.lt(0),e.add(Math.PI*2),e));while(e>Math.PI*2)e-=Math.PI*2;while(e<0)e+=Math.PI*2;return c.hcl.create(e,d,a.l)},c.rgb.hcl=a(c.luv.hcl,c.rgb.luv),c.srgb.hcl=a(c.luv.hcl,c.srgb.luv),c.xyz.hcl=a(c.rgb.hcl,c.xyz.rgb),c.luv.xyz=function(a){var d=a.vec.swizzle("gb").div(a.l.mul(13)).add(l),e=d.swizzle("r"),f=d.swizzle("g"),g=k.y.mul(b(a.l.gt(7.999592),Shade.pow(a.l.add(16).div(116),3),a.l.div(903.3))),h=g.mul(9).mul(e).div(f.mul(4)),i=h.div(-3).sub(g.mul(5)).add(g.mul(3).div(f));return c.xyz.create(b(a.l.le(0).and(a.u.eq(0).and(a.v.eq(0))),Shade.vec(0,0,0),Shade.vec(h,g,i)))},c.luv.rgb=a(c.xyz.rgb,c.luv.xyz),c.luv.hls=a(c.rgb.hls,c.luv.rgb),c.luv.hsv=a(c.rgb.hsv,c.luv.rgb),c.luv.srgb=a(c.rgb.srgb,c.luv.rgb),c.hcl.luv=function(a){return c.luv.create(a.l,a.c.mul(a.h.cos()),a.c.mul(a.h.sin()))},c.hcl.rgb=a(c.luv.rgb,c.hcl.luv),c.hcl.srgb=a(c.luv.srgb,c.hcl.luv),c.hcl.hsv=a(c.luv.hsv,c.hcl.luv),c.hcl.hls=a(c.luv.hls,c.hcl.luv),c.hcl.xyz=a(c.luv.xyz,c.hcl.luv),c.hls.rgb=function(a){var d=b(a.l.le(.5),a.l.mul(a.s.add(1)),a.l.add(a.s).sub(a.l.mul(a.s))),e=a.l.mul(2).sub(d);return c.rgb.create(b(a.s.eq(0),Shade.vec(a.vec.swizzle("ggg")),Shade.vec(f(e,d,a.h.add(Math.PI*2/3).div(Math.PI*2)),f(e,d,a.h.div(Math.PI*2)),f(e,d,a.h.sub(Math.PI*2/3).div(Math.PI*2)))))},c.hls.srgb=a(c.rgb.srgb,c.hls.rgb),c.hls.hsv=a(c.rgb.hsv,c.hls.rgb),c.hls.xyz=a(c.rgb.xyz,c.hls.rgb),c.hls.luv=a(c.rgb.luv,c.hls.rgb),c.hls.hcl=a(c.rgb.hcl,c.hls.rgb),c.hsv.rgb=function(a){var d=a.v,e=a.h.div(Math.PI).mul(3),f=e.floor(),g=e.sub(f);g=b(f.div(2).floor().eq(f.div(2)),Shade.sub(1,g),g);var h=d.mul(Shade.sub(1,a.s)),i=d.mul(Shade.sub(1,a.s.mul(g)));return c.rgb.create(b(f.eq(0),Shade.vec(d,i,h),b(f.eq(1),Shade.vec(i,d,h),b(f.eq(2),Shade.vec(h,d,i),b(f.eq(3),Shade.vec(h,i,d),b(f.eq(4),Shade.vec(i,h,d),b(f.eq(5),Shade.vec(d,h,i),Shade.vec(d,i,h))))))))},c.hsv.srgb=a(c.rgb.srgb,c.hsv.rgb),c.hsv.hls=a(c.rgb.hls,c.hsv.rgb),c.hsv.xyz=a(c.rgb.xyz,c.hsv.rgb),c.hsv.luv=a(c.rgb.luv,c.hsv.rgb),c.hsv.hcl=a(c.rgb.hcl,c.hsv.rgb);var k=c.xyz.create(95.047,100,108.883),l=e(k);Shade.Colors.shadetable=c}(),Shade.Bits={},Shade.Bits.encode_float=Shade.make(function(a){var b,c,d,e,f=a.eq(0),g=a.gt(0).ifelse(0,1);a=a.abs();var h=a.log2().floor(),i=h.add(127),j=a.div(h.exp2()).sub(1).mul(8388608),k=i.div(2),l=k.fract().mul(2),m=k.floor();e=Shade.Bits.extract_bits(j,0,8).div(255),d=Shade.Bits.extract_bits(j,8,16).div(255),c=l.mul(128).add(Shade.Bits.extract_bits(j,16,23)).div(255),b=g.mul(128).add(m).div(255);return f.ifelse(Shade.vec(0,0,0,0),Shade.vec(e,d,c,b))}),Shade.Bits.extract_bits=Shade.make(function(a,b,c){b=b.add(.5).floor(),c=c.add(.5).floor();return Shade.Bits.mask_last(Shade.Bits.shift_right(a,b),c.sub(b))}),Shade.Bits.mask_last=Shade.make(function(a,b){return a.mod(Shade.Bits.shift_left(1,b))}),Shade.Bits.shift_left=Shade.make(function(a,b){return a.mul(b.exp2()).round()}),Shade.Bits.shift_right=Shade.make(function(a,b){a=a.floor().add(.5);return a.div(b.exp2()).floor()}),Facet.Marks={},Facet.Marks.aligned_rects=function(a){a=_.defaults(a||{},{mode:Facet.DrawingMode.standard,z:function(){return 0}});if(!a.elements)throw"elements is a required field";if(!a.left)throw"left is a required field";if(!a.right)throw"right is a required field";if(!a.top)throw"top is a required field";if(!a.bottom)throw"bottom is a required field";if(!a.color)throw"color is a required field";var b=Facet.attribute_buffer(_.range(a.elements*6),1),c=Shade.div(b,6).floor(),d=Shade.mod(b,6).floor(),e=function(a,b){return facet_typeOf(a)==="function"?a.apply(this,b):a},f=e(a.left,[c]),g=e(a.right,[c]),h=e(a.bottom,[c]),i=e(a.top,[c]),j=e(a.color,[c,r]),k=e(a.z,[c]),l=Shade.vec(f,h),m=Shade.vec(g,h),n=Shade.vec(f,i),o=Shade.vec(g,i),p=Shade.array([l,o,n,l,m,o]),q=Shade.array([0,2,3,0,1,2]),r=q.at(d);return Facet.bake({type:"triangles",elements:b},{position:Shade.vec(p.at(d),k),color:j,pick_id:a.pick_id,mode:a.mode})},Facet.Marks.lines=function(a){a=_.defaults(a||{},{mode:Facet.DrawingMode.standard,z:function(){return 0}});if(_.isUndefined(a.elements))throw"elements is a required field";if(_.isUndefined(a.color))throw"color is a required field";if(_.isUndefined(a.position)&&(_.isUndefined(a.x)||_.isUndefined(a.y)))throw"either position or x and y are required fields";var b=Facet.attribute_buffer(_.range(a.elements*2),1),c=Shade.div(b,2).floor(),d=Shade.mod(b,2).floor(),e=a.position?a.position(c,d):Shade.vec(a.x(c,d),a.y(c,d),a.z(c,d));return Facet.bake({type:"lines",elements:b,mode:a.mode},{position:e,color:a.color(c,d)})},Facet.Marks.dots=function(a){a=_.defaults(a,{fill_color:Shade.vec(0,0,0,1),stroke_color:Shade.vec(0,0,0,1),point_diameter:5,stroke_width:2,mode:Facet.DrawingMode.over_with_depth,alpha:!0,plain:!1});if(!a.position)throw"missing required parameter 'position'";if(!a.elements)throw"missing required parameter 'elements'";var b=Shade,c=Shade(a.fill_color),d=Shade(a.stroke_color),e=Shade(a.point_diameter),f=Shade(a.stroke_width).add(1),g=Shade(a.alpha);a.plain=Shade(a.plain);var h={type:"points",vertex:a.position,elements:a.elements},i=Facet.model(h),j=b.pointCoord().sub(b.vec(.5,.5)).norm().mul(e),k=e.div(2),l=k.sub(j),m=i.vertex,n=b.mix(c,d,b.clamp(f.sub(l),0,1)),o=c,p=b.ifelse(g,n.mul(b.vec(1,1,1,b.clamp(l,0,1))),n).discard_if(j.gt(k)),q=Facet.bake(i,{position:m,point_size:e,color:a.plain.ifelse(o,p),mode:a.mode,pick_id:a.pick_id});q.gl_Position=m;return q},Facet.Marks.scatterplot=function(a){function b(a){return a.mul(2).sub(1)}a=_.defaults(a,{x_scale:function(a){return a},y_scale:function(a){return a},xy_scale:function(a){return a}});var c=Shade,d=a.x_scale,e=a.y_scale,f,g;_.isUndefined(a.x)?_.isUndefined(a.xy)||(f=a.xy_scale(a.xy).mul(2).sub(c.vec(1,1))):f=c.vec(b(a.x_scale(a.x)),b(a.y_scale(a.y))),a.model?g=a.model.elements:a.elements&&(g=a.elements);return Facet.Marks.dots({position:f,elements:g,fill_color:a.fill_color,stroke_color:a.stroke_color,point_diameter:a.point_diameter,stroke_width:a.stroke_width,mode:a.mode,alpha:a.alpha,plain:a.plain,pick_id:a.pick_id})},Facet.Marks.globe=function(a){function j(a){var b=a%f,c=~~(a/f);return{texture:i,offset_x:b,offset_y:c,active:0,x:-1,y:-1,zoom:-1,last_touched:0}}a=_.defaults(a||{},{longitude_center:-98,latitude_center:38,zoom:3,resolution_bias:0,patch_size:10});var b=Shade.parameter("mat4"),c=spherical_mercator_patch(a.patch_size),d=64,e=256,f=1<<~~Math.round(Math.log(Math.sqrt(d))/Math.log(2)),g=e*f,h=Facet._globals.ctx,i=Facet.texture({width:g,height:g}),k=[];for(var l=0;l<d;++l)k.push(j(l));var m=!1,n=!1,o,p=[0,0],q=[0,0],r=Shade.parameter("float"),s=Shade.parameter("float"),t=Shade.parameter("float"),u=Shade.parameter("float"),v=Shade.parameter("float"),w=Shade.parameter("float"),x=1/f,y=Shade.parameter("sampler2D"),z=c.vertex(Shade.vec(r,t),Shade.vec(s,u)),A=a.view_proj(b),B=c.uv.mul((e-1)/e).add(.5/e).add(Shade.vec(v,w)).mul(x),C=Facet.bake(c,{gl_Position:A(z),gl_FragColor:Shade.texture2D(y,B).discard_if(b.mul(z).z().lt(0)),mode:Facet.DrawingMode.pass}),D={tiles:k,queue:[],current_osm_zoom:3,longitude_center:a.longitude_center,latitude_center:a.latitude_center,zoom:a.zoom,model_matrix:b,mvp:A,resolution_bias:a.resolution_bias,update_model_matrix:function(){while(this.longitude_center<0)this.longitude_center+=360;while(this.longitude_center>360)this.longitude_center-=360;var a=Facet.rotation(this.latitude_center*(Math.PI/180),[1,0,0]),b=Facet.rotation(this.longitude_center*(Math.PI/180),[0,-1,0]);this.model_matrix.set(mat4.product(a,b))},mousedown:function(a){o=[a.offsetX,a.offsetY],p=[0,0],q=[0,0],Facet.Scene.invalidate()},mousemove:function(a){var b=Facet._globals.ctx,c=b.viewportWidth,d=b.viewportHeight,e=218.18,f=109.09;a.which&1&&!a.shiftKey&&(n=!0,this.longitude_center-=(a.offsetX-o[0])/(c*this.zoom/e),this.latitude_center+=(a.offsetY-o[1])/(d*this.zoom/f),this.latitude_center=Math.max(Math.min(80,this.latitude_center),-80),this.update_model_matrix(),Facet.Scene.invalidate()),a.which&1&&a.shiftKey&&(m=!0,this.zoom*=1+(a.offsetY-o[1])/240,Facet.Scene.invalidate()),this.new_center(this.latitude_center,this.longitude_center,this.zoom),o=[a.offsetX,a.offsetY]},mouseup:function(a){var b=Facet._globals.ctx,c=b.viewportWidth,d=b.viewportHeight,e=218.18,f=109.09,g=this;if(n){p[0]=-(a.offsetX-o[0])/(c*g.zoom/e),p[1]=(a.offsetY-o[1])/(d*g.zoom/f),q[0]=p[0]===0?1:p[0],q[1]=p[1]===0?1:p[1],o=[a.offsetX,a.offsetY];var h=function(){var a=Facet._globals.ctx;a.display(),g.longitude_center+=p[0],g.latitude_center+=p[1],g.latitude_center=Math.max(Math.min(80,g.latitude_center),-80),g.update_model_matrix(),p[0]*=.95,p[1]*=.95,Math.max(Math.abs(p[0]/q[0]),Math.abs(p[1]/q[0]))>.01&&window.requestAnimFrame(h,g.canvas)};h()}n=m=!1},new_center:function(a,b,c){var d=Facet._globals.ctx,e=d.viewportWidth,f=63.6396,g=Math.log(e/f)/Math.log(2),h=this.resolution_bias+g+Math.log(c/2.6)/Math.log(2);h=~~h,this.current_osm_zoom=h;var i=latlong_to_mercator(a,b),j=(i[1]/(Math.PI*2)+.5)*(1<<h),k=i[0]/(Math.PI*2)*(1<<h);j=(1<<h)-j-1,k=k+(1<<h-1)&(1<<h)-1;for(var l=-2;l<=2;++l)for(var m=-2;m<=2;++m){var n=~~k+l,o=~~j+m;if(o<0||o>=1<<h)continue;n<0&&(n+=1<<h),n>=1<<h&&(n-=1<<h),this.request(n,o,~~h)}},get_available_id:function(a,b,c){var e=(new Date).getTime();for(var f=0;f<d;++f)if(this.tiles[f].x==a&&this.tiles[f].y==b&&this.tiles[f].zoom==c&&this.tiles[f].active!=0){this.tiles[f].last_touched=e;return f}for(f=0;f<d;++f)if(!this.tiles[f].active){this.tiles[f].last_touched=e;return f}var g=-1,h=1e+30;for(f=0;f<d;++f){if(this.tiles[f].active==1)continue;var i=this.tiles[f].last_touched;i<h&&(h=i,g=f)}return g},init:function(){for(var a=0;a<3;++a)for(var b=0;b<1<<a;++b)for(var c=0;c<1<<a;++c)this.request(b,c,a);this.new_center(this.latitude_center,this.longitude_center,this.zoom),this.update_model_matrix()},sanity_check:function(){var a={};for(var b=0;b<d;++b){$("#x"+b).text(this.tiles[b].x),$("#y"+b).text(this.tiles[b].y),$("#z"+b).text(this.tiles[b].zoom);if(this.tiles[b].active!==2)continue;var c=this.tiles[b].x+"-"+this.tiles[b].y+"-"+this.tiles[b].zoom;if(a[c]!==undefined){console.log("BAD STATE!",this.tiles[b].x,this.tiles[b].y,this.tiles[b].zoom,this.tiles[b].active,c);throw"die"}a[c]=!0}},request:function(a,b,c){var d=this,f=this.get_available_id(a,b,c);if(f===-1)alert("Could not fulfill request "+a+" "+b+" "+c);else{if(this.tiles[f].x==a&&this.tiles[f].y==b&&this.tiles[f].zoom==c)return;d.tiles[f].x=a,d.tiles[f].y=b,d.tiles[f].zoom=c,this.tiles[f].active=1;var g=function(a,b,c,e){return function(){d.tiles[e].active=2,d.tiles[e].last_touched=(new Date).getTime(),Facet.Scene.invalidate()}};Facet.load_image_into_texture({texture:k[f].texture,src:"http://tile.openstreetmap.org/"+c+"/"+a+"/"+b+".png",crossOrigin:"anonymous",x_offset:k[f].offset_x*e,y_offset:k[f].offset_y*e,onload:g(a,b,c,f)})}},draw:function(){var a=Facet._globals.ctx,b=_.range(d),c=this;b.sort(function(a,b){var d=Math.abs(k[a].zoom-c.current_osm_zoom),e=Math.abs(k[b].zoom-c.current_osm_zoom);return e-d}),y.set(i);for(var e=0;e<d;++e){var f=k[b[e]];if(f.active!==2)continue;r.set(f.x/(1<<f.zoom)*Math.PI*2+Math.PI),t.set((1-(f.y+1)/(1<<f.zoom))*Math.PI*2-Math.PI),s.set((f.x+1)/(1<<f.zoom)*Math.PI*2+Math.PI),u.set((1-f.y/(1<<f.zoom))*Math.PI*2-Math.PI),v.set(f.offset_x),w.set(f.offset_y),C.draw()}}};return D},Facet.Models={},Facet.Models.flat_cube=function(){return Facet.model({type:"triangles",elements:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],vertex:[[1,1,-1,-1,1,-1,-1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1],3],normal:[[0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0],3],tex_coord:[[0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],2]})},Facet.Models.mesh=function(a,b){var c=[],d=[];_.isUndefined(b)&&(b=a);if(b<=0)throw"v_secs must be positive";if(a<=0)throw"u_secs must be positive";b=Math.floor(b),a=Math.floor(a);var e,f;for(e=0;e<=b;++e){var g=e/b;for(f=0;f<=a;++f){var h=f/a;c.push(h,g)}}for(e=0;e<b;++e){for(f=0;f<=a;++f)d.push(e*(a+1)+f,(e+1)*(a+1)+f);e<b-1&&d.push((e+1)*(a+1)+a,(e+2)*(a+1),(e+2)*(a+1))}var i=Shade(Facet.attribute_buffer(c,2));return Facet.model({type:"triangle_strip",tex_coord:i,vertex:i.mul(2).sub(1),elements:Facet.element_buffer(d)})},Facet.Models.sphere=function(a,b){var c=[],d=[];_.isUndefined(b)&&(b=a);if(a<=0)throw"lat_secs must be positive";if(b<=0)throw"long_secs must be positive";a=Math.floor(a),b=Math.floor(b);var e,f,g,h;for(e=0;e<=a;++e){g=e/a;for(f=0;f<b;++f)h=f/b,c.push(h,g)}for(e=0;e<a;++e)for(f=0;f<b;++f)d.push(e*b+f,e*b+(f+1)%b,(e+1)*b+f,e*b+(f+1)%b,(e+1)*b+(f+1)%b,(e+1)*b+f);var i=Shade,j=Facet.attribute_buffer(c,2);g=i.sub(i.mul(Math.PI,i.swizzle(j,"r")),Math.PI/2),h=i.mul(2*Math.PI,i.swizzle(j,"g"));var k=i.cos(g);return Facet.model({type:"triangles",elements:Facet.element_buffer(d),vertex:i.vec(i.sin(h).mul(k),i.sin(g),i.cos(h).mul(k),1)})},Facet.Models.square=function(){var a=Shade(Facet.attribute_buffer([0,0,1,0,0,1,1,1],2));return Facet.model({type:"triangles",elements:Facet.element_buffer([0,1,2,1,3,2]),vertex:a,tex_coord:a})},Facet.Models.teapot=function(){var a=[2.1,3.6,0,2.071,3.711,0,2.105,3.748,0,2.174,3.711,0,2.25,3.6,0,1.937,3.6,.8242,1.91,3.711,.8128,1.942,3.748,.8261,2.005,3.711,.8532,2.076,3.6,.8831,1.491,3.6,1.491,1.47,3.711,1.47,1.494,3.748,1.494,1.543,3.711,1.543,1.597,3.6,1.597,.8242,3.6,1.937,.8128,3.711,1.91,.8261,3.748,1.942,.8532,3.711,2.005,.8831,3.6,2.076,0,3.6,2.1,0,3.711,2.071,0,3.748,2.105,0,3.711,2.174,0,3.6,2.25,-0.8812,3.6,1.937,-0.8368,3.711,1.91,-0.8332,3.748,1.942,-0.8541,3.711,2.005,-0.8831,3.6,2.076,-1.542,3.6,1.491,-1.492,3.711,1.47,-1.501,3.748,1.494,-1.544,3.711,1.543,-1.597,3.6,1.597,-1.956,3.6,.8242,-1.918,3.711,.8128,-1.944,3.748,.8261,-2.006,3.711,.8532,-2.076,3.6,.8831,-2.1,3.6,0,-2.071,3.711,0,-2.105,3.748,0,-2.174,3.711,0,-2.25,3.6,0,-1.937,3.6,-0.8242,-1.91,3.711,-0.8128,-1.942,3.748,-0.8261,-2.005,3.711,-0.8532,-2.076,3.6,-0.8831,-1.491,3.6,-1.491,-1.47,3.711,-1.47,-1.494,3.748,-1.494,-1.543,3.711,-1.543,-1.597,3.6,-1.597,-0.8242,3.6,-1.937,-0.8128,3.711,-1.91,-0.8261,3.748,-1.942,-0.8532,3.711,-2.005,-0.8831,3.6,-2.076,0,3.6,-2.1,0,3.711,-2.071,0,3.748,-2.105,0,3.711,-2.174,0,3.6,-2.25,.8242,3.6,-1.937,.8128,3.711,-1.91,.8261,3.748,-1.942,.8532,3.711,-2.005,.8831,3.6,-2.076,1.491,3.6,-1.491,1.47,3.711,-1.47,1.494,3.748,-1.494,1.543,3.711,-1.543,1.597,3.6,-1.597,1.937,3.6,-0.8242,1.91,3.711,-0.8128,1.942,3.748,-0.8261,2.005,3.711,-0.8532,2.076,3.6,-0.8831,2.525,3.011,0,2.766,2.433,0,2.936,1.876,0,3,1.35,0,2.33,3.011,.9912,2.551,2.433,1.086,2.708,1.876,1.152,2.767,1.35,1.178,1.793,3.011,1.793,1.964,2.433,1.964,2.084,1.876,2.084,2.13,1.35,2.13,.9912,3.011,2.33,1.086,2.433,2.551,1.152,1.876,2.708,1.178,1.35,2.767,0,3.011,2.525,0,2.433,2.766,0,1.876,2.936,0,1.35,3,-0.9912,3.011,2.33,-1.086,2.433,2.551,-1.152,1.876,2.708,-1.178,1.35,2.767,-1.793,3.011,1.793,-1.964,2.433,1.964,-2.084,1.876,2.084,-2.13,1.35,2.13,-2.33,3.011,.9912,-2.551,2.433,1.086,-2.708,1.876,1.152,-2.767,1.35,1.178,-2.525,3.011,0,-2.766,2.433,0,-2.936,1.876,0,-3,1.35,0,-2.33,3.011,-0.9912,-2.551,2.433,-1.086,-2.708,1.876,-1.152,-2.767,1.35,-1.178,-1.793,3.011,-1.793,-1.964,2.433,-1.964,-2.084,1.876,-2.084,-2.13,1.35,-2.13,-0.9912,3.011,-2.33,-1.086,2.433,-2.551,-1.152,1.876,-2.708,-1.178,1.35,-2.767,0,3.011,-2.525,0,2.433,-2.766,0,1.876,-2.936,0,1.35,-3,.9912,3.011,-2.33,1.086,2.433,-2.551,1.152,1.876,-2.708,1.178,1.35,-2.767,1.793,3.011,-1.793,1.964,2.433,-1.964,2.084,1.876,-2.084,2.13,1.35,-2.13,2.33,3.011,-0.9912,2.551,2.433,-1.086,2.708,1.876,-1.152,2.767,1.35,-1.178,2.883,.9053,0,2.625,.5766,0,2.367,.3533,0,2.25,.225,0,2.659,.9053,1.132,2.422,.5766,1.03,2.184,.3533,.9291,2.076,.225,.8831,2.047,.9053,2.047,1.864,.5766,1.864,1.681,.3533,1.681,1.597,.225,1.597,1.132,.9053,2.659,1.03,.5766,2.422,.9291,.3533,2.184,.8831,.225,2.076,0,.9053,2.883,0,.5766,2.625,0,.3533,2.367,0,.225,2.25,-1.132,.9053,2.659,-1.03,.5766,2.422,-0.9291,.3533,2.184,-0.8831,.225,2.076,-2.047,.9053,2.047,-1.864,.5766,1.864,-1.681,.3533,1.681,-1.597,.225,1.597,-2.659,.9053,1.132,-2.422,.5766,1.03,-2.184,.3533,.9291,-2.076,.225,.8831,-2.883,.9053,0,-2.625,.5766,0,-2.367,.3533,0,-2.25,.225,0,-2.659,.9053,-1.132,-2.422,.5766,-1.03,-2.184,.3533,-0.9291,-2.076,.225,-0.8831,-2.047,.9053,-2.047,-1.864,.5766,-1.864,-1.681,.3533,-1.681,-1.597,.225,-1.597,-1.132,.9053,-2.659,-1.03,.5766,-2.422,-0.9291,.3533,-2.184,-0.8831,.225,-2.076,0,.9053,-2.883,0,.5766,-2.625,0,.3533,-2.367,0,.225,-2.25,1.132,.9053,-2.659,1.03,.5766,-2.422,.9291,.3533,-2.184,.8831,.225,-2.076,2.047,.9053,-2.047,1.864,.5766,-1.864,1.681,.3533,-1.681,1.597,.225,-1.597,2.659,.9053,-1.132,2.422,.5766,-1.03,2.184,.3533,-0.9291,2.076,.225,-0.8831,2.199,.1424,0,1.927,.07031,0,1.253,.01934,0,0,0,0,2.029,.1424,.8631,1.777,.07031,.7562,1.156,.01934,.4919,1.561,.1424,1.561,1.368,.07031,1.368,.8899,.01934,.8899,.8631,.1424,2.029,.7562,.07031,1.777,.4919,.01934,1.156,0,.1424,2.199,0,.07031,1.927,0,.01934,1.253,-0.8631,.1424,2.029,-0.7562,.07031,1.777,-0.4919,.01934,1.156,-1.561,.1424,1.561,-1.368,.07031,1.368,-0.8899,.01934,.8899,-2.029,.1424,.8631,-1.777,.07031,.7562,-1.156,.01934,.4919,-2.199,.1424,0,-1.927,.07031,0,-1.253,.01934,0,-2.029,.1424,-0.8631,-1.777,.07031,-0.7562,-1.156,.01934,-0.4919,-1.561,.1424,-1.561,-1.368,.07031,-1.368,-0.8899,.01934,-0.8899,-0.8631,.1424,-2.029,-0.7562,.07031,-1.777,-0.4919,.01934,-1.156,0,.1424,-2.199,0,.07031,-1.927,0,.01934,-1.253,.8631,.1424,-2.029,.7562,.07031,-1.777,.4919,.01934,-1.156,1.561,.1424,-1.561,1.368,.07031,-1.368,.8899,.01934,-0.8899,2.029,.1424,-0.8631,1.777,.07031,-0.7562,1.156,.01934,-0.4919,-2.4,3.038,0,-3.101,3.032,0,-3.619,2.995,0,-3.94,2.895,0,-4.05,2.7,0,-2.377,3.09,.2531,-3.122,3.084,.2531,-3.669,3.041,.2531,-4.005,2.926,.2531,-4.12,2.7,.2531,-2.325,3.206,.3375,-3.168,3.198,.3375,-3.778,3.143,.3375,-4.15,2.993,.3375,-4.275,2.7,.3375,-2.273,3.322,.2531,-3.214,3.313,.2531,-3.888,3.244,.2531,-4.294,3.06,.2531,-4.43,2.7,.2531,-2.25,3.375,0,-3.234,3.364,0,-3.938,3.291,0,-4.359,3.09,0,-4.5,2.7,0,-2.273,3.322,-0.2531,-3.214,3.313,-0.2531,-3.888,3.244,-0.2531,-4.294,3.06,-0.2531,-4.43,2.7,-0.2531,-2.325,3.206,-0.3375,-3.168,3.198,-0.3375,-3.778,3.143,-0.3375,-4.15,2.993,-0.3375,-4.275,2.7,-0.3375,-2.377,3.09,-0.2531,-3.122,3.084,-0.2531,-3.669,3.041,-0.2531,-4.005,2.926,-0.2531,-4.12,2.7,-0.2531,-3.991,2.394,0,-3.806,2.025,0,-3.48,1.656,0,-3,1.35,0,-4.055,2.365,.2531,-3.852,1.98,.2531,-3.496,1.6,.2531,-2.977,1.28,.2531,-4.196,2.3,.3375,-3.952,1.881,.3375,-3.531,1.478,.3375,-2.925,1.125,.3375,-4.336,2.235,.2531,-4.051,1.782,.2531,-3.566,1.356,.2531,-2.873,.9703,.2531,-4.4,2.205,0,-4.097,1.737,0,-3.582,1.3,0,-2.85,.9,0,-4.336,2.235,-0.2531,-4.051,1.782,-0.2531,-3.566,1.356,-0.2531,-2.873,.9703,-0.2531,-4.196,2.3,-0.3375,-3.952,1.881,-0.3375,-3.531,1.478,-0.3375,-2.925,1.125,-0.3375,-4.055,2.365,-0.2531,-3.852,1.98,-0.2531,-3.496,1.6,-0.2531,-2.977,1.28,-0.2531,2.55,2.137,0,3.27,2.303,0,3.581,2.7,0,3.752,3.182,0,4.05,3.6,0,2.55,1.944,.5569,3.324,2.159,.5028,3.652,2.617,.3839,3.838,3.151,.265,4.191,3.6,.2109,2.55,1.519,.7425,3.445,1.844,.6704,3.806,2.433,.5119,4.027,3.085,.3533,4.5,3.6,.2813,2.55,1.093,.5569,3.566,1.529,.5028,3.961,2.249,.3839,4.215,3.018,.265,4.809,3.6,.2109,2.55,.9,0,3.621,1.385,0,4.031,2.166,0,4.301,2.988,0,4.95,3.6,0,2.55,1.093,-0.5569,3.566,1.529,-0.5028,3.961,2.249,-0.3839,4.215,3.018,-0.265,4.809,3.6,-0.2109,2.55,1.519,-0.7425,3.445,1.844,-0.6704,3.806,2.433,-0.5119,4.027,3.085,-0.3533,4.5,3.6,-0.2813,2.55,1.944,-0.5569,3.324,2.159,-0.5028,3.652,2.617,-0.3839,3.838,3.151,-0.265,4.191,3.6,-0.2109,4.158,3.663,0,4.238,3.684,0,4.261,3.663,0,4.2,3.6,0,4.308,3.666,.1978,4.379,3.689,.1687,4.381,3.668,.1397,4.294,3.6,.1266,4.64,3.673,.2637,4.69,3.7,.225,4.645,3.677,.1863,4.5,3.6,.1688,4.971,3.68,.1978,5.001,3.711,.1687,4.909,3.687,.1397,4.706,3.6,.1266,5.122,3.683,0,5.142,3.716,0,5.029,3.691,0,4.8,3.6,0,4.971,3.68,-0.1978,5.001,3.711,-0.1687,4.909,3.687,-0.1397,4.706,3.6,-0.1266,4.64,3.673,-0.2637,4.69,3.7,-0.225,4.645,3.677,-0.1863,4.5,3.6,-0.1688,4.308,3.666,-0.1978,4.379,3.689,-0.1687,4.381,3.668,-0.1397,4.294,3.6,-0.1266,0,4.725,0,.5109,4.651,0,.4875,4.472,0,.2953,4.25,0,.3,4.05,0,.4715,4.651,.2011,.4499,4.472,.1918,.2725,4.25,.1161,.2768,4.05,.1178,.3632,4.651,.3632,.3465,4.472,.3465,.2098,4.25,.2098,.213,4.05,.213,.2011,4.651,.4715,.1918,4.472,.4499,.1161,4.25,.2725,.1178,4.05,.2768,0,4.651,.5109,0,4.472,.4875,0,4.25,.2953,0,4.05,.3,-0.2011,4.651,.4715,-0.1918,4.472,.4499,-0.1161,4.25,.2725,-0.1178,4.05,.2768,-0.3632,4.651,.3632,-0.3465,4.472,.3465,-0.2098,4.25,.2098,-0.213,4.05,.213,-0.4715,4.651,.2011,-0.4499,4.472,.1918,-0.2725,4.25,.1161,-0.2768,4.05,.1178,-0.5109,4.651,0,-0.4875,4.472,0,-0.2953,4.25,0,-0.3,4.05,0,-0.4715,4.651,-0.2011,-0.4499,4.472,-0.1918,-0.2725,4.25,-0.1161,-0.2768,4.05,-0.1178,-0.3632,4.651,-0.3632,-0.3465,4.472,-0.3465,-0.2098,4.25,-0.2098,-0.213,4.05,-0.213,-0.2011,4.651,-0.4715,-0.1918,4.472,-0.4499,-0.1161,4.25,-0.2725,-0.1178,4.05,-0.2768,0,4.651,-0.5109,0,4.472,-0.4875,0,4.25,-0.2953,0,4.05,-0.3,.2011,4.651,-0.4715,.1918,4.472,-0.4499,.1161,4.25,-0.2725,.1178,4.05,-0.2768,.3632,4.651,-0.3632,.3465,4.472,-0.3465,.2098,4.25,-0.2098,.213,4.05,-0.213,.4715,4.651,-0.2011,.4499,4.472,-0.1918,.2725,4.25,-0.1161,.2768,4.05,-0.1178,.6844,3.916,0,1.237,3.825,0,1.734,3.734,0,1.95,3.6,0,.6313,3.916,.2686,1.142,3.825,.4857,1.6,3.734,.6807,1.799,3.6,.7654,.4859,3.916,.4859,.8786,3.825,.8786,1.231,3.734,1.231,1.385,3.6,1.385,.2686,3.916,.6313,.4857,3.825,1.142,.6807,3.734,1.6,.7654,3.6,1.799,0,3.916,.6844,0,3.825,1.237,0,3.734,1.734,0,3.6,1.95,-0.2686,3.916,.6313,-0.4857,3.825,1.142,-0.6807,3.734,1.6,-0.7654,3.6,1.799,-0.4859,3.916,.4859,-0.8786,3.825,.8786,-1.231,3.734,1.231,-1.385,3.6,1.385,-0.6313,3.916,.2686,-1.142,3.825,.4857,-1.6,3.734,.6807,-1.799,3.6,.7654,-0.6844,3.916,0,-1.237,3.825,0,-1.734,3.734,0,-1.95,3.6,0,-0.6313,3.916,-0.2686,-1.142,3.825,-0.4857,-1.6,3.734,-0.6807,-1.799,3.6,-0.7654,-0.4859,3.916,-0.4859,-0.8786,3.825,-0.8786,-1.231,3.734,-1.231,-1.385,3.6,-1.385,-0.2686,3.916,-0.6313,-0.4857,3.825,-1.142,-0.6807,3.734,-1.6,-0.7654,3.6,-1.799,0,3.916,-0.6844,0,3.825,-1.237,0,3.734,-1.734,0,3.6,-1.95,.2686,3.916,-0.6313,.4857,3.825,-1.142,.6807,3.734,-1.6,.7654,3.6,-1.799,.4859,3.916,-0.4859,.8786,3.825,-0.8786,1.231,3.734,-1.231,1.385,3.6,-1.385,.6313,3.916,-0.2686,1.142,3.825,-0.4857,1.6,3.734,-0.6807,1.799,3.6,-0.7654],b=[0,5,6,6,1,0,1,6,7,7,2,1,2,7,8,8,3,2,3,8,9,9,4,3,5,10,11,11,6,5,6,11,12,12,7,6,7,12,13,13,8,7,8,13,14,14,9,8,10,15,16,16,11,10,11,16,17,17,12,11,12,17,18,18,13,12,13,18,19,19,14,13,15,20,21,21,16,15,16,21,22,22,17,16,17,22,23,23,18,17,18,23,24,24,19,18,20,25,26,26,21,20,21,26,27,27,22,21,22,27,28,28,23,22,23,28,29,29,24,23,25,30,31,31,26,25,26,31,32,32,27,26,27,32,33,33,28,27,28,33,34,34,29,28,30,35,36,36,31,30,31,36,37,37,32,31,32,37,38,38,33,32,33,38,39,39,34,33,35,40,41,41,36,35,36,41,42,42,37,36,37,42,43,43,38,37,38,43,44,44,39,38,40,45,46,46,41,40,41,46,47,47,42,41,42,47,48,48,43,42,43,48,49,49,44,43,45,50,51,51,46,45,46,51,52,52,47,46,47,52,53,53,48,47,48,53,54,54,49,48,50,55,56,56,51,50,51,56,57,57,52,51,52,57,58,58,53,52,53,58,59,59,54,53,55,60,61,61,56,55,56,61,62,62,57,56,57,62,63,63,58,57,58,63,64,64,59,58,60,65,66,66,61,60,61,66,67,67,62,61,62,67,68,68,63,62,63,68,69,69,64,63,65,70,71,71,66,65,66,71,72,72,67,66,67,72,73,73,68,67,68,73,74,74,69,68,70,75,76,76,71,70,71,76,77,77,72,71,72,77,78,78,73,72,73,78,79,79,74,73,75,0,1,1,76,75,76,1,2,2,77,76,77,2,3,3,78,77,78,3,4,4,79,78,4,9,84,84,80,4,80,84,85,85,81,80,81,85,86,86,82,81,82,86,87,87,83,82,9,14,88,88,84,9,84,88,89,89,85,84,85,89,90,90,86,85,86,90,91,91,87,86,14,19,92,92,88,14,88,92,93,93,89,88,89,93,94,94,90,89,90,94,95,95,91,90,19,24,96,96,92,19,92,96,97,97,93,92,93,97,98,98,94,93,94,98,99,99,95,94,24,29,100,100,96,24,96,100,101,101,97,96,97,101,102,102,98,97,98,102,103,103,99,98,29,34,104,104,100,29,100,104,105,105,101,100,101,105,106,106,102,101,102,106,107,107,103,102,34,39,108,108,104,34,104,108,109,109,105,104,105,109,110,110,106,105,106,110,111,111,107,106,39,44,112,112,108,39,108,112,113,113,109,108,109,113,114,114,110,109,110,114,115,115,111,110,44,49,116,116,112,44,112,116,117,117,113,112,113,117,118,118,114,113,114,118,119,119,115,114,49,54,120,120,116,49,116,120,121,121,117,116,117,121,122,122,118,117,118,122,123,123,119,118,54,59,124,124,120,54,120,124,125,125,121,120,121,125,126,126,122,121,122,126,127,127,123,122,59,64,128,128,124,59,124,128,129,129,125,124,125,129,130,130,126,125,126,130,131,131,127,126,64,69,132,132,128,64,128,132,133,133,129,128,129,133,134,134,130,129,130,134,135,135,131,130,69,74,136,136,132,69,132,136,137,137,133,132,133,137,138,138,134,133,134,138,139,139,135,134,74,79,140,140,136,74,136,140,141,141,137,136,137,141,142,142,138,137,138,142,143,143,139,138,79,4,80,80,140,79,140,80,81,81,141,140,141,81,82,82,142,141,142,82,83,83,143,142,83,87,148,148,144,83,144,148,149,149,145,144,145,149,150,150,146,145,146,150,151,151,147,146,87,91,152,152,148,87,148,152,153,153,149,148,149,153,154,154,150,149,150,154,155,155,151,150,91,95,156,156,152,91,152,156,157,157,153,152,153,157,158,158,154,153,154,158,159,159,155,154,95,99,160,160,156,95,156,160,161,161,157,156,157,161,162,162,158,157,158,162,163,163,159,158,99,103,164,164,160,99,160,164,165,165,161,160,161,165,166,166,162,161,162,166,167,167,163,162,103,107,168,168,164,103,164,168,169,169,165,164,165,169,170,170,166,165,166,170,171,171,167,166,107,111,172,172,168,107,168,172,173,173,169,168,169,173,174,174,170,169,170,174,175,175,171,170,111,115,176,176,172,111,172,176,177,177,173,172,173,177,178,178,174,173,174,178,179,179,175,174,115,119,180,180,176,115,176,180,181,181,177,176,177,181,182,182,178,177,178,182,183,183,179,178,119,123,184,184,180,119,180,184,185,185,181,180,181,185,186,186,182,181,182,186,187,187,183,182,123,127,188,188,184,123,184,188,189,189,185,184,185,189,190,190,186,185,186,190,191,191,187,186,127,131,192,192,188,127,188,192,193,193,189,188,189,193,194,194,190,189,190,194,195,195,191,190,131,135,196,196,192,131,192,196,197,197,193,192,193,197,198,198,194,193,194,198,199,199,195,194,135,139,200,200,196,135,196,200,201,201,197,196,197,201,202,202,198,197,198,202,203,203,199,198,139,143,204,204,200,139,200,204,205,205,201,200,201,205,206,206,202,201,202,206,207,207,203,202,143,83,144,144,204,143,204,144,145,145,205,204,205,145,146,146,206,205
,206,146,147,147,207,206,147,151,212,212,208,147,208,212,213,213,209,208,209,213,214,214,210,209,210,214,211,211,211,210,151,155,215,215,212,151,212,215,216,216,213,212,213,216,217,217,214,213,214,217,211,211,211,214,155,159,218,218,215,155,215,218,219,219,216,215,216,219,220,220,217,216,217,220,211,211,211,217,159,163,221,221,218,159,218,221,222,222,219,218,219,222,223,223,220,219,220,223,211,211,211,220,163,167,224,224,221,163,221,224,225,225,222,221,222,225,226,226,223,222,223,226,211,211,211,223,167,171,227,227,224,167,224,227,228,228,225,224,225,228,229,229,226,225,226,229,211,211,211,226,171,175,230,230,227,171,227,230,231,231,228,227,228,231,232,232,229,228,229,232,211,211,211,229,175,179,233,233,230,175,230,233,234,234,231,230,231,234,235,235,232,231,232,235,211,211,211,232,179,183,236,236,233,179,233,236,237,237,234,233,234,237,238,238,235,234,235,238,211,211,211,235,183,187,239,239,236,183,236,239,240,240,237,236,237,240,241,241,238,237,238,241,211,211,211,238,187,191,242,242,239,187,239,242,243,243,240,239,240,243,244,244,241,240,241,244,211,211,211,241,191,195,245,245,242,191,242,245,246,246,243,242,243,246,247,247,244,243,244,247,211,211,211,244,195,199,248,248,245,195,245,248,249,249,246,245,246,249,250,250,247,246,247,250,211,211,211,247,199,203,251,251,248,199,248,251,252,252,249,248,249,252,253,253,250,249,250,253,211,211,211,250,203,207,254,254,251,203,251,254,255,255,252,251,252,255,256,256,253,252,253,256,211,211,211,253,207,147,208,208,254,207,254,208,209,209,255,254,255,209,210,210,256,255,256,210,211,211,211,256,257,262,263,263,258,257,258,263,264,264,259,258,259,264,265,265,260,259,260,265,266,266,261,260,262,267,268,268,263,262,263,268,269,269,264,263,264,269,270,270,265,264,265,270,271,271,266,265,267,272,273,273,268,267,268,273,274,274,269,268,269,274,275,275,270,269,270,275,276,276,271,270,272,277,278,278,273,272,273,278,279,279,274,273,274,279,280,280,275,274,275,280,281,281,276,275,277,282,283,283,278,277,278,283,284,284,279,278,279,284,285,285,280,279,280,285,286,286,281,280,282,287,288,288,283,282,283,288,289,289,284,283,284,289,290,290,285,284,285,290,291,291,286,285,287,292,293,293,288,287,288,293,294,294,289,288,289,294,295,295,290,289,290,295,296,296,291,290,292,257,258,258,293,292,293,258,259,259,294,293,294,259,260,260,295,294,295,260,261,261,296,295,261,266,301,301,297,261,297,301,302,302,298,297,298,302,303,303,299,298,299,303,304,304,300,299,266,271,305,305,301,266,301,305,306,306,302,301,302,306,307,307,303,302,303,307,308,308,304,303,271,276,309,309,305,271,305,309,310,310,306,305,306,310,311,311,307,306,307,311,312,312,308,307,276,281,313,313,309,276,309,313,314,314,310,309,310,314,315,315,311,310,311,315,316,316,312,311,281,286,317,317,313,281,313,317,318,318,314,313,314,318,319,319,315,314,315,319,320,320,316,315,286,291,321,321,317,286,317,321,322,322,318,317,318,322,323,323,319,318,319,323,324,324,320,319,291,296,325,325,321,291,321,325,326,326,322,321,322,326,327,327,323,322,323,327,328,328,324,323,296,261,297,297,325,296,325,297,298,298,326,325,326,298,299,299,327,326,327,299,300,300,328,327,329,334,335,335,330,329,330,335,336,336,331,330,331,336,337,337,332,331,332,337,338,338,333,332,334,339,340,340,335,334,335,340,341,341,336,335,336,341,342,342,337,336,337,342,343,343,338,337,339,344,345,345,340,339,340,345,346,346,341,340,341,346,347,347,342,341,342,347,348,348,343,342,344,349,350,350,345,344,345,350,351,351,346,345,346,351,352,352,347,346,347,352,353,353,348,347,349,354,355,355,350,349,350,355,356,356,351,350,351,356,357,357,352,351,352,357,358,358,353,352,354,359,360,360,355,354,355,360,361,361,356,355,356,361,362,362,357,356,357,362,363,363,358,357,359,364,365,365,360,359,360,365,366,366,361,360,361,366,367,367,362,361,362,367,368,368,363,362,364,329,330,330,365,364,365,330,331,331,366,365,366,331,332,332,367,366,367,332,333,333,368,367,333,338,373,373,369,333,369,373,374,374,370,369,370,374,375,375,371,370,371,375,376,376,372,371,338,343,377,377,373,338,373,377,378,378,374,373,374,378,379,379,375,374,375,379,380,380,376,375,343,348,381,381,377,343,377,381,382,382,378,377,378,382,383,383,379,378,379,383,384,384,380,379,348,353,385,385,381,348,381,385,386,386,382,381,382,386,387,387,383,382,383,387,388,388,384,383,353,358,389,389,385,353,385,389,390,390,386,385,386,390,391,391,387,386,387,391,392,392,388,387,358,363,393,393,389,358,389,393,394,394,390,389,390,394,395,395,391,390,391,395,396,396,392,391,363,368,397,397,393,363,393,397,398,398,394,393,394,398,399,399,395,394,395,399,400,400,396,395,368,333,369,369,397,368,397,369,370,370,398,397,398,370,371,371,399,398,399,371,372,372,400,399,401,401,406,406,402,401,402,406,407,407,403,402,403,407,408,408,404,403,404,408,409,409,405,404,401,401,410,410,406,401,406,410,411,411,407,406,407,411,412,412,408,407,408,412,413,413,409,408,401,401,414,414,410,401,410,414,415,415,411,410,411,415,416,416,412,411,412,416,417,417,413,412,401,401,418,418,414,401,414,418,419,419,415,414,415,419,420,420,416,415,416,420,421,421,417,416,401,401,422,422,418,401,418,422,423,423,419,418,419,423,424,424,420,419,420,424,425,425,421,420,401,401,426,426,422,401,422,426,427,427,423,422,423,427,428,428,424,423,424,428,429,429,425,424,401,401,430,430,426,401,426,430,431,431,427,426,427,431,432,432,428,427,428,432,433,433,429,428,401,401,434,434,430,401,430,434,435,435,431,430,431,435,436,436,432,431,432,436,437,437,433,432,401,401,438,438,434,401,434,438,439,439,435,434,435,439,440,440,436,435,436,440,441,441,437,436,401,401,442,442,438,401,438,442,443,443,439,438,439,443,444,444,440,439,440,444,445,445,441,440,401,401,446,446,442,401,442,446,447,447,443,442,443,447,448,448,444,443,444,448,449,449,445,444,401,401,450,450,446,401,446,450,451,451,447,446,447,451,452,452,448,447,448,452,453,453,449,448,401,401,454,454,450,401,450,454,455,455,451,450,451,455,456,456,452,451,452,456,457,457,453,452,401,401,458,458,454,401,454,458,459,459,455,454,455,459,460,460,456,455,456,460,461,461,457,456,401,401,462,462,458,401,458,462,463,463,459,458,459,463,464,464,460,459,460,464,465,465,461,460,401,401,402,402,462,401,462,402,403,403,463,462,463,403,404,404,464,463,464,404,405,405,465,464,405,409,470,470,466,405,466,470,471,471,467,466,467,471,472,472,468,467,468,472,473,473,469,468,409,413,474,474,470,409,470,474,475,475,471,470,471,475,476,476,472,471,472,476,477,477,473,472,413,417,478,478,474,413,474,478,479,479,475,474,475,479,480,480,476,475,476,480,481,481,477,476,417,421,482,482,478,417,478,482,483,483,479,478,479,483,484,484,480,479,480,484,485,485,481,480,421,425,486,486,482,421,482,486,487,487,483,482,483,487,488,488,484,483,484,488,489,489,485,484,425,429,490,490,486,425,486,490,491,491,487,486,487,491,492,492,488,487,488,492,493,493,489,488,429,433,494,494,490,429,490,494,495,495,491,490,491,495,496,496,492,491,492,496,497,497,493,492,433,437,498,498,494,433,494,498,499,499,495,494,495,499,500,500,496,495,496,500,501,501,497,496,437,441,502,502,498,437,498,502,503,503,499,498,499,503,504,504,500,499,500,504,505,505,501,500,441,445,506,506,502,441,502,506,507,507,503,502,503,507,508,508,504,503,504,508,509,509,505,504,445,449,510,510,506,445,506,510,511,511,507,506,507,511,512,512,508,507,508,512,513,513,509,508,449,453,514,514,510,449,510,514,515,515,511,510,511,515,516,516,512,511,512,516,517,517,513,512,453,457,518,518,514,453,514,518,519,519,515,514,515,519,520,520,516,515,516,520,521,521,517,516,457,461,522,522,518,457,518,522,523,523,519,518,519,523,524,524,520,519,520,524,525,525,521,520,461,465,526,526,522,461,522,526,527,527,523,522,523,527,528,528,524,523,524,528,529,529,525,524,465,405,466,466,526,465,526,466,467,467,527,526,527,467,468,468,528,527,528,468,469,469,529,528],c=b,d=a,e=Facet.Mesh.indexed(d,c);e.make_normals();return e.model},Facet.Mesh={},Facet.Mesh.indexed=function(a,b){function e(){var c=new Float32Array(a.length),d=new Float32Array(a.length/3);for(var e=0;e<b.length;e+=3){var f=b[e],g=b[e+1],h=b[e+2],i=vec3.copy(a.slice(3*f,3*f+3)),j=vec3.copy(a.slice(3*g,3*g+3)),k=vec3.copy(a.slice(3*h,3*h+3)),l=vec3.cross(vec3.minus(j,i),vec3.minus(k,i)),m=vec3.length(l);d[f]+=m,d[g]+=m,d[h]+=m,c[3*f]+=l[0],c[3*f+1]+=l[1],c[3*f+2]+=l[2],c[3*g]+=l[0],c[3*h+1]+=l[1],c[3*f+2]+=l[2],c[3*f]+=l[0],c[3*g+1]+=l[1],c[3*h+2]+=l[2]}for(e=0;e<d.length;++e)c[3*e]/=d[e],c[3*e+1]/=d[e],c[3*e+2]/=d[e];return c}a=a.slice(),b=b.slice();var c=Facet.model({type:"triangles",elements:b,vertex:[a,3]}),d;return{model:c,make_normals:function(){d||(d=e(),this.model.add("normal",[d,3]));return d}}},Facet.Scene={},Facet.Scene.add=function(a){var b=Facet._globals.ctx._facet_globals.scene;b.push(a),Facet.Scene.invalidate()},Facet.Scene.remove=function(a){var b=Facet._globals.ctx._facet_globals.scene,c=b.indexOf(a);return c===-1?undefined:b.splice(c,1)[0]},Facet.Scene.render=function(){var a=Facet._globals.ctx._facet_globals.scene;for(var b=0;b<a.length;++b)a[b].draw()},Facet.Scene.invalidate=function(){if(!Facet._globals.ctx._facet_globals.dirty){Facet._globals.ctx._facet_globals.dirty=!0;var a=Facet._globals.ctx;function b(){Facet.set_context(a),a.display(),a._facet_globals.dirty=!1}window.requestAnimFrame(b,a)}}